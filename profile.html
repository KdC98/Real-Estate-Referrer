<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Real Estate Referrer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen">
    
    <!-- Banni√®re Profil Incomplet -->
    <div id="incompleteProfileBanner" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 text-slate-900 py-4 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-center">
            <svg class="w-6 h-6 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <span class="font-bold text-center" data-i18n="profile.incomplete_banner">
                ‚ö†Ô∏è Veuillez compl√©ter votre profil pour pouvoir soumettre des leads et recevoir vos commissions
            </span>
        </div>
    </div>

    <!-- Header -->
    <nav class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-white text-xl font-bold">Real Estate Referrer</a>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- S√©lecteur de langue -->
                    <select id="languageSelector" class="bg-white/10 text-white px-3 py-2 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="ar">üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                        <option value="ur">üáµüá∞ ÿßÿ±ÿØŸà</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="tl">üáµüá≠ Tagalog</option>
                    </select>
                    <button id="backToDashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition duration-300" data-i18n="header.back_dashboard">Retour au dashboard</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Titre -->
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4" data-i18n="profile.title">
                Mon Profil
            </h1>
            <p class="text-blue-200" data-i18n="profile.subtitle">
                G√©rez vos informations personnelles
            </p>
        </div>

        <!-- Message obligatoire -->
        <div id="requiredFieldsInfo" class="hidden mb-6 p-4 rounded-xl bg-blue-500/20 text-blue-200 text-center">
            <span data-i18n="profile.required_fields_info">
                Les champs marqu√©s d'un * sont obligatoires pour recevoir vos commissions
            </span>
        </div>

        <!-- Message de succ√®s/erreur -->
        <div id="messageContainer" class="hidden mb-6 p-4 rounded-xl text-center"></div>

        <!-- Formulaire -->
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 border border-white/20">
            <form id="profileForm" class="space-y-6">
                
                <!-- Nom -->
                <div>
                    <label for="name" class="block text-white font-semibold mb-2">
                        <span data-i18n="profile.name">Nom complet</span>
                        <span class="text-yellow-400 ml-1">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name"
                        required
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Votre nom"
                        data-i18n-placeholder="profile.name_placeholder"
                    >
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-white font-semibold mb-2" data-i18n="profile.email">
                        Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        readonly
                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white/70 cursor-not-allowed"
                        placeholder="votre@email.com"
                    >
                    <p class="text-blue-300 text-sm mt-2" data-i18n="profile.email_readonly">
                        ‚ÑπÔ∏è L'email ne peut pas √™tre modifi√©
                    </p>
                </div>

                <!-- T√©l√©phone -->
                <div>
                    <label for="phone" class="block text-white font-semibold mb-2">
                        <span data-i18n="profile.phone">T√©l√©phone</span>
                        <span class="text-yellow-400 ml-1">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone"
                        required
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="+971 50 123 4567"
                        data-i18n-placeholder="profile.phone_placeholder"
                    >
                </div>

                <!-- Adresse -->
                <div>
                    <label for="address" class="block text-white font-semibold mb-2">
                        <span data-i18n="profile.address">Adresse</span>
                        <span class="text-yellow-400 ml-1">*</span>
                    </label>
                    <textarea 
                        id="address" 
                        name="address"
                        rows="2"
                        required
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Votre adresse compl√®te"
                        data-i18n-placeholder="profile.address_placeholder"
                    ></textarea>
                    <p class="text-blue-300 text-sm mt-2" data-i18n="profile.address_info">
                        ‚ÑπÔ∏è Obligatoire pour le versement de vos commissions
                    </p>
                </div>

                <!-- Langue pr√©f√©r√©e -->
                <div>
                    <label for="preferredLanguage" class="block text-white font-semibold mb-2" data-i18n="profile.preferred_language">
                        Langue pr√©f√©r√©e pour les emails
                    </label>
                    <select 
                        id="preferredLanguage" 
                        name="preferred_language"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="ar">üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                        <option value="ur">üáµüá∞ ÿßÿ±ÿØŸà</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="tl">üáµüá≠ Tagalog</option>
                    </select>
                </div>

                <!-- Bouton sauvegarder -->
                <div class="pt-4">
                    <button 
                        type="submit" 
                        id="saveButton"
                        class="w-full bg-gradient-to-r from-yellow-500 to-yellow-400 text-slate-900 font-bold py-4 px-6 rounded-xl hover:from-yellow-400 hover:to-yellow-300 transition duration-300 flex items-center justify-center"
                    >
                        <span id="saveButtonText" data-i18n="profile.save_button">Sauvegarder</span>
                        <svg id="saveSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-slate-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

            </form>
        </div>

        <!-- Section notifications -->
        <div class="mt-8 bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-white/10">
            <h3 class="text-white font-semibold mb-4" data-i18n="profile.notifications_title">
                Notifications par email
            </h3>
            <label class="flex items-center cursor-pointer">
                <input 
                    type="checkbox" 
                    id="emailSubscribed" 
                    class="w-5 h-5 rounded bg-white/10 border-white/20 text-blue-500 focus:ring-blue-500 focus:ring-offset-0"
                    checked
                >
                <span class="ml-3 text-blue-200" data-i18n="profile.receive_emails">
                    Recevoir les emails de suivi et notifications
                </span>
            </label>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 border-t border-white/10 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-blue-300">
                ¬© 2025 Real Estate Referrer Dubai. <span data-i18n="footer.rights">Tous droits r√©serv√©s.</span>
            </p>
            <div class="mt-4 space-x-4">
                <a href="index.html" class="text-blue-400 hover:text-blue-300" data-i18n="footer.home">Accueil</a>
                <a href="how-it-works.html" class="text-blue-400 hover:text-blue-300" data-i18n="footer.how_it_works">Comment √ßa marche</a>
            </div>
        </div>
    </footer>

    <script>
        // ‚úÖ CL√âS API EN DUR (copie depuis ton config.js)
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'COLLE_TA_CLE_ANON_ICI'; // ‚Üê Remplace par ta vraie cl√© depuis config.js
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentProfile = null;
        let isProfileComplete = false;

        // V√©rifier si le profil est complet
        function checkProfileComplete(profile) {
            const name = profile?.name?.trim();
            const phone = profile?.phone?.trim();
            const address = profile?.address?.trim();
            
            return !!(name && phone && address);
        }

        // Mettre √† jour l'affichage selon l'√©tat du profil
        function updateProfileUI() {
            const banner = document.getElementById('incompleteProfileBanner');
            const requiredInfo = document.getElementById('requiredFieldsInfo');
            const backButton = document.getElementById('backToDashboard');
            
            if (isProfileComplete) {
                banner.classList.add('hidden');
                requiredInfo.classList.add('hidden');
                backButton.classList.remove('opacity-50', 'cursor-not-allowed');
                backButton.classList.add('hover:bg-blue-700');
            } else {
                banner.classList.remove('hidden');
                requiredInfo.classList.remove('hidden');
                backButton.classList.add('opacity-50', 'cursor-not-allowed');
                backButton.classList.remove('hover:bg-blue-700');
            }
        }

        // V√©rifier l'authentification au chargement
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            await loadProfile();
        }

        // Charger le profil
        async function loadProfile() {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Error loading profile:', error);
                    showMessage(i18next.t('profile.load_error') || 'Erreur lors du chargement du profil', 'error');
                    return;
                }
                
                currentProfile = profile;
                isProfileComplete = checkProfileComplete(profile);
                
                // Remplir le formulaire
                document.getElementById('name').value = profile.name || '';
                document.getElementById('email').value = currentUser.email || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('address').value = profile.address || '';
                document.getElementById('preferredLanguage').value = profile.preferred_language || 'fr';
                document.getElementById('emailSubscribed').checked = !profile.email_unsubscribed;
                
                // Mettre √† jour l'UI
                updateProfileUI();
                
            } catch (err) {
                console.error('Error:', err);
                showMessage('Erreur de connexion', 'error');
            }
        }

        // G√©rer le bouton retour au dashboard
        document.getElementById('backToDashboard').addEventListener('click', function(e) {
            e.preventDefault();
            
            // V√©rifier √† nouveau avec les valeurs actuelles du formulaire
            const currentName = document.getElementById('name').value.trim();
            const currentPhone = document.getElementById('phone').value.trim();
            const currentAddress = document.getElementById('address').value.trim();
            
            if (!currentName || !currentPhone || !currentAddress) {
                showMessage(i18next.t('profile.complete_before_leaving') || '‚ö†Ô∏è Veuillez compl√©ter tous les champs obligatoires (*) avant de continuer', 'error');
                
                // Highlight les champs vides
                if (!currentName) document.getElementById('name').classList.add('ring-2', 'ring-red-500');
                if (!currentPhone) document.getElementById('phone').classList.add('ring-2', 'ring-red-500');
                if (!currentAddress) document.getElementById('address').classList.add('ring-2', 'ring-red-500');
                
                return;
            }
            
            window.location.href = 'index.html';
        });

        // Retirer le highlight rouge quand on tape
        ['name', 'phone', 'address'].forEach(function(fieldId) {
            document.getElementById(fieldId).addEventListener('input', function() {
                this.classList.remove('ring-2', 'ring-red-500');
            });
        });

        // Sauvegarder le profil
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            const saveSpinner = document.getElementById('saveSpinner');
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const preferredLanguage = document.getElementById('preferredLanguage').value;
            const emailSubscribed = document.getElementById('emailSubscribed').checked;
            
            // Validation des champs obligatoires
            if (!name || !phone || !address) {
                showMessage(i18next.t('profile.fill_required') || 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            // Afficher le spinner
            saveButton.disabled = true;
            saveButtonText.textContent = i18next.t('profile.saving') || 'Sauvegarde...';
            saveSpinner.classList.remove('hidden');
            
            try {
                // Mettre √† jour le profil
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        name: name,
                        phone: phone,
                        address: address,
                        preferred_language: preferredLanguage,
                        email_unsubscribed: !emailSubscribed
                    })
                    .eq('id', currentUser.id);
                
                if (profileError) {
                    throw profileError;
                }
                
                // Mettre √† jour l'√©tat
                isProfileComplete = true;
                updateProfileUI();
                
                showMessage(i18next.t('profile.save_success') || '‚úÖ Profil mis √† jour avec succ√®s !', 'success');
                
                // Mettre √† jour la langue du site si chang√©e
                if (preferredLanguage !== i18next.language) {
                    await i18next.changeLanguage(preferredLanguage);
                    localStorage.setItem('i18nextLng', preferredLanguage);
                    document.getElementById('languageSelector').value = preferredLanguage;
                    updateContent();
                }
                
            } catch (error) {
                console.error('Error saving profile:', error);
                showMessage(error.message || 'Erreur lors de la sauvegarde', 'error');
            } finally {
                saveButton.disabled = false;
                saveButtonText.textContent = i18next.t('profile.save_button') || 'Sauvegarder';
                saveSpinner.classList.add('hidden');
            }
        });

        // Afficher un message
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.classList.remove('hidden', 'bg-green-500/20', 'bg-red-500/20', 'bg-yellow-500/20', 'text-green-400', 'text-red-400', 'text-yellow-400');
            
            if (type === 'success') {
                container.classList.add('bg-green-500/20', 'text-green-400');
            } else if (type === 'error') {
                container.classList.add('bg-red-500/20', 'text-red-400');
            } else if (type === 'warning') {
                container.classList.add('bg-yellow-500/20', 'text-yellow-400');
            }
            
            container.textContent = text;
            
            setTimeout(function() {
                container.classList.add('hidden');
            }, 5000);
        }

        // Fonction pour mettre √† jour le contenu i18n
        function updateContent() {
            document.documentElement.lang = i18next.language;
            
            document.querySelectorAll('[data-i18n]').forEach(function(element) {
                const key = element.getAttribute('data-i18n');
                const translation = i18next.t(key);
                
                if (translation && translation !== key) {
                    element.textContent = translation;
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(element) {
                const key = element.getAttribute('data-i18n-placeholder');
                const translation = i18next.t(key);
                
                if (translation && translation !== key) {
                    element.placeholder = translation;
                }
            });
        }

        // ‚úÖ INITIALISATION
        async function init() {
            try {
                await i18next
                    .use(i18nextHttpBackend)
                    .use(i18nextBrowserLanguageDetector)
                    .init({
                        fallbackLng: 'fr',
                        debug: false,
                        load: 'languageOnly',
                        ns: ['profile', 'common'],
                        defaultNS: 'profile',
                        backend: {
                            loadPath: '/locales/{{lng}}/{{ns}}.json'
                        },
                        detection: {
                            order: ['localStorage', 'navigator'],
                            caches: ['localStorage']
                        }
                    });
                
                const savedLang = localStorage.getItem('i18nextLng') || 'fr';
                document.getElementById('languageSelector').value = savedLang;
                
                updateContent();
                await checkAuth();
                
            } catch (err) {
                console.error('Init error:', err);
                await checkAuth();
            }
        }

        // Changement de langue
        document.getElementById('languageSelector').addEventListener('change', async function(e) {
            await i18next.changeLanguage(e.target.value);
            localStorage.setItem('i18nextLng', e.target.value);
            updateContent();
        });

        // Lancer l'initialisation
        init();
    </script>
    
    <!-- Crisp Chat -->
    <script src="/js/crisp-chat.js"></script>
</body>
</html>
