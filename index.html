<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    (async () => {
        await i18next
            .use(i18nextHttpBackend)
            .use(i18nextBrowserLanguageDetector)
            .init({
                fallbackLng: 'fr',
                debug: true,
                load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'],
                defaultNS: 'translation',
                backend: {
                    loadPath: '/locales/{{lng}}/{{ns}}.json'
                },
                detection: {
                    order: ['localStorage', 'navigator'],
                    caches: ['localStorage']
                }
            });
        console.log('üåê Loading translations...');
        await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
        console.log('‚úÖ All translations loaded!');
        const t = (key) => i18next.t(key);
        async function changeLanguage(langCode) {
            try {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            } catch (error) {
                console.error('Erreur changement de langue:', error);
            }
        }
        window.changeLanguage = changeLanguage;
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
        let currentUser = null;
        let userProfile = null;
        let currentPage = 'landing';
        let isPasswordRecoveryMode = false;
        let is2FAMode = false;
        let isSignupInProgress = false;
        let tempUserId = null;
        let tempUserProfile = null;
        let globalIsUploading = false;
        window.currentUser = null;
        window.userProfile = null;
        window.currentPage = 'landing';
        function renderLandingPage() {
            return `
                <div class="min-h-screen">
                    <header class="container mx-auto px-4 py-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-yellow-400">${t('nav.brand')}</h1>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                                    <button onclick="changeLanguage('fr')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Fran√ßais">üá´üá∑</button>
                                    <button onclick="changeLanguage('en')" class="text-2xl hover:scale-125 transition-transform duration-200" title="English">üá¨üáß</button>
                                    <button onclick="changeLanguage('ar')" class="text-2xl hover:scale-125 transition-transform duration-200" title="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">üá¶üá™</button>
                                    <button onclick="changeLanguage('ru')" class="text-2xl hover:scale-125 transition-transform duration-200" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</button>
                                    <button onclick="changeLanguage('hi')" class="text-2xl hover:scale-125 transition-transform duration-200" title="‡§π‡§ø‡§®‡•ç‡§¶‡•Ä">üáÆüá≥</button>
                                    <button onclick="changeLanguage('ur')" class="text-2xl hover:scale-125 transition-transform duration-200" title="ÿßÿ±ÿØŸà">üáµüá∞</button>
                                    <button onclick="changeLanguage('zh')" class="text-2xl hover:scale-125 transition-transform duration-200" title="‰∏≠Êñá">üá®üá≥</button>
                                    <button onclick="changeLanguage('tl')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Tagalog">üáµüá≠</button>
                                </div>
                                <a href="how-it-works.html" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.how_it_works')}</a>
                                <button onclick="showLogin()" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.login')}</button>
                                <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition">${t('nav.signup')}</button>
                            </div>
                        </div>
                    </header>
                    <main class="container mx-auto px-4 py-20">
                        <div class="text-center mb-12">
                            <h2 class="text-5xl md:text-6xl font-bold mb-6">
                                ${t('hero.title')}
                            </h2>
                            <p class="text-xl text-gray-300 mb-8">
                                ${t('hero.subtitle')}
                            </p>
                            <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-8 py-4 rounded-lg transition transform hover:scale-105">
                                ${t('hero.cta_button')}
                            </button>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6 my-16">
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800&q=80" alt="Burj Khalifa Dubai" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1582672060674-bc2bd808a8b5?w=800&q=80" alt="Dubai Marina" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1518684079-3c830dcef090?w=800&q=80" alt="Dubai Skyline" class="w-full h-64 object-cover">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-8 mt-20">
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.commission_value')}</div>
                                <div class="text-gray-300">${t('stats.commission_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.support_value')}</div>
                                <div class="text-gray-300">${t('stats.support_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.timeline_value')}</div>
                                <div class="text-gray-300">${t('stats.timeline_label')}</div>
                            </div>
                        </div>
                        <div class="mt-20 bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-12">
                            <h3 class="text-3xl font-bold text-center mb-12">${t('gains.title')}</h3>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.sale_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.rental_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <footer class="bg-gray-900 bg-opacity-80 backdrop-blur-md mt-20">
                        <div class="container mx-auto px-4 py-12">
                            <div class="grid md:grid-cols-3 gap-8 mb-8">
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.navigation_title')}</h3>
                                    <ul class="space-y-2">
                                        <li><button onclick="backToHome()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.home')}</button></li>
                                        <li><a href="how-it-works.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.how_it_works')}</a></li>
                                        <li><button onclick="showLogin()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.login')}</button></li>
                                        <li><button onclick="showSignup()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.signup')}</button></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.legal_title')}</h3>
                                    <ul class="space-y-2">
                                        <li><a href="terms.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.terms')}</a></li>
                                        <li><a href="privacy.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.privacy')}</a></li>
                                        <li><button onclick="downloadContractTemplate()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.contract_template')}</button></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.contact_title')}</h3>
                                    <ul class="space-y-3 text-gray-300">
                                        <li class="flex items-center gap-2">
                                            <span>üìß</span>
                                            <a href="mailto:contact@real-estate-referrer.com" class="hover:text-yellow-400 transition">${t('common:footer.email')}</a>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span>üì±</span>
                                            <span>${t('common:footer.phone')}</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span>${t('common:footer.location')}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-700 pt-6 text-center text-gray-400">
                                ${t('common:footer.copyright')}
                            </div>
                        </div>
                    </footer>
                </div>
            `;
        }
        function renderAuthPage(mode) {
            let title, buttonText, linkText, linkAction;
            if (is2FAMode) {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 w-full max-w-md border border-white/20">
                            <h2 class="text-3xl font-bold mb-6 text-center">${t('auth:two_factor.title')}</h2>
                            <p class="text-center mb-6 text-gray-300">${t('auth:two_factor.description')}</p>
                            
                            <form onsubmit="handle2FASubmit(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">${t('auth:two_factor.code_label')}</label>
                                    <input 
                                        type="text" 
                                        id="code2fa"
                                        maxlength="6"
                                        pattern="[0-9]{6}"
                                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg focus:outline-none focus:border-yellow-400 text-white text-center text-2xl tracking-widest"
                                        placeholder="000000"
                                        required
                                    />
                                </div>
                                
                                <button type="submit" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold py-3 rounded-lg hover:from-yellow-500 hover:to-yellow-700 transition">
                                    ${t('auth:two_factor.verify_button')}
                                </button>
                                
                                <button type="button" onclick="resend2FACode()" class="w-full text-yellow-400 hover:text-yellow-300 transition py-2">
                                    ${t('auth:two_factor.resend_button')}
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            }
            
            if (mode === 'login') {
                title = t('auth:login_title');
                buttonText = t('auth:login_button');
                linkText = t('auth:no_account');
                linkAction = 'showSignup()';
            } else if (mode === 'signup') {
                title = t('auth:signup_title');
                buttonText = t('auth:signup_button');
                linkText = t('auth:have_account');
                linkAction = 'showLogin()';
            } else if (mode === 'reset') {
                title = t('auth:reset_title');
                buttonText = t('auth:reset_button');
                linkText = t('auth:back_to_login');
                linkAction = 'showLogin()';
            } else if (mode === 'change-password') {
                title = 'Nouveau mot de passe';
                buttonText = 'Changer le mot de passe';
                linkText = 'Retour √† la connexion';
                linkAction = 'showLogin()';
            }
            return `
                <div class="min-h-screen flex items-center justify-center px-4">
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 w-full max-w-md">
                        <button onclick="backToHome()" class="text-gray-400 hover:text-white mb-6 flex items-center">
                            ‚Üê ${t('auth:back_home')}
                        </button>
                        
                        <h2 class="text-3xl font-bold mb-6 text-center">${title}</h2>
                        ${mode === 'login' || mode === 'signup' ? `
                            <!-- OAuth Buttons Vercel Style -->
                            <div class="space-y-3 mb-6">
                                <button onclick="signInWithGoogle()" type="button"
                                        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-white hover:bg-gray-50 text-gray-900 rounded-lg border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span class="font-semibold">Continuer avec Google</span>
                                </button>
                                
                                <button onclick="signInWithApple()" type="button"
                                        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-black hover:bg-gray-900 text-white rounded-lg border-2 border-gray-800 hover:border-gray-700 transition-all">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                                    </svg>
                                    <span class="font-semibold">Continuer avec Apple</span>
                                </button>
                            </div>
                            
                            <!-- Separator -->
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-600"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-4 bg-gray-800 text-gray-400">ou</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <form id="authForm" class="space-y-4">
                            ${mode === 'signup' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:name_label')}</label>
                                    <input 
                                        type="text" 
                                        id="name" 
                                        required 
                                        minlength="2"
                                        maxlength="100"
                                        placeholder="John Doe"
                                        class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        oninput="validateName()"
                                    >
                                    <div id="nameError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:phone_label')}</label>
                                    <div class="flex gap-2">
                                        <select 
                                            id="countryCode" 
                                            class="w-32 px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        >
                                            <option value="+971">üá¶üá™ +971</option>
                                            <option value="+33">üá´üá∑ +33</option>
                                            <option value="+44">üá¨üáß +44</option>
                                            <option value="+966">üá∏üá¶ +966</option>
                                            <option value="+91">üáÆüá≥ +91</option>
                                            <option value="+92">üáµüá∞ +92</option>
                                            <option value="+86">üá®üá≥ +86</option>
                                            <option value="+63">üáµüá≠ +63</option>
                                            <option value="+7">üá∑üá∫ +7</option>
                                            <option value="+20">üá™üá¨ +20</option>
                                            <option value="+1">üá∫üá∏ +1</option>
                                        </select>
                                        <input 
                                            type="tel" 
                                            id="phone" 
                                            required 
                                            placeholder="612345678"
                                            class="flex-1 px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                            oninput="validatePhone()"
                                        >
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">${t('auth:phone_info')}</div>
                                    <div class="flex items-start gap-2 bg-blue-900/30 border border-blue-500/30 rounded-lg p-3 mt-2">
                                        <span class="text-blue-400 text-lg flex-shrink-0">‚ÑπÔ∏è</span>
                                        <p class="text-xs text-blue-200">
                                            <strong>Important :</strong> Vous recevrez un code SMS de v√©rification UNIQUEMENT √† l'inscription. Ensuite, la connexion se fera par email et mot de passe.
                                        </p>
                                    </div>
                                    <div id="phoneError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                            ` : ''}
                            
                            ${mode !== 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:email_label')}</label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        required 
                                        placeholder="exemple@email.com"
                                        class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        ${mode === 'signup' ? 'oninput="validateEmail()"' : ''}
                                    >
                                    ${mode === 'signup' ? '<div id="emailError" class="text-red-400 text-sm mt-1 hidden"></div>' : ''}
                                </div>
                            ` : ''}
                            
                            ${mode !== 'reset' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Nouveau mot de passe' : t('auth:password_label')}</label>
                                    <div class="relative">
                                        <input 
                                            type="password" 
                                            id="${mode === 'change-password' ? 'newPassword' : 'password'}" 
                                            required 
                                            minlength="8" 
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12 transition-colors"
                                            ${mode === 'signup' || mode === 'change-password' ? 'oninput="validatePassword()"' : ''}
                                        >
                                        <button 
                                            type="button" 
                                            onclick="togglePasswordVisibility('${mode === 'change-password' ? 'newPassword' : 'password'}', this)" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
                                            aria-label="Afficher/masquer le mot de passe"
                                        >
                                            <span class="text-xl">üëÅÔ∏è</span>
                                        </button>
                                    </div>
                                    ${mode === 'signup' || mode === 'change-password' ? `
                                        <div class="mt-2">
                                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                                <div id="passwordStrength" class="flex-1 h-1.5 bg-gray-600 rounded-full overflow-hidden">
                                                    <div id="passwordStrengthBar" class="h-full w-0 transition-all duration-300"></div>
                                                </div>
                                                <span id="passwordStrengthText" class="min-w-[60px]"></span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1.5 space-y-0.5">
                                                <div id="req-length" class="flex items-center gap-1">
                                                    <span class="w-3">‚Ä¢</span>
                                                    <span>Minimum 8 caract√®res</span>
                                                </div>
                                                <div id="req-letter" class="flex items-center gap-1">
                                                    <span class="w-3">‚Ä¢</span>
                                                    <span>Au moins une lettre</span>
                                                </div>
                                                <div id="req-number" class="flex items-center gap-1">
                                                    <span class="w-3">‚Ä¢</span>
                                                    <span>Au moins un chiffre</span>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `<div class="text-sm text-gray-400 mt-1">${t('auth:password_hint')}</div>`}
                                    <div id="passwordError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                            ` : ''}
                            
                            ${mode === 'signup' || mode === 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Confirmer le nouveau mot de passe' : t('auth:confirm_password_label')}</label>
                                    <div class="relative">
                                        <input 
                                            type="password" 
                                            id="${mode === 'change-password' ? 'confirmNewPassword' : 'confirmPassword'}" 
                                            required 
                                            minlength="8" 
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12 transition-colors"
                                            oninput="validateConfirmPassword()"
                                        >
                                        <button 
                                            type="button" 
                                            onclick="togglePasswordVisibility('${mode === 'change-password' ? 'confirmNewPassword' : 'confirmPassword'}', this)" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
                                            aria-label="Afficher/masquer la confirmation"
                                        >
                                            <span class="text-xl">üëÅÔ∏è</span>
                                        </button>
                                    </div>
                                    <div id="confirmPasswordError" class="text-red-400 text-sm mt-1 hidden"></div>
                                    <div id="confirmPasswordSuccess" class="text-green-400 text-sm mt-1 hidden flex items-center gap-1">
                                        <span>‚úì</span>
                                        <span>Les mots de passe correspondent</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${mode === 'login' ? `
                                <div class="text-right">
                                    <button type="button" onclick="showReset()" class="text-yellow-400 hover:text-yellow-300 text-sm transition-colors">
                                        ${t('auth:forgot_password')}
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div id="authError" class="text-red-400 text-sm hidden bg-red-900/20 border border-red-500/50 rounded-lg p-3"></div>
                            
                            <button 
                                type="submit" 
                                id="submitButton"
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                ${mode === 'signup' || mode === 'change-password' ? 'disabled' : ''}
                            >
                                ${buttonText}
                            </button>
                        </form>
                        
                        <p class="text-center mt-6 text-gray-400">
                            <button onclick="${linkAction}" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                                ${linkText}
                            </button>
                        </p>
                        
                        ${mode === 'signup' ? `
                            <div class="text-center mt-4">
                                <button type="button" onclick="prefillTestData()" class="text-sm text-gray-400 hover:text-white border border-gray-600 px-3 py-1 rounded">
                                    Remplir avec les donn√©es de test
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        function renderDashboard() {
            if (!userProfile) {
                return '<div class="min-h-screen flex items-center justify-center"><div class="text-xl">‚è≥ Chargement du profil...</div></div>';
            }
            const isAdmin = userProfile.role === 'admin';
            
            // ‚úÖ V√âRIFICATION AM√âLIOR√âE DU CONTRAT
            const hasValidContract = userProfile.contract_path || 
                                    userProfile.contract_file_url || 
                                    userProfile.contract_status === 'signed' || 
                                    userProfile.contract_status === 'approved';
            
            console.log('üìÑ Contract check:', {
                contract_path: userProfile.contract_path,
                contract_file_url: userProfile.contract_file_url,
                contract_status: userProfile.contract_status,
                hasValidContract: hasValidContract
            });
            
            const dashboardTitle = isAdmin ? t('dashboard:admin_title') : t('dashboard:referrer_title');
            return `
                <div class="min-h-screen">
                    <header class="bg-gray-800 bg-opacity-50 backdrop-blur-md">
                        <div class="container mx-auto px-4 py-4">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold text-yellow-400">${dashboardTitle}</h1>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-300">${userProfile.name}</span>
                                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">
                                        ${t('dashboard:logout')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    <main class="container mx-auto px-4 py-8">
                        ${!hasValidContract && !isAdmin ? `
                            <div id="contractRequirement" class="mb-6 bg-red-900 bg-opacity-50 border-l-4 border-red-500 p-6 rounded-lg shadow-lg">
                                <div class="flex items-start gap-4">
                                    <div class="text-3xl flex-shrink-0">‚ö†Ô∏è</div>
                                    <div class="flex-1">
                                        <h3 class="text-xl font-bold text-red-300 mb-2">${t('dashboard:contract_required')}</h3>
                                        <p class="text-gray-300 mb-4">${t('dashboard:contract_warning_message')}</p>
                                        
                                        <div class="grid md:grid-cols-2 gap-4">
                                            <div class="bg-blue-900 bg-opacity-30 p-4 rounded-lg">
                                                <h4 class="font-bold text-blue-300 mb-2">üì• √âtape 1 : T√©l√©charger</h4>
                                                <p class="text-sm text-gray-300 mb-3">${t('dashboard:upload_instructions')}</p>
                                                <button 
                                                    onclick="downloadContractTemplate()" 
                                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition"
                                                >
                                                    ${t('dashboard:download_contract_template')}
                                                </button>
                                            </div>
                                            
                                            <div class="bg-yellow-900 bg-opacity-30 p-4 rounded-lg">
                                                <h4 class="font-bold text-yellow-300 mb-2">üì§ √âtape 2 : Uploader</h4>
                                                <form id="contractForm">
                                                    <input 
                                                        type="file" 
                                                        id="contractFile" 
                                                        accept=".pdf" 
                                                        required 
                                                        class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none mb-3 text-sm"
                                                    >
                                                    <button 
                                                        type="submit" 
                                                        id="contractSubmitBtn"
                                                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition"
                                                    >
                                                        ${t('dashboard:submit_contract')}
                                                    </button>
                                                    <div id="uploadError" class="hidden text-red-300 text-xs mt-2 bg-red-900/50 p-2 rounded"></div>
                                                    <div id="uploadProgress" class="hidden text-blue-300 text-xs mt-2"></div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${hasValidContract && !isAdmin ? `
                            <div id="contractUploaded" class="mb-6 bg-green-900 bg-opacity-50 border-l-4 border-green-500 p-6 rounded-lg shadow-lg">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl flex-shrink-0">‚úÖ</div>
                                    <div>
                                        <h3 class="text-xl font-bold text-green-300">Contrat sign√© et valid√©</h3>
                                        <p class="text-gray-300">Vous pouvez maintenant ajouter des leads</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="stats" class="grid md:grid-cols-4 gap-6 mb-8"></div>
                        
                        ${!isAdmin ? `
                            <div class="mb-6">
                                <button 
                                    id="addLeadBtn"
                                    onclick="showAddLeadForm()" 
                                    ${!hasValidContract ? 'disabled' : ''}
                                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg transition ${!hasValidContract ? 'opacity-50 cursor-not-allowed' : ''}"
                                >
                                    ${t('dashboard:add_lead')}
                                </button>
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6 mb-8">
                            <h2 class="text-2xl font-bold mb-4">${isAdmin ? t('dashboard:all_leads') : t('dashboard:my_leads')}</h2>
                            <div id="leadsTable" class="overflow-x-auto"></div>
                        </div>
                    </main>
                    
                    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                        <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full">
                            <h3 class="text-2xl font-bold mb-6">${t('dashboard:add_lead')}</h3>
                            <form id="addLeadForm" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_name')}</label>
                                        <input type="text" id="clientName" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_email')}</label>
                                        <input type="email" id="clientEmail" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_phone')}</label>
                                        <input type="tel" id="clientPhone" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:property_type')}</label>
                                        <select id="propertyType" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                            <option value="">${t('dashboard:select_type')}</option>
                                            <option value="sale_buyer">${t('dashboard:sale_buyer')}</option>
                                            <option value="sale_seller">${t('dashboard:sale_seller')}</option>
                                            <option value="rental_landlord">${t('dashboard:rental_landlord')}</option>
                                            <option value="rental_tenant">${t('dashboard:rental_tenant')}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:budget')}</label>
                                        <input type="number" id="budget" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                        ${t('dashboard:add')}
                                    </button>
                                    <button type="button" onclick="document.getElementById('addLeadModal').classList.add('hidden')" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-lg transition">
                                        ${t('dashboard:cancel')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        function showLogin() {
            console.log('üîê showLogin called');
            currentPage = 'auth-login';
            window.currentPage = 'auth-login';
            render();
        }
        function showSignup() {
            console.log('üìù showSignup called');
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
            render();
        }
        function showReset() {
            console.log('üîë showReset called');
            currentPage = 'auth-reset';
            window.currentPage = 'auth-reset';
            render();
        }
        function backToHome() {
            console.log('üè† backToHome called');
            currentPage = 'landing';
            window.currentPage = 'landing';
            isPasswordRecoveryMode = false;
            render();
        }
        function prefillTestData() {
            if (document.getElementById('name')) {
                document.getElementById('name').value = 'Test User';
                document.getElementById('countryCode').value = '+33';
                document.getElementById('phone').value = '612345678';
                document.getElementById('email').value = 'karyne@itooki.fr';
                document.getElementById('password').value = 'Test1234';
                document.getElementById('confirmPassword').value = 'Test1234';
                validateName();
                validatePhone();
                validateEmail();
                validatePassword();
                validateConfirmPassword();
                console.log('‚úÖ Donn√©es de test pr√©-remplies');
            }
        }
        function handleAuth(mode) {
            console.log('üîß handleAuth called for mode:', mode);
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            if (!form) {
                console.error('‚ùå Form not found');
                return;
            }
            console.log('‚úÖ Form found, attaching handler');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                console.log('üì§ Form submitted for', mode);
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password')?.value;
                try {
                    if (mode === 'signup') {
                        console.log('üìù Processing signup');
                        const name = document.getElementById('name').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const countryCode = document.getElementById('countryCode').value;
                        
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        
                        if (!validateName()) throw new Error('Nom invalide');
                        if (!validatePhone()) throw new Error('Num√©ro de t√©l√©phone invalide');
                        if (!validateEmail()) throw new Error('Email invalide');
                        if (!validatePassword()) throw new Error('Mot de passe invalide');
                        if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));
                        
                        const fullPhone = countryCode + phone;
                        
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = true;
                        submitButton.textContent = 'Inscription en cours...';
                        
                        console.log('üì§ Signup data:', { email, name, phone: fullPhone });
                        
                        isSignupInProgress = true;
                        console.log('üîí Signup in progress - blocking renders');
                        
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name, phone: fullPhone }
                            }
                        });
                        if (error) {
                            isSignupInProgress = false;
                            throw error;
                        }
                        
                        console.log('‚úÖ Signup successful, user:', data.user);
                        
                        console.log('üîì Signing out IMMEDIATELY to prevent auto-redirect');
                        const sessionToUse = data.session;
                        await supabase.auth.signOut();
                        console.log('‚úÖ Signed out, now safe to proceed with 2FA');
                        
                        tempUserId = data.user.id;
                        
                        const { error: profileError } = await supabase.from('profiles').insert({
                            id: data.user.id,
                            name: name,
                            phone: fullPhone,
                            role: 'referrer',
                            contract_status: 'pending',
                            phone_verified: false
                        });
                        
                        if (profileError) {
                            console.error('‚ùå Error creating profile:', profileError);
                        }
                        
                        tempUserProfile = {
                            id: data.user.id,
                            name: name,
                            phone: fullPhone,
                            email: email,
                            role: 'referrer',
                            contract_status: 'pending',
                            phone_verified: false
                        };
                        window.tempPassword = password;
                        window.tempAccessToken = sessionToUse.access_token;
                        
                        is2FAMode = true;
                        console.log('üì± Sending 2FA code...');
                        const currentLang = i18next.language || 'fr';
                        await send2FACode(data.user.id, sessionToUse, currentLang);
                        
                        render();
                    } else if (mode === 'login') {
                        console.log('üîê Processing login');
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        console.log('‚úÖ Login successful');
                    }
                } catch (error) {
                    console.error('‚ùå Auth error:', error);
                    let errorMessage = error.message;
                    
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Email ou mot de passe incorrect';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Veuillez confirmer votre email avant de vous connecter';
                    } else if (error.message.includes('User already registered')) {
                        errorMessage = 'Cet email est d√©j√† utilis√©';
                    } else if (error.message.includes('Password should be at least')) {
                        errorMessage = 'Le mot de passe doit contenir au moins 8 caract√®res';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    
                    if (mode === 'signup') {
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = false;
                        submitButton.textContent = t('auth:signup_button');
                    }
                }
            };
        }
        async function handleReset() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value;
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    
                    if (error) throw error;
                    
                    alert(t('auth:reset_email_sent'));
                    showLogin();
                } catch (error) {
                    console.error('Reset error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
       async function send2FACode(userId, session, language = 'fr') {
    try {
        console.log('üì± Sending 2FA code for user:', userId, 'language:', language);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-2fa-code`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ 
                userId: userId,
                language: language
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            const errorMsg = result.error || 'Erreur envoi SMS';
            
            if (errorMsg.includes('error: 80') || errorMsg.includes('SMS error: 80')) {
                console.log('‚úÖ SMS sent despite error 80 (warning only)');
                return true;
            }
            
            throw new Error(errorMsg);
        }
        
        console.log('‚úÖ SMS sent successfully');
        if (result.warning) {
            console.warn('‚ö†Ô∏è SMS warning:', result.warning);
        }
        
        return true;
    } catch (error) {
        const errorMsg = error.message || '';
        
        if (errorMsg.includes('error: 80') || errorMsg.includes('SMS error: 80')) {
            console.log('‚úÖ SMS sent despite error 80 (caught in catch)');
            return true;
        }
        
        console.error('‚ùå Erreur send2FACode:', error);
        alert(t('auth:errors.sms_failed'));
        return false;
    }
}
        async function verify2FACode(code) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(code);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const codeHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                const { data: codes, error } = await supabase
                    .from('verification_codes')
                    .select('*')
                    .eq('user_id', tempUserId)
                    .eq('code_hash', codeHash)
                    .eq('used', false)
                    .gt('expires_at', new Date().toISOString())
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (!codes || codes.length === 0) {
                    console.log('‚ùå Code not found or invalid');
                    
                    const { data: currentCodes } = await supabase
                        .from('verification_codes')
                        .select('id, attempts')
                        .eq('user_id', tempUserId)
                        .eq('used', false)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (currentCodes && currentCodes.length > 0) {
                        await supabase
                            .from('verification_codes')
                            .update({ attempts: currentCodes[0].attempts + 1 })
                            .eq('id', currentCodes[0].id);
                    }
                    
                    return false;
                }
                
                const { error: markError } = await supabase
                    .from('verification_codes')
                    .update({ used: true })
                    .eq('id', codes[0].id);
                
                if (markError) throw markError;
                
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ phone_verified: true })
                    .eq('id', tempUserId);
                if (updateError) {
                    console.error('‚ùå Error updating phone_verified:', updateError);
                }
                console.log('‚úÖ Phone marked as verified');
                console.log('‚úÖ 2FA code validated, reconnecting user...');
                
                if (!tempUserProfile || !tempUserProfile.email || !window.tempPassword) {
                    throw new Error('Donn√©es de connexion manquantes');
                }
                
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email: tempUserProfile.email,
                    password: window.tempPassword
                });
                
                if (signInError) {
                    console.error('‚ùå Error signing in after 2FA:', signInError);
                    throw signInError;
                }
                
                console.log('‚úÖ User signed in successfully after 2FA');
                
                delete window.tempPassword;
                delete window.tempAccessToken;
                
                isSignupInProgress = false;
                console.log('üîì Signup complete - unblocking renders');
                
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', signInData.user.id)
                    .single();
                
                if (profileError) {
                    console.error('‚ùå Error loading profile:', profileError);
                } else {
                    userProfile = profileData;
                    window.userProfile = profileData;
                }
                
                currentUser = signInData.user;
                window.currentUser = signInData.user;
                currentPage = tempUserProfile.role === 'admin' ? 'admin' : 'referrer';
                is2FAMode = false;
                tempUserId = null;
                tempUserProfile = null;
                
                console.log('‚úÖ Session restored, currentUser:', currentUser);
                
                return true;
            } catch (error) {
                console.error('Erreur verify2FACode:', error);
                isSignupInProgress = false;
                return false;
            }
        }
        function showOAuthWarning(provider) {
            const modal = document.getElementById('oauthWarningModal');
            const providerName = provider === 'google' ? 'Google' : 'Apple';
            
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full border-2 border-yellow-500">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-2xl font-bold mb-4">Information de s√©curit√©</h3>
                        </div>
                        
                        <p class="text-gray-300 mb-6 leading-relaxed">
                            Vous allez √™tre redirig√© vers notre service d'authentification s√©curis√© 
                            <strong class="text-yellow-400">(Supabase)</strong> pour vous connecter avec ${providerName}.
                        </p>
                        
                        <p class="text-gray-300 mb-6">
                            <span class="text-green-400 font-semibold">‚úì C'est normal et s√©curis√©.</span><br>
                            Vous reviendrez automatiquement sur notre site apr√®s connexion.
                        </p>
                        
                        <div class="flex gap-4">
                            <button 
                                onclick="proceedWithOAuth('${provider}')" 
                                class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition"
                            >
                                Continuer
                            </button>
                            <button 
                                onclick="closeOAuthWarning()" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition"
                            >
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        function closeOAuthWarning() {
            const modal = document.getElementById('oauthWarningModal');
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }
        async function proceedWithOAuth(provider) {
            closeOAuthWarning();
            
            try {
                console.log(`üîê Starting ${provider} Sign In...`);
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                console.log(`‚úÖ ${provider} redirect initiated`);
            } catch (error) {
                console.error(`‚ùå ${provider} Sign In error:`, error);
                alert(`Erreur lors de la connexion avec ${provider}: ` + error.message);
            }
        }
        async function signInWithGoogle() {
            showOAuthWarning('google');
        }
        async function signInWithApple() {
            showOAuthWarning('apple');
        }
        async function handle2FASubmit(event) {
            event.preventDefault();
            const code = document.getElementById('code2fa').value;
            
            const isValid = await verify2FACode(code);
            
            if (isValid) {
                render();
            } else {
                alert(t('auth:errors.invalid_2fa_code'));
            }
        }
        async function resend2FACode() {
            if (tempUserId) {
                const currentLang = i18next.language || 'fr';
                
                if (window.tempAccessToken) {
                    const tempSession = { access_token: window.tempAccessToken };
                    const success = await send2FACode(tempUserId, tempSession, currentLang);
                    if (success) {
                        alert(t('auth:two_factor.code_sent'));
                    }
                } else {
                    const { data: { session } } = await supabase.auth.getSession();
                    const success = await send2FACode(tempUserId, session, currentLang);
                    if (success) {
                        alert(t('auth:two_factor.code_sent'));
                    }
                }
            }
        }
        async function handleChangePassword() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (newPassword.length < 8) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins 8 caract√®res';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[a-zA-Z]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins une lettre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[0-9]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins un chiffre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                try {
                    console.log('üîë Updating password...');
                    const { error } = await supabase.auth.updateUser({ 
                        password: newPassword 
                    });
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Password updated successfully');
                    isPasswordRecoveryMode = false;
                    alert('‚úÖ Mot de passe chang√© avec succ√®s !');
                    await supabase.auth.signOut();
                    showLogin();
                } catch (error) {
                    console.error('‚ùå Change password error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        // ‚úÖ FONCTION loadDashboardContent() AM√âLIOR√âE
        async function loadDashboardContent() {
            if (!userProfile) return;
            const isAdmin = userProfile.role === 'admin';
            let leads;
            let profiles = {};
            if (isAdmin) {
                console.log('üìä Loading leads for admin...');
                const { data: leadsData, error: leadsError } = await supabase
                    .from('leads')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (leadsError) {
                    console.error('‚ùå Error loading leads:', leadsError);
                    document.getElementById('leadsTable').innerHTML = `
                        <div class="text-red-400 p-4">
                            Erreur lors du chargement des leads: ${leadsError.message}
                        </div>
                    `;
                    return;
                }
                console.log('‚úÖ Leads loaded:', leadsData?.length);
                console.log('üë• Loading all profiles...');
                const { data: profilesData, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*');
                if (profilesError) {
                    console.error('‚ùå Error loading profiles:', profilesError);
                } else {
                    console.log('‚úÖ Profiles loaded:', profilesData?.length);
                    profilesData.forEach(profile => {
                        profiles[profile.id] = profile;
                    });
                }
                leads = leadsData.map(lead => ({
                    ...lead,
                    referrer_name: profiles[lead.referrer_id]?.name || 'N/A'
                }));
            } else {
                console.log('üìä Loading leads for referrer...');
                const { data, error } = await supabase
                    .from('leads')
                    .select('*')
                    .eq('referrer_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) {
                    console.error('‚ùå Error loading leads:', error);
                    document.getElementById('leadsTable').innerHTML = `
                        <div class="text-red-400 p-4">
                            Erreur lors du chargement des leads: ${error.message}
                        </div>
                    `;
                    return;
                }
                console.log('‚úÖ Leads loaded:', data?.length);
                leads = data;
            }
            const totalEarnings = leads.filter(l => l.status === 'vendu').reduce((sum, l) => sum + (l.referrer_commission || 0), 0);
            const activeLeads = leads.filter(l => l.status !== 'vendu').length;
            const closedSales = leads.filter(l => l.status === 'vendu').length;
            document.getElementById('stats').innerHTML = `
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${leads.length}</div>
                        <div class="text-gray-300">${t('dashboard:total_referrers')}</div>
                    </div>
                ` : `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard:total_earnings')}</div>
                    </div>
                `}
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${activeLeads}</div>
                    <div class="text-gray-300">${t('dashboard:active_leads')}</div>
                </div>
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${closedSales}</div>
                    <div class="text-gray-300">${t('dashboard:closed_sales')}</div>
                </div>
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard:commissions_paid')}</div>
                    </div>
                ` : ''}
            `;
            const statusColors = {
                'nouveau': 'bg-blue-500',
                'visite': 'bg-yellow-500',
                'offre': 'bg-orange-500',
                'vendu': 'bg-green-500'
            };
            document.getElementById('leadsTable').innerHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard:referrer')}</th>` : ''}
                            <th class="text-left py-3 px-4">${t('dashboard:client_name')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:property_type')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:budget')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:status')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:commission')}</th>
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard:actions')}</th>` : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${leads.length === 0 ? `
                            <tr>
                                <td colspan="${isAdmin ? '7' : '5'}" class="py-8 text-center text-gray-400">
                                    ${t('dashboard:no_leads')}
                                </td>
                            </tr>
                        ` : leads.map(lead => `
                            <tr class="border-b border-gray-700">
                                ${isAdmin ? `<td class="py-3 px-4">${lead.referrer_name}</td>` : ''}
                                <td class="py-3 px-4">${lead.client_name}</td>
                                <td class="py-3 px-4">${t('dashboard:' + lead.property_type)}</td>
                                <td class="py-3 px-4">${lead.budget?.toLocaleString()} AED</td>
                                <td class="py-3 px-4">
                                    ${isAdmin ? `
                                        <select onchange="updateLeadStatus(${lead.id}, this.value)" class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            <option value="nouveau" ${lead.status === 'nouveau' ? 'selected' : ''}>${t('dashboard:status_new')}</option>
                                            <option value="visite" ${lead.status === 'visite' ? 'selected' : ''}>${t('dashboard:status_visit')}</option>
                                            <option value="offre" ${lead.status === 'offre' ? 'selected' : ''}>${t('dashboard:status_offer')}</option>
                                            <option value="vendu" ${lead.status === 'vendu' ? 'selected' : ''}>${t('dashboard:status_sold')}</option>
                                        </select>
                                    ` : `
                                        <span class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            ${t('dashboard:status_' + lead.status.replace('√©', 'e'))}
                                        </span>
                                    `}
                                </td>
                                <td class="py-3 px-4 font-bold text-yellow-500">
                                    ${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : '-'}
                                </td>
                                ${isAdmin ? `
                                    <td class="py-3 px-4">
                                        ${lead.status !== 'vendu' ? `
                                            <button onclick="markAsSold(${lead.id})" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                                ${t('dashboard:mark_sold')}
                                            </button>
                                        ` : '-'}
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function showAddLeadForm() {
            const hasValidContract = userProfile?.contract_path || 
                                    userProfile?.contract_file_url || 
                                    userProfile?.contract_status === 'signed' || 
                                    userProfile?.contract_status === 'approved';
            
            if (!hasValidContract) {
                alert(t('dashboard:contract_required_to_add_lead') || 'Vous devez uploader votre contrat sign√© avant d\'ajouter des leads.');
                return;
            }
            document.getElementById('addLeadModal').classList.remove('hidden');
            
            const form = document.getElementById('addLeadForm');
            form.onsubmit = async (e) => {
                e.preventDefault();
                
                const leadData = {
                    referrer_id: currentUser.id,
                    client_name: document.getElementById('clientName').value,
                    client_email: document.getElementById('clientEmail').value,
                    client_phone: document.getElementById('clientPhone').value,
                    property_type: document.getElementById('propertyType').value,
                    budget: parseFloat(document.getElementById('budget').value),
                    status: 'nouveau'
                };
                const { error } = await supabase.from('leads').insert([leadData]);
                
                if (error) {
                    console.error('Error adding lead:', error);
                    alert('Erreur lors de l\'ajout du lead');
                    return;
                }
                document.getElementById('addLeadModal').classList.add('hidden');
                form.reset();
                await loadDashboardContent();
            };
        }
        async function updateLeadStatus(leadId, newStatus) {
            const { error } = await supabase.from('leads').update({ status: newStatus }).eq('id', leadId);
            
            if (error) {
                console.error('Error updating status:', error);
                alert('Erreur lors de la mise √† jour du statut');
                return;
            }
            await loadDashboardContent();
        }
        async function markAsSold(leadId) {
            const salePrice = prompt('Prix de vente (AED):');
            if (!salePrice) return;
            const price = parseFloat(salePrice);
            const agentCommission = price * 0.01;
            const referrerCommission = agentCommission * 0.20;
            const { error } = await supabase.from('leads').update({
                status: 'vendu',
                sale_price: price,
                agent_commission: agentCommission,
                referrer_commission: referrerCommission,
                closed_at: new Date().toISOString()
            }).eq('id', leadId);
            if (error) {
                console.error('Error marking as sold:', error);
                alert('Erreur lors de la vente');
                return;
            }
            await loadDashboardContent();
        }
        async function loadUserProfile(user = null) {
            const targetUser = user || currentUser;
            console.log('üîç loadUserProfile called for user:', targetUser?.id);
            if (!targetUser || !targetUser.id) {
                console.error('‚ùå No user provided to loadUserProfile');
                return false;
            }
            try {
                console.log('üîç Fetching profile from Supabase for:', targetUser.id);
                const { data, error } = await supabase.from('profiles').select('*').eq('id', targetUser.id).single();
                if (error) {
                    console.error('‚ùå Error loading profile:', error);
                    
                    if (error.code === 'PGRST116') {
                        console.log('üìù Profile does not exist, creating it...');
                        const { data: newProfile, error: insertError } = await supabase.from('profiles').insert([{
                            id: targetUser.id,
                            name: targetUser.user_metadata?.name || targetUser.email.split('@')[0],
                            phone: targetUser.user_metadata?.phone || '',
                            role: 'referrer',
                            contract_status: 'pending'
                        }]).select().single();
                        if (insertError) {
                            console.error('‚ùå Error creating profile:', insertError);
                            alert('Erreur lors de la cr√©ation du profil: ' + insertError.message);
                            return false;
                        }
                        console.log('‚úÖ Profile created:', newProfile);
                        userProfile = newProfile;
                        window.userProfile = newProfile;
                        return true;
                    }
                    
                    alert('Erreur lors du chargement du profil: ' + error.message);
                    return false;
                }
                console.log('‚úÖ Profile data retrieved:', data);
                
                if (data && data.contract_status) {
                    data.contract_status = data.contract_status.trim().replace(/\*+/g, '');
                }
                userProfile = data;
                window.userProfile = data;
                console.log('‚úÖ userProfile set:', userProfile);
                return true;
            } catch (error) {
                console.error('‚ùå Exception loading profile:', error);
                alert('Exception lors du chargement du profil: ' + error.message);
                return false;
            }
        }
        window.loadUserProfile = loadUserProfile;
        async function logout() {
            console.log('üö™ Logout called');
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'D√©connexion...';
            }
            try {
                console.log('üîì Signing out from Supabase...');
                
                // Timeout de s√©curit√© : si signOut prend plus de 3 secondes, on force la d√©connexion
                const signOutPromise = supabase.auth.signOut();
                const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve({ timeout: true }), 3000));
                
                const result = await Promise.race([signOutPromise, timeoutPromise]);
                
                if (result?.timeout) {
                    console.warn('‚ö†Ô∏è SignOut timeout - forcing logout');
                } else if (result?.error) {
                    console.error('‚ùå Logout error:', result.error);
                } else {
                    console.log('‚úÖ Supabase signOut successful');
                }
                
                // Forcer le nettoyage complet de TOUTES les donn√©es de session
                console.log('üßπ Cleaning all session data...');
                
                // Nettoyer localStorage
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('supabase')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Nettoyer sessionStorage
                sessionStorage.clear();
                
                // R√©initialiser les variables globales
                currentUser = null;
                userProfile = null;
                currentPage = 'landing';
                isPasswordRecoveryMode = false;
                is2FAMode = false;
                tempUserId = null;
                tempUserProfile = null;
                
                window.currentUser = null;
                window.userProfile = null;
                window.currentPage = 'landing';
                
                globalIsUploading = false;
                
                console.log('‚úÖ Local state cleaned');
                
                // Forcer le rechargement de la page pour garantir un √©tat propre
                console.log('üîÑ Reloading page...');
                window.location.href = window.location.origin;
                
            } catch (error) {
                console.error('‚ùå Logout exception:', error);
                
                // M√™me en cas d'erreur, forcer la d√©connexion
                console.log('üö® Forcing logout despite error...');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = window.location.origin;
            }
        }
        async function render() {
            console.log('üé® RENDER called');
            console.log('- currentUser:', !!currentUser);
            console.log('- userProfile:', !!userProfile);
            console.log('- currentPage:', currentPage);
            console.log('- isPasswordRecoveryMode:', isPasswordRecoveryMode);
            console.log('- is2FAMode:', is2FAMode);
            console.log('- isSignupInProgress:', isSignupInProgress);
            
            const app = document.getElementById('app');
            if (is2FAMode) {
                console.log('üì± 2FA mode active - showing 2FA form');
                app.innerHTML = renderAuthPage('login');
                return;
            }
            if (isPasswordRecoveryMode && currentPage === 'change-password') {
                console.log('üîë Password recovery mode - showing change password form');
                app.innerHTML = renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
                return;
            }
            if (currentUser && userProfile) {
                console.log('‚úÖ User connected with profile, showing dashboard');
                currentPage = 'dashboard';
                window.currentPage = 'dashboard';
                app.innerHTML = renderDashboard();
                await loadDashboardContent();
                
                // ‚úÖ GESTION AM√âLIOR√âE DE L'UPLOAD DE CONTRAT
                if (userProfile.role !== 'admin') {
                    const contractForm = document.getElementById('contractForm');
                    if (contractForm) {
                        console.log('‚úÖ Contract form found, attaching submit handler');
                        
                        contractForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            
                            if (globalIsUploading) {
                                console.log('‚ö†Ô∏è Upload already in progress, ignoring duplicate submit');
                                return;
                            }
                            
                            globalIsUploading = true;
                            console.log('üìÑ Starting contract upload...');
                            
                            const submitBtn = document.getElementById('contractSubmitBtn');
                            const errorDiv = document.getElementById('uploadError');
                            const progressDiv = document.getElementById('uploadProgress');
                            const originalText = submitBtn.textContent;
                            
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Upload en cours...';
                            errorDiv.classList.add('hidden');
                            progressDiv.classList.remove('hidden');
                            progressDiv.textContent = '‚è≥ Pr√©paration du fichier...';
                            
                            // ‚úÖ TIMEOUT AUGMENT√â √Ä 60 SECONDES
                            const uploadTimeout = setTimeout(() => {
                                console.error('‚è±Ô∏è Upload timeout after 60 seconds');
                                errorDiv.textContent = 'Erreur : Le t√©l√©chargement a pris trop de temps. Veuillez r√©essayer avec un fichier plus petit.';
                                errorDiv.classList.remove('hidden');
                                progressDiv.classList.add('hidden');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                globalIsUploading = false;
                            }, 60000); // 60 secondes au lieu de 30
                            
                            try {
                                const fileInput = document.getElementById('contractFile');
                                const file = fileInput.files[0];
                                if (!file) {
                                    throw new Error('Veuillez s√©lectionner un fichier');
                                }
                                if (file.type !== 'application/pdf') {
                                    throw new Error('Seuls les fichiers PDF sont accept√©s');
                                }
                                const maxSize = 10 * 1024 * 1024; // 10MB
                                if (file.size > maxSize) {
                                    throw new Error('Le fichier est trop volumineux. Taille maximum : 10MB');
                                }
                                console.log('üìÑ File validated:', file.name, 'Size:', file.size, 'bytes');
                                
                                progressDiv.textContent = '‚è≥ T√©l√©chargement vers le serveur...';
                                
                                const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;
                                console.log('üìÑ Uploading to Storage with name:', fileName);
                                const { data: uploadData, error: uploadError } = await supabase.storage
                                    .from('contracts')
                                    .upload(fileName, file, {
                                        cacheControl: '3600',
                                        upsert: false
                                    });
                                if (uploadError) {
                                    console.error('‚ùå Error uploading contract:', uploadError);
                                    throw new Error(`Erreur d'upload : ${uploadError.message}`);
                                }
                                console.log('‚úÖ File uploaded successfully to Storage');
                                console.log('üìù File path:', uploadData.path);
                                
                                progressDiv.textContent = '‚è≥ Mise √† jour de votre profil...';
                                
                                // ‚úÖ MISE √Ä JOUR DU contract_path DANS LE PROFIL
                                const { error: updateError } = await supabase.from('profiles').update({
                                    contract_path: uploadData.path,
                                    contract_status: 'signed',
                                    contract_file_url: fileName
                                }).eq('id', currentUser.id);
                                
                                if (updateError) {
                                    console.error('‚ùå Error updating profile:', updateError);
                                    throw new Error(`Erreur de mise √† jour : ${updateError.message}`);
                                }
                                console.log('‚úÖ Profile updated successfully with contract_path:', uploadData.path);
                                
                                clearTimeout(uploadTimeout);
                                
                                alert('‚úÖ Contrat upload√© avec succ√®s !');
                                await loadUserProfile();
                                globalIsUploading = false;
                                render();
                            } catch (error) {
                                clearTimeout(uploadTimeout);
                                
                                console.error('‚ùå Upload exception:', error);
                                errorDiv.textContent = error.message;
                                errorDiv.classList.remove('hidden');
                                progressDiv.classList.add('hidden');
                            } finally {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                globalIsUploading = false;
                            }
                        });
                    } else {
                        console.log('‚ÑπÔ∏è Contract form not found (contract already uploaded or admin user)');
                    }
                } else {
                    console.log('‚ÑπÔ∏è Admin user - no contract form needed');
                }
            } else if (currentUser && !userProfile) {
                console.log('‚è≥ User connected but no profile, waiting...');
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">‚è≥</div><div class="text-xl">Chargement de votre profil...</div></div></div>';
            } else if (currentPage === 'auth-login') {
                console.log('üîê Rendering login page');
                app.innerHTML = renderAuthPage('login');
                setTimeout(() => {
                    console.log('‚è±Ô∏è Attempting to attach login handler');
                    handleAuth('login');
                }, 500);
            } else if (currentPage === 'auth-signup') {
                console.log('üìù Rendering signup page');
                app.innerHTML = renderAuthPage('signup');
                setTimeout(() => {
                    console.log('‚è±Ô∏è Attempting to attach signup handler');
                    handleAuth('signup');
                }, 500);
            } else if (currentPage === 'auth-reset') {
                console.log('üîë Rendering reset page');
                app.innerHTML = renderAuthPage('reset');
                setTimeout(() => handleReset(), 500);
            } else if (currentPage === 'change-password') {
                console.log('üîë Rendering change password page');
                app.innerHTML = renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
            } else {
                console.log('üè† Rendering landing page');
                app.innerHTML = renderLandingPage();
            }
        }
        function validateName() {
            const nameInput = document.getElementById('name');
            const nameError = document.getElementById('nameError');
            
            if (!nameInput || !nameError) return true;
            const name = nameInput.value.trim();
            if (name.length === 0) {
                nameError.textContent = '';
                nameError.classList.add('hidden');
                nameInput.classList.remove('border-green-500', 'border-red-500');
                return false;
            }
            if (name.length < 2) {
                nameError.textContent = 'Le nom doit contenir au moins 2 caract√®res';
                nameError.classList.remove('hidden');
                nameInput.classList.add('border-red-500');
                nameInput.classList.remove('border-green-500');
                return false;
            }
            const nameRegex = /^[a-zA-Z√Ä-√ø\s\-']+$/;
            if (!nameRegex.test(name)) {
                nameError.textContent = 'Le nom ne peut contenir que des lettres, espaces, tirets et apostrophes';
                nameError.classList.remove('hidden');
                nameInput.classList.add('border-red-500');
                nameInput.classList.remove('border-green-500');
                return false;
            }
            nameError.textContent = '';
            nameError.classList.add('hidden');
            nameInput.classList.remove('border-red-500');
            nameInput.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function validatePhone() {
            const phoneField = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            
            if (!phoneField || !phoneError) return true;
            const phone = phoneField.value.trim();
            
            const internationalPattern = /^[0-9]{6,15}$/;
            
            if (!phone) {
                phoneError.textContent = t('auth:errors.phone_required') || 'Le num√©ro de t√©l√©phone est requis';
                phoneError.classList.remove('hidden');
                phoneField.classList.add('border-red-500');
                return false;
            }
            
            if (!internationalPattern.test(phone)) {
                phoneError.textContent = t('auth:errors.phone_invalid') || 'Le num√©ro doit contenir entre 6 et 15 chiffres';
                phoneError.classList.remove('hidden');
                phoneField.classList.add('border-red-500');
                return false;
            }
            
            phoneError.classList.add('hidden');
            phoneField.classList.remove('border-red-500');
            phoneField.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function validateEmail() {
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            
            if (!emailInput || !emailError) return true;
            const email = emailInput.value.trim();
            if (email.length === 0) {
                emailError.textContent = '';
                emailError.classList.add('hidden');
                emailInput.classList.remove('border-green-500', 'border-red-500');
                return false;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailError.textContent = "Format d'email invalide";
                emailError.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
                emailInput.classList.remove('border-green-500');
                return false;
            }
            emailError.textContent = '';
            emailError.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            emailInput.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function validatePassword() {
            const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
            const passwordError = document.getElementById('passwordError');
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            const reqLength = document.getElementById('req-length');
            const reqLetter = document.getElementById('req-letter');
            const reqNumber = document.getElementById('req-number');
            if (!passwordInput) return true;
            const password = passwordInput.value;
            if (reqLength && reqLetter && reqNumber) {
                if (password.length >= 8) {
                    reqLength.classList.add('text-green-400');
                    reqLength.querySelector('span:first-child').textContent = '‚úì';
                } else {
                    reqLength.classList.remove('text-green-400');
                    reqLength.querySelector('span:first-child').textContent = '‚Ä¢';
                }
                if (/[a-zA-Z]/.test(password)) {
                    reqLetter.classList.add('text-green-400');
                    reqLetter.querySelector('span:first-child').textContent = '‚úì';
                } else {
                    reqLetter.classList.remove('text-green-400');
                    reqLetter.querySelector('span:first-child').textContent = '‚Ä¢';
                }
                if (/[0-9]/.test(password)) {
                    reqNumber.classList.add('text-green-400');
                    reqNumber.querySelector('span:first-child').textContent = '‚úì';
                } else {
                    reqNumber.classList.remove('text-green-400');
                    reqNumber.querySelector('span:first-child').textContent = '‚Ä¢';
                }
            }
            if (strengthBar && strengthText) {
                let strength = 0;
                if (password.length >= 8) strength++;
                if (password.length >= 12) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^a-zA-Z0-9]/.test(password)) strength++;
                let color, text, width;
                if (password.length === 0) {
                    width = 0; text = ''; color = 'bg-gray-600';
                } else if (strength <= 1) {
                    width = 25; text = 'Faible'; color = 'bg-red-500';
                } else if (strength === 2) {
                    width = 50; text = 'Moyen'; color = 'bg-yellow-500';
                } else if (strength === 3) {
                    width = 75; text = 'Bon'; color = 'bg-blue-500';
                } else {
                    width = 100; text = 'Excellent'; color = 'bg-green-500';
                }
                strengthBar.style.width = width + '%';
                strengthBar.className = `h-full transition-all duration-300 ${color}`;
                strengthText.textContent = text;
                strengthText.className = `min-w-[60px] ${color.replace('bg-', 'text-')}`;
            }
            if (!passwordError) return true;
            if (password.length === 0) {
                passwordError.classList.add('hidden');
                passwordInput.classList.remove('border-green-500', 'border-red-500');
                checkFormValidity();
                return false;
            }
            if (password.length < 8) {
                passwordError.textContent = `Il manque ${8 - password.length} caract√®re(s)`;
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                passwordInput.classList.remove('border-green-500');
                checkFormValidity();
                return false;
            }
            if (!/[a-zA-Z]/.test(password)) {
                passwordError.textContent = 'Le mot de passe doit contenir au moins une lettre';
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                passwordInput.classList.remove('border-green-500');
                checkFormValidity();
                return false;
            }
            if (!/[0-9]/.test(password)) {
                passwordError.textContent = 'Le mot de passe doit contenir au moins un chiffre';
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                passwordInput.classList.remove('border-green-500');
                checkFormValidity();
                return false;
            }
            passwordError.classList.add('hidden');
            passwordInput.classList.remove('border-red-500');
            passwordInput.classList.add('border-green-500');
            const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
            if (confirmPasswordInput && confirmPasswordInput.value.length > 0) {
                validateConfirmPassword();
            }
            checkFormValidity();
            return true;
        }
        function validateConfirmPassword() {
            const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const confirmPasswordSuccess = document.getElementById('confirmPasswordSuccess');
            if (!passwordInput || !confirmPasswordInput || !confirmPasswordError || !confirmPasswordSuccess) return true;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            if (confirmPassword.length === 0) {
                confirmPasswordError.classList.add('hidden');
                confirmPasswordSuccess.classList.add('hidden');
                confirmPasswordInput.classList.remove('border-green-500', 'border-red-500');
                checkFormValidity();
                return false;
            }
            if (password !== confirmPassword) {
                confirmPasswordError.textContent = 'Les mots de passe ne correspondent pas';
                confirmPasswordError.classList.remove('hidden');
                confirmPasswordSuccess.classList.add('hidden');
                confirmPasswordInput.classList.add('border-red-500');
                confirmPasswordInput.classList.remove('border-green-500');
                checkFormValidity();
                return false;
            }
            confirmPasswordError.classList.add('hidden');
            confirmPasswordSuccess.classList.remove('hidden');
            confirmPasswordInput.classList.remove('border-red-500');
            confirmPasswordInput.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function checkFormValidity() {
            const submitButton = document.getElementById('submitButton');
            if (!submitButton) return;
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
            const nameValid = !nameInput || nameInput.value.trim().length >= 2;
            const emailValid = !emailInput || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
            let phoneValid = !phoneInput;
            if (phoneInput) {
                const phone = phoneInput.value.trim();
                phoneValid = /^[0-9]{6,15}$/.test(phone);
            }
            let passwordValid = false;
            if (passwordInput) {
                const pwd = passwordInput.value;
                passwordValid = pwd.length >= 8 && /[a-zA-Z]/.test(pwd) && /[0-9]/.test(pwd);
            }
            const confirmPasswordValid = !confirmPasswordInput || 
                                        (confirmPasswordInput.value.length > 0 && 
                                         confirmPasswordInput.value === passwordInput?.value);
            const allValid = nameValid && phoneValid && emailValid && passwordValid && confirmPasswordValid;
            if (allValid) {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            if (field.type === 'password') {
                field.type = 'text';
                button.innerHTML = '<span class="text-xl">üôà</span>';
            } else {
                field.type = 'password';
                button.innerHTML = '<span class="text-xl">üëÅÔ∏è</span>';
            }
        }
        async function downloadContractTemplate() {
            try {
                console.log('üì• Downloading contract template...');
                const { data, error } = await supabase.storage
                    .from('contracts')
                    .getPublicUrl('contract_template_en.pdf');
                if (error) {
                    console.error('‚ùå Error getting template URL:', error);
                    alert('Error downloading contract. Please contact support.');
                    return;
                }
                console.log('‚úÖ Template URL:', data.publicUrl);
                window.open(data.publicUrl, '_blank');
            } catch (error) {
                console.error('‚ùå Exception downloading template:', error);
                alert('Error downloading: ' + error.message);
            }
        }
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.showReset = showReset;
        window.logout = logout;
        window.backToHome = backToHome;
        window.showAddLeadForm = showAddLeadForm;
        window.updateLeadStatus = updateLeadStatus;
        window.markAsSold = markAsSold;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.validateName = validateName;
        window.validatePhone = validatePhone;
        window.validateEmail = validateEmail;
        window.validatePassword = validatePassword;
        window.validateConfirmPassword = validateConfirmPassword;
        window.checkFormValidity = checkFormValidity;
        window.prefillTestData = prefillTestData;
        window.render = render;
        window.handleChangePassword = handleChangePassword;
        window.downloadContractTemplate = downloadContractTemplate;
        window.handle2FASubmit = handle2FASubmit;
        window.resend2FACode = resend2FACode;
        window.signInWithGoogle = signInWithGoogle;
        window.signInWithApple = signInWithApple;
        window.showOAuthWarning = showOAuthWarning;
        window.closeOAuthWarning = closeOAuthWarning;
        window.proceedWithOAuth = proceedWithOAuth;
        console.log('‚è≥ Displaying initial loader');
        document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">‚è≥</div><div class="text-xl">Chargement...</div></div></div>';
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('üîî Auth state changed:', event);
            if (isSignupInProgress) {
                console.log('‚ö†Ô∏è Ignoring event during signup process:', event);
                return;
            }
            if (event === 'PASSWORD_RECOVERY') {
                console.log('üîë Password recovery detected - blocking auto-login');
                isPasswordRecoveryMode = true;
                currentPage = 'change-password';
                window.currentPage = 'change-password';
                currentUser = session?.user || null;
                window.currentUser = currentUser;
                render();
                return;
            }
            if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') {
                console.log('‚ö†Ô∏è Ignoring event during password recovery:', event);
                return;
            }
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('‚ö†Ô∏è Email not confirmed, signing out');
                await supabase.auth.signOut();
                currentUser = null;
                window.currentUser = null;
            }
            if (currentUser) {
                console.log('üë§ User authenticated, loading profile...');
                const profileLoaded = await loadUserProfile(currentUser);
                
                if (!profileLoaded) {
                    console.error('‚ùå Failed to load profile, signing out');
                    await supabase.auth.signOut();
                    currentUser = null;
                    window.currentUser = null;
                    userProfile = null;
                    window.userProfile = null;
                }
            }
            render();
        });
        console.log('üîç Getting initial session...');
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('‚ùå Session error:', error);
            currentUser = null;
            window.currentUser = null;
            render();
            return;
        }
        currentUser = session?.user || null;
        window.currentUser = currentUser;
        if (currentUser && !currentUser.email_confirmed_at) {
            console.warn('‚ö†Ô∏è Email not confirmed on init, cleaning session');
            await supabase.auth.signOut();
            localStorage.clear();
            sessionStorage.clear();
            currentUser = null;
            window.currentUser = null;
            render();
            return;
        }
        if (currentUser) {
            console.log('üë§ Session found, loading profile...');
            const profileLoaded = await loadUserProfile(currentUser);
            
            if (!profileLoaded) {
                console.error('‚ùå Failed to load profile on init, signing out');
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                currentUser = null;
                window.currentUser = null;
                userProfile = null;
                window.userProfile = null;
            }
        }
        render();
    })();
    </script>
</body>
</html>
