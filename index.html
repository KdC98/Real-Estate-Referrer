<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    (async () => {
        await i18next
            .use(i18nextHttpBackend)
            .use(i18nextBrowserLanguageDetector)
            .init({
                fallbackLng: 'fr',
                debug: true,
                load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'],
                defaultNS: 'translation',
                backend: {
                    loadPath: '/locales/{{lng}}/{{ns}}.json'
                },
                detection: {
                    order: ['localStorage', 'navigator'],
                    caches: ['localStorage']
                }
            });
        console.log('ğŸŒ Loading translations...');
        await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
        console.log('âœ… All translations loaded!');
        const t = (key) => i18next.t(key);
        async function changeLanguage(langCode) {
            try {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            } catch (error) {
                console.error('Erreur changement de langue:', error);
            }
        }
        window.changeLanguage = changeLanguage;
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
        
        // âœ… TRADUCTIONS OAUTH (8 LANGUES)
        const oauthTranslations = {
            fr: {
                security_info: "Information de sÃ©curitÃ©",
                redirect_message: "Vous allez Ãªtre redirigÃ© vers notre service d'authentification sÃ©curisÃ© <strong>(Supabase)</strong> pour vous connecter avec",
                normal_secure: "C'est normal et sÃ©curisÃ©.",
                will_return: "Vous reviendrez automatiquement sur notre site aprÃ¨s connexion.",
                continue_btn: "Continuer",
                cancel_btn: "Annuler"
            },
            en: {
                security_info: "Security Information",
                redirect_message: "You will be redirected to our secure authentication service <strong>(Supabase)</strong> to sign in with",
                normal_secure: "This is normal and secure.",
                will_return: "You will automatically return to our site after signing in.",
                continue_btn: "Continue",
                cancel_btn: "Cancel"
            },
            ar: {
                security_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†",
                redirect_message: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© <strong>(Supabase)</strong> Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…",
                normal_secure: "Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ¢Ù…Ù†.",
                will_return: "Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
                continue_btn: "Ù…ØªØ§Ø¨Ø¹Ø©",
                cancel_btn: "Ø¥Ù„ØºØ§Ø¡"
            },
            ru: {
                security_info: "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
                redirect_message: "Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° Ğ½Ğ°ÑˆÑƒ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½ÑƒÑ ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ <strong>(Supabase)</strong> Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ·",
                normal_secure: "Ğ­Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.",
                will_return: "Ğ’Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²ĞµÑ€Ğ½ĞµÑ‚ĞµÑÑŒ Ğ½Ğ° Ğ½Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°.",
                continue_btn: "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ",
                cancel_btn: "ĞÑ‚Ğ¼ĞµĞ½Ğ°"
            },
            hi: {
                security_info: "à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€",
                redirect_message: "à¤†à¤ªà¤•à¥‹ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤ªà¥à¤°à¤®à¤¾à¤£à¥€à¤•à¤°à¤£ à¤¸à¥‡à¤µà¤¾ <strong>(Supabase)</strong> à¤ªà¤° à¤ªà¥à¤¨à¤°à¥à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾à¤à¤—à¤¾",
                normal_secure: "à¤¯à¤¹ à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤”à¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆà¥¤",
                will_return: "à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤†à¤ª à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¤¾à¤‡à¤Ÿ à¤ªà¤° à¤²à¥Œà¤Ÿ à¤†à¤à¤‚à¤—à¥‡à¥¤",
                continue_btn: "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
                cancel_btn: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚"
            },
            ur: {
                security_info: "Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
                redirect_message: "Ø¢Ù¾ Ú©Ùˆ ÛÙ…Ø§Ø±ÛŒ Ù…Ø­ÙÙˆØ¸ ØªØµØ¯ÛŒÙ‚ Ø®Ø¯Ù…Øª <strong>(Supabase)</strong> Ù¾Ø± Ø¨Ú¾ÛŒØ¬Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§",
                normal_secure: "ÛŒÛ Ù†Ø§Ø±Ù…Ù„ Ø§ÙˆØ± Ù…Ø­ÙÙˆØ¸ ÛÛ’Û”",
                will_return: "Ø³Ø§Ø¦Ù† Ø§Ù† Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ø®ÙˆØ¯ Ø¨Ø®ÙˆØ¯ ÛÙ…Ø§Ø±ÛŒ Ø³Ø§Ø¦Ù¹ Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¢ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”",
                continue_btn: "Ø¬Ø§Ø±ÛŒ Ø±Ú©Ú¾ÛŒÚº",
                cancel_btn: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº"
            },
            zh: {
                security_info: "å®‰å…¨ä¿¡æ¯",
                redirect_message: "æ‚¨å°†è¢«é‡å®šå‘åˆ°æˆ‘ä»¬çš„å®‰å…¨è®¤è¯æœåŠ¡<strong>(Supabase)</strong>ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•",
                normal_secure: "è¿™æ˜¯æ­£å¸¸ä¸”å®‰å…¨çš„ã€‚",
                will_return: "ç™»å½•åæ‚¨å°†è‡ªåŠ¨è¿”å›æˆ‘ä»¬çš„ç½‘ç«™ã€‚",
                continue_btn: "ç»§ç»­",
                cancel_btn: "å–æ¶ˆ"
            },
            tl: {
                security_info: "Impormasyon sa Seguridad",
                redirect_message: "Ire-redirect ka sa aming secure authentication service <strong>(Supabase)</strong> para mag-sign in gamit ang",
                normal_secure: "Ito ay normal at secure.",
                will_return: "Awtomatikong babalik ka sa aming site pagkatapos mag-sign in.",
                continue_btn: "Magpatuloy",
                cancel_btn: "Kanselahin"
            }
        };
        
        let currentUser = null;
let userProfile = null;
let profileLoadAttempts = 0;
const MAX_PROFILE_LOAD_ATTEMPTS = 10;
let currentPage = 'landing';
let isPasswordRecoveryMode = false;
let is2FAMode = false;
let isSignupInProgress = false;
let tempUserId = null;
let tempUserProfile = null;
let globalIsUploading = false;

// ğŸ¯ Nouveau flag pour la signature
let contractJustSigned = false;

window.currentUser = null;
window.userProfile = null;
window.currentPage = 'landing';
window.contractJustSigned = false;
        // âœ… FONCTION POUR LIRE LES PARAMÃˆTRES D'URL
        function getQueryParams() {
            const params = {};
            const search = window.location.search.substring(1);
            if (!search) return params;
            
            for (const part of search.split('&')) {
                const [key, value] = part.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            }
            return params;
        }
        // ğŸ¯ DÃ©tection unique du paramÃ¨tre ?signed=... dÃ¨s le chargement
(function detectSignedParamOnLoad() {
    const params = getQueryParams();
    if (params.signed) {
        console.log('ğŸ‰ ParamÃ¨tre ?signed dÃ©tectÃ© au chargement:', params.signed);
        contractJustSigned = true;
        window.contractJustSigned = true;

        // On nettoie l'URL tout de suite (sans recharger la page)
        window.history.replaceState({}, '', window.location.pathname);
    }
})();
        // VÃ©rifier si on arrive avec ?action=signup
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'signup') {
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
        }
        
        function renderLandingPage() {
            return `
                <div class="min-h-screen">
                    <header class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-yellow-400">${t('nav.brand')}</h1>
        
        <!-- Desktop Navigation -->
        <div class="hidden lg:flex items-center gap-3">
            <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                <button onclick="changeLanguage('fr')" class="text-2xl hover:scale-125 transition-transform duration-200" title="FranÃ§ais">ğŸ‡«ğŸ‡·</button>
                <button onclick="changeLanguage('en')" class="text-2xl hover:scale-125 transition-transform duration-200" title="English">ğŸ‡¬ğŸ‡§</button>
                <button onclick="changeLanguage('ar')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">ğŸ‡¦ğŸ‡ª</button>
                <button onclick="changeLanguage('ru')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ğ ÑƒÑÑĞºĞ¸Ğ¹">ğŸ‡·ğŸ‡º</button>
                <button onclick="changeLanguage('hi')" class="text-2xl hover:scale-125 transition-transform duration-200" title="à¤¹à¤¿à¤¨à¥à¤¦à¥€">ğŸ‡®ğŸ‡³</button>
                <button onclick="changeLanguage('ur')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ø§Ø±Ø¯Ùˆ">ğŸ‡µğŸ‡°</button>
                <button onclick="changeLanguage('zh')" class="text-2xl hover:scale-125 transition-transform duration-200" title="ä¸­æ–‡">ğŸ‡¨ğŸ‡³</button>
                <button onclick="changeLanguage('tl')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Tagalog">ğŸ‡µğŸ‡­</button>
            </div>
            <a href="how-it-works.html" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.how_it_works')}</a>
            <button onclick="showLogin()" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.login')}</button>
            <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition">${t('nav.signup')}</button>
        </div>
 <!-- Mobile Menu Button -->
        <button onclick="toggleMobileMenu()" class="lg:hidden text-white text-3xl">
            <span id="menuIcon">â˜°</span>
        </button>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden lg:hidden mt-4 bg-gray-800/95 backdrop-blur-md rounded-xl p-4 space-y-3">
        <div class="flex flex-wrap gap-2 justify-center pb-3 border-b border-gray-700">
            <button onclick="changeLanguage('fr')" class="text-2xl hover:scale-125 transition-transform duration-200" title="FranÃ§ais">ğŸ‡«ğŸ‡·</button>
            <button onclick="changeLanguage('en')" class="text-2xl hover:scale-125 transition-transform duration-200" title="English">ğŸ‡¬ğŸ‡§</button>
            <button onclick="changeLanguage('ar')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">ğŸ‡¦ğŸ‡ª</button>
            <button onclick="changeLanguage('ru')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ğ ÑƒÑÑĞºĞ¸Ğ¹">ğŸ‡·ğŸ‡º</button>
            <button onclick="changeLanguage('hi')" class="text-2xl hover:scale-125 transition-transform duration-200" title="à¤¹à¤¿à¤¨à¥à¤¦à¥€">ğŸ‡®ğŸ‡³</button>
            <button onclick="changeLanguage('ur')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Ø§Ø±Ø¯Ùˆ">ğŸ‡µğŸ‡°</button>
            <button onclick="changeLanguage('zh')" class="text-2xl hover:scale-125 transition-transform duration-200" title="ä¸­æ–‡">ğŸ‡¨ğŸ‡³</button>
            <button onclick="changeLanguage('tl')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Tagalog">ğŸ‡µğŸ‡­</button>
        </div>
        <a href="how-it-works.html" class="block text-center text-white hover:text-yellow-400 transition font-medium py-2">${t('nav.how_it_works')}</a>
        <button onclick="showLogin(); toggleMobileMenu();" class="w-full text-center text-white hover:text-yellow-400 transition font-medium py-2">${t('nav.login')}</button>
        <button onclick="showSignup(); toggleMobileMenu();" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">${t('nav.signup')}</button>
    </div>
</header>
                    <main class="container mx-auto px-4 py-20">
                        <div class="text-center mb-12">
                            <h2 class="text-5xl md:text-6xl font-bold mb-6">
                                ${t('hero.title')}
                            </h2>
                            <p class="text-xl text-gray-300 mb-8">
                                ${t('hero.subtitle')}
                            </p>
                            <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-8 py-4 rounded-lg transition transform hover:scale-105">
                                ${t('hero.cta_button')}
                            </button>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6 my-16">
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800&q=80" alt="Burj Khalifa Dubai" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1582672060674-bc2bd808a8b5?w=800&q=80" alt="Dubai Marina" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1518684079-3c830dcef090?w=800&q=80" alt="Dubai Skyline" class="w-full h-64 object-cover">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-8 mt-20">
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.commission_value')}</div>
                                <div class="text-gray-300">${t('stats.commission_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.support_value')}</div>
                                <div class="text-gray-300">${t('stats.support_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.timeline_value')}</div>
                                <div class="text-gray-300">${t('stats.timeline_label')}</div>
                            </div>
                        </div>
                        <div class="mt-20 bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-12">
                            <h3 class="text-3xl font-bold text-center mb-12">${t('gains.title')}</h3>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.sale_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.rental_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <footer class="bg-gray-900 bg-opacity-80 backdrop-blur-md mt-20">
                        <div class="container mx-auto px-4 py-12">
                            <div class="grid md:grid-cols-3 gap-8 mb-8">
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.navigation_title')}</h3>
                                    <ul class="space-y-2">
                                        <li><button onclick="backToHome()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.home')}</button></li>
                                        <li><a href="how-it-works.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.how_it_works')}</a></li>
                                        <li><button onclick="showLogin()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.login')}</button></li>
                                        <li><button onclick="showSignup()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.signup')}</button></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.legal_title')}</h3>
                                    <ul class="space-y-2">
                                        <li><a href="terms.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.terms')}</a></li>
                                        <li><a href="privacy.html" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.privacy')}</a></li>
                                        <li><button onclick="downloadContractTemplate()" class="text-gray-300 hover:text-yellow-400 transition">${t('common:footer.contract_template')}</button></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-yellow-400 mb-4">${t('common:footer.contact_title')}</h3>
                                    <ul class="space-y-3 text-gray-300">
                                        <li class="flex items-center gap-2">
                                            <span>ğŸ“§</span>
                                            <a href="mailto:contact@real-estate-referrer.com" class="hover:text-yellow-400 transition">${t('common:footer.email')}</a>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span>ğŸ“</span>
                                            <span>${t('common:footer.location')}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-700 pt-6 text-center text-gray-400">
                                ${t('common:footer.copyright')}
                            </div>
                        </div>
                    </footer>
                </div>
            `;
        }
        function renderAuthPage(mode) {
            let title, buttonText, linkText, linkAction;
            if (is2FAMode) {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 w-full max-w-md border border-white/20">
                            <h2 class="text-3xl font-bold mb-6 text-center">${t('auth:two_factor.title')}</h2>
                            <p class="text-center mb-6 text-gray-300">${t('auth:two_factor.description')}</p>
                            
                            <form onsubmit="handle2FASubmit(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">${t('auth:two_factor.code_label')}</label>
                                    <input 
                                        type="text" 
                                        id="code2fa"
                                        maxlength="6"
                                        pattern="[0-9]{6}"
                                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg focus:outline-none focus:border-yellow-400 text-white text-center text-2xl tracking-widest"
                                        placeholder="000000"
                                        required
                                    />
                                </div>
                                
                                <button type="submit" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold py-3 rounded-lg hover:from-yellow-500 hover:to-yellow-700 transition">
                                    ${t('auth:two_factor.verify_button')}
                                </button>
                                
                                <button type="button" onclick="resend2FACode()" class="w-full text-yellow-400 hover:text-yellow-300 transition py-2">
                                    ${t('auth:two_factor.resend_button')}
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            }
            
            if (mode === 'login') {
                title = t('auth:login_title');
                buttonText = t('auth:login_button');
                linkText = t('auth:no_account');
                linkAction = 'showSignup()';
            } else if (mode === 'signup') {
                title = t('auth:signup_title');
                buttonText = t('auth:signup_button');
                linkText = t('auth:have_account');
                linkAction = 'showLogin()';
            } else if (mode === 'reset') {
                title = t('auth:reset_title');
                buttonText = t('auth:reset_button');
                linkText = t('auth:back_to_login');
                linkAction = 'showLogin()';
            } else if (mode === 'change-password') {
                title = 'Nouveau mot de passe';
                buttonText = 'Changer le mot de passe';
                linkText = 'Retour Ã  la connexion';
                linkAction = 'showLogin()';
            }
            return `
                <div class="min-h-screen flex items-center justify-center px-4">
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 w-full max-w-md">
                        <button onclick="backToHome()" class="text-gray-400 hover:text-white mb-6 flex items-center">
                            â† ${t('auth:back_home')}
                        </button>
                        
                        <h2 class="text-3xl font-bold mb-6 text-center">${title}</h2>
                        ${mode === 'login' || mode === 'signup' ? `
                            <!-- OAuth Buttons Vercel Style -->
                            <div class="space-y-3 mb-6">
                                <button onclick="signInWithGoogle()" type="button"
                                        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-white hover:bg-gray-50 text-gray-900 rounded-lg border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span class="font-semibold">${t('auth:continue_with_google')}</span>
                                </button>
                                
                                <button onclick="signInWithApple()" type="button"
                                        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-black hover:bg-gray-900 text-white rounded-lg border-2 border-gray-800 hover:border-gray-700 transition-all">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                                    </svg>
                                    <span class="font-semibold">${t('auth:continue_with_apple')}</span>
                                </button>
                            </div>
                            
                            <!-- Separator -->
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-600"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-4 bg-gray-800 text-gray-400" data-i18n="auth:or">OR</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <form id="authForm" class="space-y-4">
                            ${mode === 'signup' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:name_label')}</label>
                                    <input 
                                        type="text" 
                                        id="name" 
                                        required 
                                        minlength="2"
                                        maxlength="100"
                                        placeholder="${t('auth:full_name_placeholder')}"
                                        class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        oninput="validateName()"
                                    >
                                    <div id="nameError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:phone_label')}</label>
                                    <div class="flex gap-2">
                                        <select 
                                            id="countryCode" 
                                            class="w-32 px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        >
                                            <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                                            <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                                            <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                                            <option value="+966">ğŸ‡¸ğŸ‡¦ +966</option>
                                            <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                                            <option value="+92">ğŸ‡µğŸ‡° +92</option>
                                            <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                                            <option value="+63">ğŸ‡µğŸ‡­ +63</option>
                                            <option value="+7">ğŸ‡·ğŸ‡º +7</option>
                                            <option value="+20">ğŸ‡ªğŸ‡¬ +20</option>
                                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                                        </select>
                                        <input 
                                            type="tel" 
                                            id="phone" 
                                            required 
                                            placeholder="${t('auth:phone_placeholder')}"
                                            class="flex-1 px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                            oninput="validatePhone()"
                                        >
                                    </div>
                                    <div class="flex items-start gap-2 bg-blue-900/30 border border-blue-500/30 rounded-lg p-3 mt-2">
                                        <span class="text-blue-400 text-lg flex-shrink-0">â„¹ï¸</span>
                                        <p class="text-xs text-blue-200" data-i18n="auth:sms_verification_notice">
${t('auth:sms_verification_notice')}
</p>
                                    </div>
                                    <div id="phoneError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                            ` : ''}
                            
                            ${mode !== 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:email_label')}</label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        required 
                                        placeholder="${t('auth:email_placeholder')}"
                                        class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none transition-colors"
                                        ${mode === 'signup' ? 'oninput="validateEmail()"' : ''}
                                    >
                                    ${mode === 'signup' ? '<div id="emailError" class="text-red-400 text-sm mt-1 hidden"></div>' : ''}
                                </div>
                            ` : ''}
                            
                            ${mode !== 'reset' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Nouveau mot de passe' : t('auth:password_label')}</label>
                                    <div class="relative">
                                        <input 
                                            type="password" 
                                            id="${mode === 'change-password' ? 'newPassword' : 'password'}" 
                                            required 
                                            minlength="8" 
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                            class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12 transition-colors"
                                            ${mode === 'signup' || mode === 'change-password' ? 'oninput="validatePassword()"' : ''}
                                        >
                                        <button 
                                            type="button" 
                                            onclick="togglePasswordVisibility('${mode === 'change-password' ? 'newPassword' : 'password'}', this)" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
                                            aria-label="Afficher/masquer le mot de passe"
                                        >
                                            <span class="text-xl">ğŸ‘ï¸</span>
                                        </button>
                                    </div>
                                    ${mode === 'signup' || mode === 'change-password' ? `
                                        <div class="mt-2">
                                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                                <div id="passwordStrength" class="flex-1 h-1.5 bg-gray-600 rounded-full overflow-hidden">
                                                    <div id="passwordStrengthBar" class="h-full w-0 transition-all duration-300"></div>
                                                </div>
                                                <span id="passwordStrengthText" class="min-w-[60px]"></span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1.5 space-y-0.5">
                                                <div id="req-length" class="flex items-center gap-1">
                                                    <span class="w-3">â€¢</span>
                                                    <span data-i18n="auth:password_req_length">${t('auth:password_req_length')}</span>
                                                </div>
                                                <div id="req-letter" class="flex items-center gap-1">
                                                    <span class="w-3">â€¢</span>
                                                    <span data-i18n="auth:password_req_letter">${t('auth:password_req_letter')}</span>
                                                </div>
                                                <div id="req-number" class="flex items-center gap-1">
                                                    <span class="w-3">â€¢</span>
                                                    <span data-i18n="auth:password_req_number">${t('auth:password_req_number')}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `<div class="text-sm text-gray-400 mt-1">${t('auth:password_hint')}</div>`}
                                    <div id="passwordError" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                            ` : ''}
                            
                            ${mode === 'signup' || mode === 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Confirmer le nouveau mot de passe' : t('auth:confirm_password_label')}</label>
                                    <div class="relative">
                                        <input 
                                            type="password" 
                                            id="${mode === 'change-password' ? 'confirmNewPassword' : 'confirmPassword'}" 
                                            required 
                                            minlength="8" 
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                            class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12 transition-colors"
                                            oninput="validateConfirmPassword()"
                                        >
                                        <button 
                                            type="button" 
                                            onclick="togglePasswordVisibility('${mode === 'change-password' ? 'confirmNewPassword' : 'confirmPassword'}', this)" 
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
                                            aria-label="Afficher/masquer la confirmation"
                                        >
                                            <span class="text-xl">ğŸ‘ï¸</span>
                                        </button>
                                    </div>
                                    <div id="confirmPasswordError" class="text-red-400 text-sm mt-1 hidden"></div>
                                    <div id="confirmPasswordSuccess" class="text-green-400 text-sm mt-1 hidden flex items-center gap-1">
                                        <span>âœ“</span>
                                        <span>Les mots de passe correspondent</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${mode === 'login' ? `
                                <div class="text-right">
                                    <button type="button" onclick="showReset()" class="text-yellow-400 hover:text-yellow-300 text-sm transition-colors">
                                        ${t('auth:forgot_password')}
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div id="authError" class="text-red-400 text-sm hidden bg-red-900/20 border border-red-500/50 rounded-lg p-3"></div>
                            
                            <button 
                                type="submit" 
                                id="submitButton"
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                ${mode === 'signup' || mode === 'change-password' ? 'disabled' : ''}
                            >
                                ${buttonText}
                            </button>
                        </form>
                        
                        <p class="text-center mt-6 text-gray-400">
                            <button onclick="${linkAction}" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                                ${linkText}
                            </button>
                        </p>
                        
                    </div>
                </div>
            `;
        }
        function renderDashboard() {
            console.log('ğŸ§­ DEBUG renderDashboard called', {
        userProfile,
        role: userProfile?.role,
        contract_path: userProfile?.contract_path,
        contract_file_url: userProfile?.contract_file_url,
        contract_status: userProfile?.contract_status,
    });
            if (!userProfile) {
                return '<div class="min-h-screen flex items-center justify-center"><div class="text-xl">â³ Chargement du profil...</div></div>';
            }
            const isAdmin = userProfile.role === 'admin';
            
            // âœ… VÃ‰RIFICATION AMÃ‰LIORÃ‰E DU CONTRAT
            const hasValidContract = userProfile.contract_path || 
                                    userProfile.contract_file_url || 
                                    userProfile.contract_status === 'signed' || 
                                    userProfile.contract_status === 'approved';
            
            console.log('ğŸ“„ Contract check:', {
                contract_path: userProfile.contract_path,
                contract_file_url: userProfile.contract_file_url,
                contract_status: userProfile.contract_status,
                hasValidContract: hasValidContract
            });
            
            const dashboardTitle = isAdmin ? t('dashboard:admin_title') : t('dashboard:referrer_title');
            return `
                <div class="min-h-screen">
                    <header class="bg-gray-800 bg-opacity-50 backdrop-blur-md">
                        <div class="container mx-auto px-4 py-4">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold text-yellow-400">${dashboardTitle}</h1>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-300">${userProfile.name}</span>
                                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">
                                        ${t('dashboard:logout')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    <main class="container mx-auto px-4 py-8">
                        ${!hasValidContract && !isAdmin ? `
    <div id="contractRequirement" class="mb-6 bg-gradient-to-r from-blue-900/50 to-yellow-900/50 border-2 border-yellow-500 p-8 rounded-xl shadow-2xl">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Contenu explicatif -->
            <div class="flex-1">
                <h3 class="text-2xl font-bold text-yellow-400 mb-4">
                    ğŸ“ ${t('dashboard:contract.required')}
                </h3>
                
                <!-- Explication dÃ©taillÃ©e -->
                <div class="bg-white/10 rounded-lg p-4 mb-6">
                    <h4 class="font-bold text-white mb-3">
                        â“ ${t('dashboard:contract.what_is_it')}
                    </h4>
                    <p class="text-gray-300 text-sm mb-3">
                        ${t('dashboard:contract.explanation')}
                    </p>
                    <ul class="space-y-2 text-sm text-gray-300 ml-4">
                        <li>âœ… <strong>${t('dashboard:contract.benefit1_title')}</strong> ${t('dashboard:contract.benefit1_desc')}</li>
                        <li>âœ… <strong>${t('dashboard:contract.benefit2_title')}</strong> ${t('dashboard:contract.benefit2_desc')}</li>
                        <li>âœ… <strong>${t('dashboard:contract.benefit3_title')}</strong> ${t('dashboard:contract.benefit3_desc')}</li>
                        <li>âœ… <strong>${t('dashboard:contract.benefit4_title')}</strong> ${t('dashboard:contract.benefit4_desc')}</li>
                        <li>âœ… <strong>${t('dashboard:contract.benefit5_title')}</strong> ${t('dashboard:contract.benefit5_desc')}</li>
                    </ul>
                </div>

                <!-- Ã‰tapes -->
                <div class="grid md:grid-cols-2 gap-8">
                   <!-- Nouvelle signature Ã©lectronique -->
<div class="bg-gradient-to-r from-green-900/30 to-blue-900/30 border-2 border-green-500/50 p-6 rounded-lg">
    <div class="flex items-center gap-3 mb-4">
        <span class="text-4xl">âœï¸</span>
        <div>
            <h4 class="font-bold text-green-300 text-lg">Signature Ã‰lectronique</h4>
            <p class="text-xs text-gray-400">Nouveau : Signez votre contrat en ligne en 2 minutes</p>
        </div>
    </div>
    
    <ul class="space-y-2 text-sm text-gray-300 mb-4">
        <li class="flex items-center gap-2">
            <span class="text-green-400">âœ“</span>
            <span>Signature au doigt ou Ã  la souris</span>
        </li>
        <li class="flex items-center gap-2">
            <span class="text-green-400">âœ“</span>
            <span>Validation instantanÃ©e</span>
        </li>
        <li class="flex items-center gap-2">
            <span class="text-green-400">âœ“</span>
            <span>LÃ©galement valide Ã  Dubai</span>
        </li>
        <li class="flex items-center gap-2">
            <span class="text-green-400">âœ“</span>
            <span>Aucun tÃ©lÃ©chargement nÃ©cessaire</span>
        </li>
    </ul>
    
    <a href="/contract-signature.html" 
       class="block w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-3 rounded-lg transition text-center">
        ğŸ–Šï¸ Signer mon contrat maintenant
    </a>
</div>
            
            </div>
        </div>
    </div>
` : ''}
                        
                        ${hasValidContract && !isAdmin ? `
                            <div id="contractUploaded" class="mb-6 bg-green-900 bg-opacity-50 border-l-4 border-green-500 p-6 rounded-lg shadow-lg">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl flex-shrink-0">âœ…</div>
                                    <div>
                                        <h3 class="text-xl font-bold text-green-300">Contrat signÃ© et validÃ©</h3>
                                        <p class="text-gray-300">Vous pouvez maintenant ajouter des leads</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="stats" class="grid md:grid-cols-4 gap-6 mb-8"></div>
                        
                        ${!isAdmin ? `
                            <div class="mb-6">
                                <button 
                                    id="addLeadBtn"
                                    onclick="showAddLeadForm()" 
                                    ${!hasValidContract ? 'disabled' : ''}
                                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg transition ${!hasValidContract ? 'opacity-50 cursor-not-allowed' : ''}"
                                >
                                    ${t('dashboard:add_lead')}
                                </button>
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6 mb-8">
                            <h2 class="text-2xl font-bold mb-4">${isAdmin ? t('dashboard:all_leads') : t('dashboard:my_leads')}</h2>
                            <div id="leadsTable" class="overflow-x-auto"></div>
                        </div>
                    </main>
                    
                    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                        <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full">
                            <h3 class="text-2xl font-bold mb-6">${t('dashboard:add_lead')}</h3>
                            <form id="addLeadForm" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_name')}</label>
                                        <input type="text" id="clientName" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_email')}</label>
                                        <input type="email" id="clientEmail" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:client_phone')}</label>
                                        <input type="tel" id="clientPhone" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:property_type')}</label>
                                        <select id="propertyType" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                            <option value="">${t('dashboard:select_type')}</option>
                                            <option value="sale_buyer">${t('dashboard:sale_buyer')}</option>
                                            <option value="sale_seller">${t('dashboard:sale_seller')}</option>
                                            <option value="rental_landlord">${t('dashboard:rental_landlord')}</option>
                                            <option value="rental_tenant">${t('dashboard:rental_tenant')}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard:budget')}</label>
                                        <input type="number" id="budget" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                        ${t('dashboard:add')}
                                    </button>
                                    <button type="button" onclick="document.getElementById('addLeadModal').classList.add('hidden')" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-lg transition">
                                        ${t('dashboard:cancel')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        function showLogin() {
            console.log('ğŸ” showLogin called');
            currentPage = 'auth-login';
            window.currentPage = 'auth-login';
            render();
        }
        function showSignup() {
            console.log('ğŸ“ showSignup called');
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
            render();
        }
        function showReset() {
            console.log('ğŸ”‘ showReset called');
            currentPage = 'auth-reset';
            window.currentPage = 'auth-reset';
            render();
        }
        function backToHome() {
            console.log('ğŸ  backToHome called');
            currentPage = 'landing';
            window.currentPage = 'landing';
            isPasswordRecoveryMode = false;
            render();
        }
        function prefillTestData() {
            if (document.getElementById('name')) {
                document.getElementById('name').value = 'Test User';
                document.getElementById('countryCode').value = '+33';
                document.getElementById('phone').value = '612345678';
                document.getElementById('email').value = 'karyne@itooki.fr';
                document.getElementById('password').value = 'Test1234';
                document.getElementById('confirmPassword').value = 'Test1234';
                validateName();
                validatePhone();
                validateEmail();
                validatePassword();
                validateConfirmPassword();
                console.log('âœ… DonnÃ©es de test prÃ©-remplies');
            }
        }

        // VÃ©rifier si un numÃ©ro de tÃ©lÃ©phone existe dÃ©jÃ 
async function checkPhoneExists(phone) {
    try {
        // Nettoyer le numÃ©ro (enlever espaces, tirets, etc.)
        const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        const { data, error } = await supabase
            .from('profiles')
            .select('id, name')
            .eq('phone', cleanPhone)
            .single();
        
        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
            console.error('Error checking phone:', error);
            return { exists: false, error: error.message };
        }
        
        return { exists: !!data, userName: data?.name };
    } catch (err) {
        console.error('Exception checking phone:', err);
        return { exists: false, error: err.message };
    }
}
        function handleAuth(mode) {
            console.log('ğŸ”§ handleAuth called for mode:', mode);
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            if (!form) {
                console.error('âŒ Form not found');
                return;
            }
            console.log('âœ… Form found, attaching handler');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                console.log('ğŸ“¤ Form submitted for', mode);
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password')?.value;
                try {
                    if (mode === 'signup') {
                        console.log('ğŸ“ Processing signup');
                        const name = document.getElementById('name').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const countryCode = document.getElementById('countryCode').value;
                        
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        
                        if (!validateName()) throw new Error('Nom invalide');
                        if (!validatePhone()) throw new Error('NumÃ©ro de tÃ©lÃ©phone invalide');
                        if (!validateEmail()) throw new Error('Email invalide');
                        if (!validatePassword()) throw new Error('Mot de passe invalide');
                        if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));
                        
                        const fullPhone = countryCode + phone;

                        // NOUVEAU : VÃ©rifier l'unicitÃ© du tÃ©lÃ©phone
                console.log('ğŸ” Checking if phone exists:', fullPhone);
                const phoneCheck = await checkPhoneExists(fullPhone);
                
                if (phoneCheck.exists) {
                    const message = `Ce numÃ©ro de tÃ©lÃ©phone est dÃ©jÃ  utilisÃ©${phoneCheck.userName ? ' par ' + phoneCheck.userName : ''}`;
                    
                    // Afficher dans errorDiv
                    if (errorDiv) {
                        errorDiv.textContent = message;
                        errorDiv.classList.remove('hidden');
                    }
                    
                    // RÃ©activer le bouton
                    const submitButton = document.getElementById('submitButton');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = t('auth:signup_button');
                    }
                    
                    console.log('âŒ Phone already exists, blocking signup');
                    return;
                }
                        
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = true;
                        submitButton.textContent = 'Inscription en cours...';
                        
                        console.log('ğŸ“¤ Signup data:', { email, name, phone: fullPhone });
                        
                        isSignupInProgress = true;
                        console.log('ğŸ”’ Signup in progress - blocking renders');
                        
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name, phone: fullPhone }
                            }
                        });
                        if (error) {
                            isSignupInProgress = false;
                            throw error;
                        }
                        
                        console.log('âœ… Signup successful, user:', data.user);
                        // âœ… Upsert du profil AVANT la dÃ©connexion (RLS OK)
const { error: upsertErr } = await supabase
  .from('profiles')
  .upsert({
    id: data.user.id,
    name, phone: fullPhone, email,
    role: 'referrer',
    contract_status: 'pending',
    phone_verified: false
  }, { onConflict: 'id' });
if (upsertErr && upsertErr.code !== '23505') {
  isSignupInProgress = false;
  throw new Error('Erreur crÃ©ation profil: ' + upsertErr.message);
}
console.log('âœ… Profile created via upsert');
                        
                        tempUserId = data.user.id;
                       
                        tempUserProfile = {
                            id: data.user.id,
                            name: name,
                            phone: fullPhone,
                            email: email,
                            role: 'referrer',
                            contract_status: 'pending',
                            phone_verified: false
                        };
                        window.tempPassword = password;
                        
                        is2FAMode = true;
                        console.log('ğŸ“± Sending 2FA code...');
                        const currentLang = i18next.language || 'fr';
                        await send2FACode(data.user.id, currentLang, fullPhone);
                        // âœ… Se dÃ©connecter seulement APRÃˆS avoir envoyÃ© le SMS
await supabase.auth.signOut();
                        
                        render();
                    } else if (mode === 'login') {
                        console.log('ğŸ” Processing login');
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        console.log('âœ… Login successful');
                    }
                } catch (error) {
                    console.error('âŒ Auth error:', error);
                    let errorMessage = error.message;
                    
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Email ou mot de passe incorrect';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Veuillez confirmer votre email avant de vous connecter';
                    } else if (error.message.includes('User already registered')) {
                        errorMessage = 'Cet email est dÃ©jÃ  utilisÃ©';
                    } else if (error.message.includes('Password should be at least')) {
                        errorMessage = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    
                    if (mode === 'signup') {
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = false;
                        submitButton.textContent = t('auth:signup_button');
                    }
                }
            };
        }
        async function handleReset() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value;
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    
                    if (error) throw error;
                    
                    alert(t('auth:reset_email_sent'));
                    showLogin();
                } catch (error) {
                    console.error('Reset error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
       async function send2FACode(userId, language = 'fr', phone = null) {
    try {
        console.log('ğŸ“± Sending 2FA code via SMS for user:', userId, 'language:', language);
        
        // 1. GÃ©nÃ©rer un code Ã  6 chiffres
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        console.log('ğŸ”¢ Generated code:', code);
        
        // 2. Hasher le code pour le stocker en base
        const encoder = new TextEncoder();
        const data = encoder.encode(code);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const codeHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        // 3. Sauvegarder le code hashÃ© dans verification_codes
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString(); // 10 minutes
        
        const { error: insertError } = await supabase
            .from('verification_codes')
            .insert([{
                user_id: userId,
                code_hash: codeHash,
                expires_at: expiresAt,
                used: false,
                attempts: 0
            }]);
        
        if (insertError) {
            console.error('âŒ Error saving verification code:', insertError);
            throw new Error('Erreur de sauvegarde du code');
        }
        
        console.log('âœ… Verification code saved to database');
        
        // 4. VÃ©rifier que le numÃ©ro de tÃ©lÃ©phone est fourni
if (!phone) {
    console.error('âŒ No phone number provided');
    throw new Error('NumÃ©ro de tÃ©lÃ©phone manquant');
}

console.log('ğŸ“ User phone:', phone);
        
        // 5. Envoyer le code via SMS (Twilio)
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-2fa-code`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({ 
    phone: phone,
    code: code
})
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            console.error('âŒ SMS send error:', result);
            throw new Error(result.error || 'Erreur envoi SMS');
        }
        
        console.log('âœ… SMS code sent successfully via Twilio');
        return true;
        
    } catch (error) {
        console.error('âŒ Erreur send2FACode:', error);
        alert('Erreur lors de l\'envoi du code de vÃ©rification. Veuillez rÃ©essayer.');
        return false;
    }
}
        async function verify2FACode(code) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(code);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const codeHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                const { data: codes, error } = await supabase
                    .from('verification_codes')
                    .select('*')
                    .eq('user_id', tempUserId)
                    .eq('code_hash', codeHash)
                    .eq('used', false)
                    .gt('expires_at', new Date().toISOString())
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (!codes || codes.length === 0) {
                    console.log('âŒ Code not found or invalid');
                    
                    const { data: currentCodes } = await supabase
                        .from('verification_codes')
                        .select('id, attempts')
                        .eq('user_id', tempUserId)
                        .eq('used', false)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (currentCodes && currentCodes.length > 0) {
                        await supabase
                            .from('verification_codes')
                            .update({ attempts: currentCodes[0].attempts + 1 })
                            .eq('id', currentCodes[0].id);
                    }
                    
                    return false;
                }
                
                const { error: markError } = await supabase
                    .from('verification_codes')
                    .update({ used: true })
                    .eq('id', codes[0].id);
                
                if (markError) throw markError;
                
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ phone_verified: true })
                    .eq('id', tempUserId);
                if (updateError) {
                    console.error('âŒ Error updating phone_verified:', updateError);
                }
                console.log('âœ… Phone marked as verified');
                console.log('âœ… 2FA code validated, reconnecting user...');
                
                if (!tempUserProfile || !tempUserProfile.email || !window.tempPassword) {
                    throw new Error('DonnÃ©es de connexion manquantes');
                }
                
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email: tempUserProfile.email,
                    password: window.tempPassword
                });
                
                if (signInError) {
                    console.error('âŒ Error signing in after 2FA:', signInError);
                    throw signInError;
                }
                
                console.log('âœ… User signed in successfully after 2FA');
                
                delete window.tempPassword;
                
                isSignupInProgress = false;
                console.log('ğŸ”“ Signup complete - unblocking renders');
                
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', signInData.user.id)
                    .single();
                
                currentUser = signInData.user;
                window.currentUser = signInData.user;
                currentPage = tempUserProfile.role === 'admin' ? 'admin' : 'referrer';
                is2FAMode = false;
                tempUserId = null;
                tempUserProfile = null;
                
                console.log('âœ… Session restored, currentUser:', currentUser);
                
                return true;
            } catch (error) {
                console.error('Erreur verify2FACode:', error);
                isSignupInProgress = false;
                return false;
            }
        }
        
        // âœ… POPUP OAUTH AVEC TRADUCTIONS COMPLÃˆTES
        function showOAuthWarning(provider) {
            const modal = document.getElementById('oauthWarningModal');
            const providerName = provider === 'google' ? 'Google' : 'Apple';
            const currentLang = i18next.language || 'fr';
            const trans = oauthTranslations[currentLang] || oauthTranslations['fr'];
            
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full border-2 border-yellow-500">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-4">âš ï¸</div>
                            <h3 class="text-2xl font-bold mb-4">${trans.security_info}</h3>
                        </div>
                        
                        <p class="text-gray-300 mb-6 leading-relaxed">
                            ${trans.redirect_message} ${providerName}.
                        </p>
                        
                        <p class="text-gray-300 mb-6">
                            <span class="text-green-400 font-semibold">âœ“ ${trans.normal_secure}</span><br>
                            ${trans.will_return}
                        </p>
                        
                        <div class="flex gap-4">
                            <button 
                                onclick="proceedWithOAuth('${provider}')" 
                                class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition"
                            >
                                ${trans.continue_btn}
                            </button>
                            <button 
                                onclick="closeOAuthWarning()" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition"
                            >
                                ${trans.cancel_btn}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        function closeOAuthWarning() {
            const modal = document.getElementById('oauthWarningModal');
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }
        async function proceedWithOAuth(provider) {
            closeOAuthWarning();
            
            try {
                console.log(`ğŸ” Starting ${provider} Sign In...`);
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                console.log(`âœ… ${provider} redirect initiated`);
            } catch (error) {
                console.error(`âŒ ${provider} Sign In error:`, error);
                alert(`Erreur lors de la connexion avec ${provider}: ` + error.message);
            }
        }
        async function signInWithGoogle() {
            showOAuthWarning('google');
        }
        async function signInWithApple() {
            showOAuthWarning('apple');
        }
        async function handle2FASubmit(event) {
            event.preventDefault();
            const code = document.getElementById('code2fa').value;
            
            const isValid = await verify2FACode(code);
            
            if (isValid) {
                render();
            } else {
                alert(t('auth:errors.invalid_2fa_code'));
            }
        }
        async function resend2FACode() {
            if (tempUserId) {
                const currentLang = i18next.language || 'fr';
                const success = await send2FACode(tempUserId, currentLang);
                if (success) {
                    alert(t('auth:two_factor.code_sent'));
                }
            }
        }
        async function handleChangePassword() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (newPassword.length < 8) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[a-zA-Z]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins une lettre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[0-9]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins un chiffre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                try {
                    console.log('ğŸ”‘ Updating password...');
                    const { error } = await supabase.auth.updateUser({ 
                        password: newPassword 
                    });
                    
                    if (error) throw error;
                    
                    console.log('âœ… Password updated successfully');
                    isPasswordRecoveryMode = false;
                    alert('âœ… Mot de passe changÃ© avec succÃ¨s !');
                    await supabase.auth.signOut();
                    showLogin();
                } catch (error) {
                    console.error('âŒ Change password error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        // âœ… FONCTION loadDashboardContent() AMÃ‰LIORÃ‰E
        async function loadDashboardContent() {
            if (!userProfile) return;
            const isAdmin = userProfile.role === 'admin';
            let leads;
            let profiles = {};
            if (isAdmin) {
                console.log('ğŸ“Š Loading leads for admin...');
                const { data: leadsData, error: leadsError } = await supabase
                    .from('leads')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (leadsError) {
                    console.error('âŒ Error loading leads:', leadsError);
                    document.getElementById('leadsTable').innerHTML = `
                        <div class="text-red-400 p-4">
                            Erreur lors du chargement des leads: ${leadsError.message}
                        </div>
                    `;
                    return;
                }
                console.log('âœ… Leads loaded:', leadsData?.length);
                console.log('ğŸ‘¥ Loading all profiles...');
                const { data: profilesData, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*');
                if (profilesError) {
                    console.error('âŒ Error loading profiles:', profilesError);
                } else {
                    console.log('âœ… Profiles loaded:', profilesData?.length);
                    profilesData.forEach(profile => {
                        profiles[profile.id] = profile;
                    });
                }
                leads = leadsData.map(lead => ({
                    ...lead,
                    referrer_name: profiles[lead.referrer_id]?.name || 'N/A'
                }));
            } else {
                console.log('ğŸ“Š Loading leads for referrer...');
                const { data, error } = await supabase
                    .from('leads')
                    .select('*')
                    .eq('referrer_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) {
                    console.error('âŒ Error loading leads:', error);
                    document.getElementById('leadsTable').innerHTML = `
                        <div class="text-red-400 p-4">
                            Erreur lors du chargement des leads: ${error.message}
                        </div>
                    `;
                    return;
                }
                console.log('âœ… Leads loaded:', data?.length);
                leads = data;
            }
            const totalEarnings = leads.filter(l => l.status === 'vendu').reduce((sum, l) => sum + (l.referrer_commission || 0), 0);
            const activeLeads = leads.filter(l => l.status !== 'vendu').length;
            const closedSales = leads.filter(l => l.status === 'vendu').length;
            document.getElementById('stats').innerHTML = `
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${leads.length}</div>
                        <div class="text-gray-300">${t('dashboard:total_referrers')}</div>
                    </div>
                ` : `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard:total_earnings')}</div>
                    </div>
                `}
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${activeLeads}</div>
                    <div class="text-gray-300">${t('dashboard:active_leads')}</div>
                </div>
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${closedSales}</div>
                    <div class="text-gray-300">${t('dashboard:closed_sales')}</div>
                </div>
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard:commissions_paid')}</div>
                    </div>
                ` : ''}
            `;
            const statusColors = {
                'nouveau': 'bg-blue-500',
                'visite': 'bg-yellow-500',
                'offre': 'bg-orange-500',
                'vendu': 'bg-green-500'
            };
            document.getElementById('leadsTable').innerHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard:referrer')}</th>` : ''}
                            <th class="text-left py-3 px-4">${t('dashboard:client_name')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:property_type')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:budget')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:status')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard:commission')}</th>
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard:actions')}</th>` : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${leads.length === 0 ? `
                            <tr>
                                <td colspan="${isAdmin ? '7' : '5'}" class="py-8 text-center text-gray-400">
                                    ${t('dashboard:no_leads')}
                                </td>
                            </tr>
                        ` : leads.map(lead => `
                            <tr class="border-b border-gray-700">
                                ${isAdmin ? `<td class="py-3 px-4">${lead.referrer_name}</td>` : ''}
                                <td class="py-3 px-4">${lead.client_name}</td>
                                <td class="py-3 px-4">${t('dashboard:' + lead.property_type)}</td>
                                <td class="py-3 px-4">${lead.budget?.toLocaleString()} AED</td>
                                <td class="py-3 px-4">
                                    ${isAdmin ? `
                                        <select onchange="updateLeadStatus(${lead.id}, this.value)" class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            <option value="nouveau" ${lead.status === 'nouveau' ? 'selected' : ''}>${t('dashboard:status_new')}</option>
                                            <option value="visite" ${lead.status === 'visite' ? 'selected' : ''}>${t('dashboard:status_visit')}</option>
                                            <option value="offre" ${lead.status === 'offre' ? 'selected' : ''}>${t('dashboard:status_offer')}</option>
                                            <option value="vendu" ${lead.status === 'vendu' ? 'selected' : ''}>${t('dashboard:status_sold')}</option>
                                        </select>
                                    ` : `
                                        <span class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            ${t('dashboard:status_' + lead.status.replace('Ã©', 'e'))}
                                        </span>
                                    `}
                                </td>
                                <td class="py-3 px-4 font-bold text-yellow-500">
                                    ${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : '-'}
                                </td>
                                ${isAdmin ? `
                                    <td class="py-3 px-4">
                                        ${lead.status !== 'vendu' ? `
                                            <button onclick="markAsSold(${lead.id})" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                                ${t('dashboard:mark_sold')}
                                            </button>
                                        ` : '-'}
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function showAddLeadForm() {
            const hasValidContract = userProfile?.contract_path || 
                                    userProfile?.contract_file_url || 
                                    userProfile?.contract_status === 'signed' || 
                                    userProfile?.contract_status === 'approved';
            
            if (!hasValidContract) {
                alert(t('dashboard:contract_required_to_add_lead') || 'Vous devez uploader votre contrat signÃ© avant d\'ajouter des leads.');
                return;
            }
            document.getElementById('addLeadModal').classList.remove('hidden');
            
            const form = document.getElementById('addLeadForm');
            form.onsubmit = async (e) => {
                e.preventDefault();
                
                const leadData = {
                    referrer_id: currentUser.id,
                    client_name: document.getElementById('clientName').value,
                    client_email: document.getElementById('clientEmail').value,
                    client_phone: document.getElementById('clientPhone').value,
                    property_type: document.getElementById('propertyType').value,
                    budget: parseFloat(document.getElementById('budget').value),
                    status: 'nouveau'
                };
                const { error } = await supabase.from('leads').insert([leadData]);
                
                if (error) {
                    console.error('Error adding lead:', error);
                    alert('Erreur lors de l\'ajout du lead');
                    return;
                }
                document.getElementById('addLeadModal').classList.add('hidden');
                form.reset();
                await loadDashboardContent();
            };
        }
        async function updateLeadStatus(leadId, newStatus) {
            const { error } = await supabase.from('leads').update({ status: newStatus }).eq('id', leadId);
            
            if (error) {
                console.error('Error updating status:', error);
                alert('Erreur lors de la mise Ã  jour du statut');
                return;
            }
            await loadDashboardContent();
        }
        async function markAsSold(leadId) {
            const salePrice = prompt('Prix de vente (AED):');
            if (!salePrice) return;
            const price = parseFloat(salePrice);
            const agentCommission = price * 0.01;
            const referrerCommission = agentCommission * 0.20;
            const { error } = await supabase.from('leads').update({
                status: 'vendu',
                sale_price: price,
                agent_commission: agentCommission,
                referrer_commission: referrerCommission,
                closed_at: new Date().toISOString()
            }).eq('id', leadId);
            if (error) {
                console.error('Error marking as sold:', error);
                alert('Erreur lors de la vente');
                return;
            }
            await loadDashboardContent();
        }
        async function loadUserProfile(user = null) {
            const targetUser = user || currentUser;
            console.log('ğŸ” loadUserProfile called for user:', targetUser?.id);

            if (!targetUser || !targetUser.id) {
                console.error('âŒ No user provided to loadUserProfile');
                return false;
            }

            try {
                console.log('ğŸ” Fetching profile from Supabase for:', targetUser.id);

                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', targetUser.id)
                    .maybeSingle();

                // ğŸ”´ Cas erreur Â« classique Â»
                if (error && error.code !== 'PGRST116') {
                    console.error('âŒ Error loading profile:', error);
                    alert('Erreur lors du chargement du profil: ' + error.message);
                    return false;
                }

                // ğŸŸ¡ Cas Â« aucune ligne trouvÃ©e Â» (data === null OU code PGRST116)
                let profile = data;
                if (!profile) {
                    console.log('ğŸ“ Profile does not exist, creating it...');
                    const { data: newProfile, error: insertError } = await supabase
                        .from('profiles')
                        .upsert([{
                            id: targetUser.id,
                            name: targetUser.user_metadata?.name || targetUser.email.split('@')[0],
                            phone: targetUser.user_metadata?.phone || '',
                            email: targetUser.email,
                            role: 'referrer',
                            contract_status: 'pending',
                            phone_verified: false
                        }], { onConflict: 'id' })
                        .select()
                        .single();

                    if (insertError) {
                        console.error('âŒ Error creating profile:', insertError);
                        alert('Erreur lors de la crÃ©ation du profil: ' + insertError.message);
                        return false;
                    }

                    profile = newProfile;
                }

                console.log('âœ… Profile data retrieved:', profile);

                if (profile && profile.contract_status) {
                    profile.contract_status = profile.contract_status.trim().replace(/\*+/g, '');
                }

                userProfile = profile;
                window.userProfile = profile;
                console.log('âœ… userProfile set:', userProfile);
                return true;

            } catch (err) {
                console.error('âŒ Exception loading profile:', err);
                alert('Exception lors du chargement du profil: ' + err.message);
                return false;
            }
        }
        window.loadUserProfile = loadUserProfile;
        async function logout() {
    console.log('ğŸšª Logout called');
    
    try {
        console.log('ğŸ”“ Signing out from Supabase...');
        
        // âœ… CORRECTION : Ne pas attendre la rÃ©ponse de signOut
        supabase.auth.signOut(); // Pas de await !
        
        // âœ… NETTOYAGE IMMÃ‰DIAT
        console.log('ğŸ§¹ Cleaning ALL session data...');
        localStorage.clear();
        sessionStorage.clear();
        
        // RÃ©initialiser les variables globales
        currentUser = null;
        userProfile = null;
        currentPage = 'landing';
        isPasswordRecoveryMode = false;
        is2FAMode = false;
        tempUserId = null;
        tempUserProfile = null;
        globalIsUploading = false;
        
        window.currentUser = null;
        window.userProfile = null;
        window.currentPage = 'landing';
        
        console.log('âœ… Local state cleaned');
        
        // âœ… REDIRECTION IMMÃ‰DIATE - Pas de setTimeout !
        console.log('ğŸ”„ Reloading page NOW...');
        window.location.href = window.location.origin;
        
    } catch (error) {
        console.error('âŒ Logout exception:', error);
        
        // MÃªme en cas d'erreur, forcer la dÃ©connexion
        console.log('ğŸš¨ Forcing logout despite error...');
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = window.location.origin;
    }
}
        async function render() {
            console.log('ğŸ¨ RENDER called');
            console.log('- currentUser:', !!currentUser);
            console.log('- userProfile:', !!userProfile);
            console.log('- currentPage:', currentPage);
            console.log('- isPasswordRecoveryMode:', isPasswordRecoveryMode);
            console.log('- is2FAMode:', is2FAMode);
            console.log('- isSignupInProgress:', isSignupInProgress);
            // ğŸ¯ Affichage du message de contrat signÃ©, basÃ© sur le flag global
            if (contractJustSigned && currentUser && userProfile) {
                console.log('ğŸ‰ Contract just signed! Reloading profile and showing confirmation (via flag global)');
                
                // On consomme le flag une seule fois
                contractJustSigned = false;
                window.contractJustSigned = false;

                // On recharge le profil pour rÃ©cupÃ©rer le contract_status Ã  jour
                try {
                    await loadUserProfile(currentUser);
                } catch (e) {
                    console.error('Erreur lors du rechargement du profil aprÃ¨s signature:', e);
                }

                // Afficher le message de confirmation
                setTimeout(() => {
                    const confirmationDiv = document.createElement('div');
                    confirmationDiv.innerHTML = `
                        <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">âœ…</span>
                                <div>
                                    <div class="font-bold">Contrat signÃ© avec succÃ¨s !</div>
                                    <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmationDiv);

                    setTimeout(() => {
                        confirmationDiv.remove();
                    }, 5000);
                }, 500);
            }
            
            const app = document.getElementById('app');
            if (is2FAMode && !userProfile) {
                console.log('ğŸ“± 2FA mode active - showing 2FA form');
                app.innerHTML = renderAuthPage('login');
                return;
            }
            if (isPasswordRecoveryMode && currentPage === 'change-password') {
                console.log('ğŸ”‘ Password recovery mode - showing change password form');
                app.innerHTML = renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
                return;
            }
            if (currentUser && userProfile) {
                console.log('âœ… User connected with profile, showing dashboard');
                currentPage = 'dashboard';
                window.currentPage = 'dashboard';
                app.innerHTML = renderDashboard();
                await loadDashboardContent();
                
                // âœ… GESTION AMÃ‰LIORÃ‰E DE L'UPLOAD DE CONTRAT
                if (userProfile.role !== 'admin') {
                    const contractForm = document.getElementById('contractForm');
                    if (contractForm) {
                        console.log('âœ… Contract form found, attaching submit handler');
                        console.log('ğŸ” DEBUG before attaching upload', { 
                    currentUser, 
                    userProfile,
                    hasCurrentUser: !!currentUser,
                    hasUserProfile: !!userProfile
                });
                        
contractForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (globalIsUploading) {
        console.log('âš ï¸ Upload already in progress, ignoring duplicate submit');
        return;
    }
    
    globalIsUploading = true;
    console.log('ğŸ“„ Starting contract upload...');
    
    const submitBtn = document.getElementById('contractSubmitBtn');
    const errorDiv = document.getElementById('uploadError');
    const progressDiv = document.getElementById('uploadProgress');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Upload en cours...';
    errorDiv.classList.add('hidden');
    progressDiv.classList.remove('hidden');
    progressDiv.textContent = 'â³ PrÃ©paration du fichier...';
    
    try {
        const fileInput = document.getElementById('contractFile');
        const file = fileInput.files[0];
        if (!file) {
            throw new Error('Veuillez sÃ©lectionner un fichier');
        }
        if (file.type !== 'application/pdf') {
            throw new Error('Seuls les fichiers PDF sont acceptÃ©s');
        }
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            throw new Error('Le fichier est trop volumineux. Taille maximum : 10MB');
        }
        console.log('ğŸ“„ File validated:', file.name, 'Size:', file.size, 'bytes');
        
        progressDiv.textContent = 'â³ TÃ©lÃ©chargement vers le serveur...';
        
        const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;
        console.log('ğŸ“„ Uploading to Storage with name:', fileName);
        
        // âœ… UTILISER L'API REST DIRECTEMENT AU LIEU DU CLIENT JS
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            throw new Error('Session expirÃ©e, veuillez vous reconnecter');
        }
        
        const uploadUrl = `${SUPABASE_URL}/storage/v1/object/contracts/${fileName}`;
        
        console.log('ğŸš€ Uploading via REST API to:', uploadUrl);
        
        const uploadResponse = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${session.access_token}`,
                'Content-Type': file.type,
                'x-upsert': 'false'
            },
            body: file
        });
        
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            console.error('âŒ Upload failed:', uploadResponse.status, errorText);
            throw new Error(`Erreur d'upload: ${uploadResponse.status} - ${errorText}`);
        }
        
        const uploadData = await uploadResponse.json();
        console.log('âœ… File uploaded successfully to Storage');
        console.log('ğŸ“ Upload response:', uploadData);
        
        progressDiv.textContent = 'â³ Mise Ã  jour de votre profil...';
        
        // âœ… MISE Ã€ JOUR DU contract_path DANS LE PROFIL
        const { error: updateError } = await supabase.from('profiles').update({
            contract_path: fileName,
            contract_status: 'signed',
            contract_file_url: fileName
        }).eq('id', currentUser.id);
        
        if (updateError) {
            console.error('âŒ Error updating profile:', updateError);
            throw new Error(`Erreur de mise Ã  jour : ${updateError.message}`);
        }
        console.log('âœ… Profile updated successfully with contract_path:', fileName);
        
        alert('âœ… Contrat uploadÃ© avec succÃ¨s !');
        await loadUserProfile();
        globalIsUploading = false;
        render();
    } catch (error) {
        console.error('âŒ Upload exception:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        progressDiv.classList.add('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        globalIsUploading = false;
    }
});
                                
                    } else {
                        console.log('â„¹ï¸ Contract form not found (contract already uploaded or admin user)');
                    }
                } else {
                    console.log('â„¹ï¸ Admin user - no contract form needed');
                }
            } else if (currentUser && !userProfile) {
        profileLoadAttempts++;
        
        if (profileLoadAttempts >= MAX_PROFILE_LOAD_ATTEMPTS) {
            console.error('âŒ Failed to load profile after max attempts');
            profileLoadAttempts = 0;
            supabase.auth.signOut();
            currentPage = 'landing';
            render();
            return;
        }
        
        console.log(`â³ User connected but no profile, waiting... (attempt ${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS})`);
        app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">â³</div><div class="text-xl text-gray-600">Chargement de votre profil... (tentative ' + profileLoadAttempts + '/' + MAX_PROFILE_LOAD_ATTEMPTS + ')</div></div></div>';
        
        setTimeout(() => {
            loadUserProfile().then(() => render());
        }, profileLoadAttempts * 1000);
        return;
            } else if (currentPage === 'auth-login') {
                console.log('ğŸ” Rendering login page');
                app.innerHTML = renderAuthPage('login');
                setTimeout(() => {
                    console.log('â±ï¸ Attempting to attach login handler');
                    handleAuth('login');
                }, 500);
            } else if (currentPage === 'auth-signup') {
                console.log('ğŸ“ Rendering signup page');
                app.innerHTML = renderAuthPage('signup');
                setTimeout(() => {
                    console.log('â±ï¸ Attempting to attach signup handler');
                    handleAuth('signup');
                }, 500);
            } else if (currentPage === 'auth-reset') {
                console.log('ğŸ”‘ Rendering reset page');
                app.innerHTML = renderAuthPage('reset');
                setTimeout(() => handleReset(), 500);
            } else if (currentPage === 'change-password') {
                console.log('ğŸ”‘ Rendering change password page');
                app.innerHTML = renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
            } else {
                console.log('ğŸ  Rendering landing page');
                app.innerHTML = renderLandingPage();
            }
        }
        function validateName() {
            const nameInput = document.getElementById('name');
            const nameError = document.getElementById('nameError');
            
            if (!nameInput || !nameError) return true;
            const name = nameInput.value.trim();
            if (name.length === 0) {
                nameError.textContent = '';
                nameError.classList.add('hidden');
                nameInput.classList.remove('border-green-500', 'border-red-500');
                return false;
            }
            if (name.length < 2) {
                nameError.textContent = 'Le nom doit contenir au moins 2 caractÃ¨res';
                nameError.classList.remove('hidden');
                nameInput.classList.add('border-red-500');
                nameInput.classList.remove('border-green-500');
                return false;
            }
            const nameRegex = /^[a-zA-ZÃ€-Ã¿\s\-']+$/;
            if (!nameRegex.test(name)) {
                nameError.textContent = 'Le nom ne peut contenir que des lettres, espaces, tirets et apostrophes';
                nameError.classList.remove('hidden');
                nameInput.classList.add('border-red-500');
                nameInput.classList.remove('border-green-500');
                return false;
            }
            nameError.textContent = '';
            nameError.classList.add('hidden');
            nameInput.classList.remove('border-red-500');
            nameInput.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function validatePhone() {
            const phoneField = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            
            if (!phoneField || !phoneError) return true;
            const phone = phoneField.value.trim();
            
            const internationalPattern = /^[0-9]{6,15}$/;
            
            if (!phone) {
                phoneError.textContent = t('auth:errors.phone_required') || 'Le numÃ©ro de tÃ©lÃ©phone est requis';
                phoneError.classList.remove('hidden');
                phoneField.classList.add('border-red-500');
                return false;
            }
            
            if (!internationalPattern.test(phone)) {
                phoneError.textContent = t('auth:errors.phone_invalid') || 'Le numÃ©ro doit contenir entre 6 et 15 chiffres';
                phoneError.classList.remove('hidden');
                phoneField.classList.add('border-red-500');
                return false;
            }
            
            phoneError.classList.add('hidden');
            phoneField.classList.remove('border-red-500');
            phoneField.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function validateEmail() {
            // Utilise le module validation.js si disponible
            if (window.VALIDATION?.validateEmail) {
                return window.VALIDATION.validateEmail();
            }
            
            // Fallback inline si module pas encore chargÃ©
            console.warn('âš ï¸ VALIDATION module pas encore chargÃ©');
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            
            if (!emailInput || !emailError) return true;
            const email = emailInput.value.trim();
            
            if (email.length === 0) {
                emailError.textContent = '';
                emailError.classList.add('hidden');
                emailInput.classList.remove('border-green-500', 'border-red-500');
                return false;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailError.textContent = "Format d'email invalide";
                emailError.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
                emailInput.classList.remove('border-green-500');
                return false;
            }
            
            emailError.textContent = '';
            emailError.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            emailInput.classList.add('border-green-500');
            if (window.checkFormValidity) window.checkFormValidity();
            return true;
        }
        
        function validatePassword() {
    // Tenter d'utiliser le module VALIDATION
    if (window.VALIDATION?.validatePassword) {
        return window.VALIDATION.validatePassword();
    }
    
    // Fallback inline si module pas encore chargÃ©
    console.warn('âš ï¸ Module VALIDATION pas encore chargÃ©, utilisation du fallback inline');
    
    const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
    const passwordError = document.getElementById('passwordError');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    const reqLength = document.getElementById('req-length');
    const reqLetter = document.getElementById('req-letter');
    const reqNumber = document.getElementById('req-number');
    
    if (!passwordInput) return true;
    const password = passwordInput.value;
    
    // Mise Ã  jour des indicateurs visuels
    if (reqLength && reqLetter && reqNumber) {
        if (password.length >= 8) {
            reqLength.classList.add('text-green-400');
            reqLength.querySelector('span:first-child').textContent = 'âœ“';
        } else {
            reqLength.classList.remove('text-green-400');
            reqLength.querySelector('span:first-child').textContent = 'â€¢';
        }

        if (/[a-zA-Z]/.test(password)) {
            reqLetter.classList.add('text-green-400');
            reqLetter.querySelector('span:first-child').textContent = 'âœ“';
        } else {
            reqLetter.classList.remove('text-green-400');
            reqLetter.querySelector('span:first-child').textContent = 'â€¢';
        }

        if (/[0-9]/.test(password)) {
            reqNumber.classList.add('text-green-400');
            reqNumber.querySelector('span:first-child').textContent = 'âœ“';
        } else {
            reqNumber.classList.remove('text-green-400');
            reqNumber.querySelector('span:first-child').textContent = 'â€¢';
        }
    }
    
    // Barre de force
    if (strengthBar && strengthText) {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;
        
        let color, text, width;
        if (password.length === 0) {
            width = 0; text = ''; color = 'bg-gray-600';
        } else if (strength <= 2) {
            width = 33; text = 'Faible'; color = 'bg-red-500';
        } else if (strength === 3) {
            width = 66; text = 'Moyen'; color = 'bg-yellow-500';
        } else {
            width = 100; text = 'Fort'; color = 'bg-green-500';
        }
        
        strengthBar.style.width = width + '%';
        strengthBar.className = `h-full transition-all duration-300 ${color}`;
        strengthText.textContent = text;
        strengthText.className = `min-w-[60px] ${color.replace('bg-', 'text-')}`;
    }
    
    if (!passwordError) return true;
    
    // âœ… VALIDATION STRICTE
    if (password.length === 0) {
        passwordError.classList.add('hidden');
        passwordInput.classList.remove('border-green-500', 'border-red-500');
        checkFormValidity();
        return false;
    }
    
    if (password.length < 8) {
        passwordError.textContent = `Minimum 8 caractÃ¨res requis (${password.length}/8)`;
        passwordError.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-green-500');
        checkFormValidity();
        return false;
    }
    
    // âœ… NOUVELLE VALIDATION : Au moins 1 minuscule
    if (!/[a-z]/.test(password)) {
        passwordError.textContent = 'Au moins une lettre minuscule requise (a-z)';
        passwordError.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-green-500');
        checkFormValidity();
        return false;
    }
    
    // âœ… NOUVELLE VALIDATION : Au moins 1 majuscule
    if (!/[A-Z]/.test(password)) {
        passwordError.textContent = 'Au moins une lettre majuscule requise (A-Z)';
        passwordError.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-green-500');
        checkFormValidity();
        return false;
    }
    
    // âœ… VALIDATION : Au moins 1 chiffre
    if (!/[0-9]/.test(password)) {
        passwordError.textContent = 'Au moins un chiffre requis (0-9)';
        passwordError.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-green-500');
        checkFormValidity();
        return false;
    }
    
    // âœ… NOUVELLE VALIDATION : Au moins 1 caractÃ¨re spÃ©cial
    if (!/[^a-zA-Z0-9]/.test(password)) {
        passwordError.textContent = 'Au moins un caractÃ¨re spÃ©cial requis (!@#$%^&*...)';
        passwordError.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-green-500');
        checkFormValidity();
        return false;
    }
    
    // âœ… Tout est valide
    passwordError.classList.add('hidden');
    passwordInput.classList.remove('border-red-500');
    passwordInput.classList.add('border-green-500');
    
    const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
    if (confirmPasswordInput && confirmPasswordInput.value.length > 0) {
        validateConfirmPassword();
    }
    
    checkFormValidity();
    return true;
}
        function validateConfirmPassword() {
            const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const confirmPasswordSuccess = document.getElementById('confirmPasswordSuccess');
            if (!passwordInput || !confirmPasswordInput || !confirmPasswordError || !confirmPasswordSuccess) return true;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            if (confirmPassword.length === 0) {
                confirmPasswordError.classList.add('hidden');
                confirmPasswordSuccess.classList.add('hidden');
                confirmPasswordInput.classList.remove('border-green-500', 'border-red-500');
                checkFormValidity();
                return false;
            }
            if (password !== confirmPassword) {
                confirmPasswordError.textContent = 'Les mots de passe ne correspondent pas';
                confirmPasswordError.classList.remove('hidden');
                confirmPasswordSuccess.classList.add('hidden');
                confirmPasswordInput.classList.add('border-red-500');
                confirmPasswordInput.classList.remove('border-green-500');
                checkFormValidity();
                return false;
            }
            confirmPasswordError.classList.add('hidden');
            confirmPasswordSuccess.classList.remove('hidden');
            confirmPasswordInput.classList.remove('border-red-500');
            confirmPasswordInput.classList.add('border-green-500');
            checkFormValidity();
            return true;
        }
        function checkFormValidity() {
            const submitButton = document.getElementById('submitButton');
            if (!submitButton) return;
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password') || document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword') || document.getElementById('confirmNewPassword');
            const nameValid = !nameInput || nameInput.value.trim().length >= 2;
            const emailValid = !emailInput || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
            let phoneValid = !phoneInput;
            if (phoneInput) {
                const phone = phoneInput.value.trim();
                phoneValid = /^[0-9]{6,15}$/.test(phone);
            }
            let passwordValid = false;
            if (passwordInput) {
                const pwd = passwordInput.value;
                passwordValid = pwd.length >= 8 && /[a-zA-Z]/.test(pwd) && /[0-9]/.test(pwd);
            }
            const confirmPasswordValid = !confirmPasswordInput || 
                                        (confirmPasswordInput.value.length > 0 && 
                                         confirmPasswordInput.value === passwordInput?.value);
            const allValid = nameValid && phoneValid && emailValid && passwordValid && confirmPasswordValid;
            if (allValid) {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            if (field.type === 'password') {
                field.type = 'text';
                button.innerHTML = '<span class="text-xl">ğŸ™ˆ</span>';
            } else {
                field.type = 'password';
                button.innerHTML = '<span class="text-xl">ğŸ‘ï¸</span>';
            }
        }
        async function downloadContractTemplate() {
            try {
                console.log('ğŸ“¥ Downloading contract template...');
                const { data, error } = await supabase.storage
                    .from('contracts')
                    .getPublicUrl('contract_template_en.pdf');
                if (error) {
                    console.error('âŒ Error getting template URL:', error);
                    alert('Error downloading contract. Please contact support.');
                    return;
                }
                console.log('âœ… Template URL:', data.publicUrl);
                window.open(data.publicUrl, '_blank');
            } catch (error) {
                console.error('âŒ Exception downloading template:', error);
                alert('Error downloading: ' + error.message);
            }
        }
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.showReset = showReset;
        window.logout = logout;
        window.backToHome = backToHome;
        window.showAddLeadForm = showAddLeadForm;
        window.updateLeadStatus = updateLeadStatus;
        window.markAsSold = markAsSold;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.validateName = validateName;
        window.validatePhone = validatePhone;
        window.validateEmail = validateEmail;
        window.validatePassword = validatePassword;
        window.validateConfirmPassword = validateConfirmPassword;
        window.checkFormValidity = checkFormValidity;
        window.prefillTestData = prefillTestData;
        window.render = render;
        window.handleChangePassword = handleChangePassword;
        window.downloadContractTemplate = downloadContractTemplate;
        window.handle2FASubmit = handle2FASubmit;
        window.resend2FACode = resend2FACode;
        window.signInWithGoogle = signInWithGoogle;
        window.signInWithApple = signInWithApple;
        window.showOAuthWarning = showOAuthWarning;
        window.closeOAuthWarning = closeOAuthWarning;
        window.proceedWithOAuth = proceedWithOAuth;
        // Mobile menu toggle - utilise le module utils.js
        window.toggleMobileMenu = () => {
            if (window.UTILS?.toggleMobileMenu) {
                window.UTILS.toggleMobileMenu();
            } else {
                console.warn('âš ï¸ UTILS pas encore chargÃ©, fonction inline temporaire');
                const menu = document.getElementById('mobileMenu');
                const icon = document.getElementById('menuIcon');
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                    icon.textContent = 'âœ•';
                } else {
                    menu.classList.add('hidden');
                    icon.textContent = 'â˜°';
                }
            }
        };
        console.log('â³ Displaying initial loader');
        document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">â³</div><div class="text-xl">Chargement...</div></div></div>';
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('ğŸ”” Auth state changed:', event);
            if (isSignupInProgress && event !== 'SIGNED_IN') {
                console.log('âš ï¸ Ignoring event during signup process:', event);
                return;
            }
            if (event === 'PASSWORD_RECOVERY') {
                console.log('ğŸ”‘ Password recovery detected - blocking auto-login');
                isPasswordRecoveryMode = true;
                currentPage = 'change-password';
                window.currentPage = 'change-password';
                currentUser = session?.user || null;
                window.currentUser = currentUser;
                render();
                return;
            }
            if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') {
                console.log('âš ï¸ Ignoring event during password recovery:', event);
                return;
            }
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('âš ï¸ Email not confirmed, signing out');
                await supabase.auth.signOut();
                currentUser = null;
                window.currentUser = null;
            }
            if (currentUser) {
                console.log('ğŸ‘¤ User authenticated, loading profile...');
                
                // âš¡ CHARGEMENT NON BLOQUANT DU PROFIL
                loadUserProfile(currentUser).then(profileLoaded => {
                    if (!profileLoaded) {
                        console.error('âŒ Failed to load profile, signing out');
                        supabase.auth.signOut();
                        currentUser = null;
                        window.currentUser = null;
                        userProfile = null;
                        window.userProfile = null;
                    }
                    // Re-render une fois le profil chargÃ©
                    render();
                }).catch(err => {
                    console.error('âŒ Exception loading profile:', err);
                    render();
                });
            }
            
            // âœ… RENDER() IMMÃ‰DIAT - Ne pas attendre le profil !
            render();
        });
       console.log('ğŸ” Getting initial session...');
        
        // âš¡ APPEL NON BLOQUANT + RENDER() IMMÃ‰DIAT
        supabase.auth.getSession().then(async ({ data: { session }, error }) => {
            if (error) {
                console.error('âŒ Session error:', error);
                currentUser = null;
                window.currentUser = null;
                render();
                return;
            }

            currentUser = session?.user || null;
            window.currentUser = currentUser;

            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('âš ï¸ Email not confirmed on init, cleaning session');
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                currentUser = null;
                window.currentUser = null;
                render();
                return;
            }

            if (currentUser) {
                console.log('ğŸ‘¤ Session found, loading profile...');
                const profileLoaded = await loadUserProfile(currentUser);

                if (!profileLoaded) {
                    console.error('âŒ Failed to load profile on init, signing out');
                    await supabase.auth.signOut();
                    localStorage.clear();
                    sessionStorage.clear();
                    currentUser = null;
                    window.currentUser = null;
                    userProfile = null;
                    window.userProfile = null;
                }
            }

            // ğŸ”„ Re-render une fois la session/profil chargÃ©
            render();
        });

        // âœ… RENDER() IMMÃ‰DIAT - Ne plus attendre Supabase !
        render();
     
       // âš¡ Affichage du message de confirmation aprÃ¨s signature
        setTimeout(() => {
            if (window.contractJustSigned && currentUser && userProfile) {
                const confirmationDiv = document.createElement('div');
                confirmationDiv.innerHTML = `
                    <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âœ…</span>
                            <div>
                                <div class="font-bold">Contrat signÃ© avec succÃ¨s !</div>
                                <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationDiv);
                setTimeout(() => confirmationDiv.remove(), 5000);
                window.contractJustSigned = false;
            }
        }, 2000);
        // ============================================
    // ğŸ¯ IMPORTS DES MODULES (test progressif)
    // ============================================
    
    console.log('ğŸ“¦ Chargement des modules...');
    
    import('./js/config.js').then(config => {
        console.log('âœ… config.js chargÃ©', config.SUPABASE_URL);
        window.CONFIG = config;
    }).catch(err => console.error('âŒ Erreur config.js:', err));
    
    import('./js/utils.js').then(utils => {
        console.log('âœ… utils.js chargÃ©');
        window.UTILS = utils;
    }).catch(err => console.error('âŒ Erreur utils.js:', err));
    
    import('./js/validation.js').then(validation => {
        console.log('âœ… validation.js chargÃ©');
        window.VALIDATION = validation;
    }).catch(err => console.error('âŒ Erreur validation.js:', err));
    
    console.log('ğŸ“¦ Modules importÃ©s (mode test)');
    })();
    </script>
</body>
</html>
