<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Estate Referrer - Gagnez avec l'immobilier à Dubai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body class="text-white">
  <div id="app"></div>

  <script type="module">
    import { createClient } from '@supabase/supabase-js';

    const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentProfile = null;
    let isPasswordRecovery = false;

    // Check URL for recovery token
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    if (hashParams.get('type') === 'recovery') {
      isPasswordRecovery = true;
    }

    // Check for password recovery
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY') {
        isPasswordRecovery = true;
        showUpdatePasswordPage();
      } else if (event === 'SIGNED_IN' && !isPasswordRecovery) {
        if (session) {
          currentUser = session.user;
          loadProfile();
        }
      }
    });

    // Check session on load
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (isPasswordRecovery) {
        showUpdatePasswordPage();
      } else if (session) {
        currentUser = session.user;
        loadProfile();
      } else {
        showLanding();
      }
    });

    async function loadProfile() {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        currentProfile = data;
        
        if (data.role === 'admin') {
          showAdminDashboard();
        } else {
          showReferrerDashboard();
        }
      } catch (error) {
        console.error('Erreur chargement profil:', error);
        alert('Erreur chargement profil');
      }
    }

    // Form Navigation
    function showLogin() {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const resetForm = document.getElementById('resetForm');
      const formTitle = document.getElementById('formTitle');
      
      if (loginForm) loginForm.classList.remove('hidden');
      if (signupForm) signupForm.classList.add('hidden');
      if (resetForm) resetForm.classList.add('hidden');
      if (formTitle) formTitle.textContent = 'Connexion';
    }

    function showSignup() {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const resetForm = document.getElementById('resetForm');
      const formTitle = document.getElementById('formTitle');
      
      if (loginForm) loginForm.classList.add('hidden');
      if (signupForm) signupForm.classList.remove('hidden');
      if (resetForm) resetForm.classList.add('hidden');
      if (formTitle) formTitle.textContent = 'Devenir Apporteur';
    }

    function showReset() {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const resetForm = document.getElementById('resetForm');
      const formTitle = document.getElementById('formTitle');
      
      if (loginForm) loginForm.classList.add('hidden');
      if (signupForm) signupForm.classList.add('hidden');
      if (resetForm) resetForm.classList.remove('hidden');
      if (formTitle) formTitle.textContent = 'Réinitialiser le mot de passe';
    }

    // Handler functions (GLOBAL)
    window.handleLogin = async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        currentUser = data.user;
        await loadProfile();
        
      } catch (error) {
        console.error('Erreur connexion:', error);
        alert('Email ou mot de passe incorrect');
      }
    };

    window.handleSignup = async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const phone = document.getElementById('signupPhone').value.trim();
      const password = document.getElementById('signupPassword').value;
      const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

      if (password !== passwordConfirm) {
        alert('Les mots de passe ne correspondent pas !');
        return;
      }

      if (password.length < 6) {
        alert('Le mot de passe doit contenir au moins 6 caractères !');
        return;
      }

      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: {
              name,
              phone,
              role: 'referrer'
            }
          }
        });

        if (error) throw error;

        alert('Compte créé avec succès ! Vérifiez votre email pour confirmer votre compte.');
        showLogin();
        
      } catch (error) {
        console.error('Erreur inscription:', error);
        alert('Erreur lors de l\'inscription: ' + error.message);
      }
    };

    window.handleReset = async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('resetEmail').value.trim();

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://real-estate-referrer-3kp6.vercel.app'
        });

        if (error) throw error;

        alert('Email de réinitialisation envoyé ! Vérifiez votre boîte de réception.');
        showLogin();
        
      } catch (error) {
        console.error('Erreur reset:', error);
        alert('Erreur: ' + error.message);
      }
    };

    window.handleUpdatePassword = async function(e) {
      e.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas !');
        return;
      }

      if (newPassword.length < 6) {
        alert('Le mot de passe doit contenir au moins 6 caractères !');
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;

        alert('Mot de passe mis à jour avec succès ! Veuillez vous reconnecter avec votre nouveau mot de passe.');
        
        await supabase.auth.signOut();
        
        isPasswordRecovery = false;
        currentUser = null;
        currentProfile = null;
        
        showAuthPage('login');
        
      } catch (error) {
        console.error('Erreur mise à jour mot de passe:', error);
        alert('Erreur: ' + error.message);
      }
    };

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      showLanding();
    }

    function showLanding() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-gray-900 bg-opacity-50 backdrop-blur-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                  <h1 class="text-2xl font-bold text-yellow-500">Dubai Real Estate</h1>
                </div>
                <div class="flex gap-4">
                  <button onclick="showAuthPage('login')" class="text-white hover:text-yellow-500 px-4 py-2 transition">
                    Connexion
                  </button>
                  <button onclick="showAuthPage('signup')" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition">
                    Devenir Apporteur
                  </button>
                </div>
              </div>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
            <div class="text-center">
              <h2 class="text-5xl md:text-6xl font-bold mb-6">
                Gagnez jusqu'à <span class="text-yellow-500">20,000 AED</span> par vente
              </h2>
              <p class="text-xl text-gray-300 mb-12 max-w-3xl mx-auto">
                Devenez apporteur d'affaires et touchez une commission de 20% sur chaque vente immobilière que vous amenez
              </p>
              <button onclick="showAuthPage('signup')" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-8 py-4 rounded-lg transition transform hover:scale-105">
                Commencer maintenant
              </button>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-20">
              <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                <div class="text-4xl font-bold text-yellow-500 mb-2">20%</div>
                <div class="text-gray-300">Commission par vente</div>
              </div>
              <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                <div class="text-4xl font-bold text-yellow-500 mb-2">24/7</div>
                <div class="text-gray-300">Support disponible</div>
              </div>
              <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                <div class="text-4xl font-bold text-yellow-500 mb-2">48h</div>
                <div class="text-gray-300">Paiement rapide</div>
              </div>
            </div>

            <div class="mt-20">
              <h3 class="text-3xl font-bold text-center mb-12">Exemples de gains</h3>
              <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6 text-gray-900">
                  <div class="text-sm font-medium mb-2">Vente à 3M AED</div>
                  <div class="text-3xl font-bold mb-2">6,000 AED</div>
                  <div class="text-sm">Votre commission</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6 text-gray-900">
                  <div class="text-sm font-medium mb-2">Vente à 5M AED</div>
                  <div class="text-3xl font-bold mb-2">10,000 AED</div>
                  <div class="text-sm">Votre commission</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6 text-gray-900">
                  <div class="text-sm font-medium mb-2">Vente à 10M AED</div>
                  <div class="text-3xl font-bold mb-2">20,000 AED</div>
                  <div class="text-sm">Votre commission</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showAuthPage(type) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center px-4">
          <div class="max-w-md w-full bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-2xl p-8">
            <h2 id="formTitle" class="text-3xl font-bold mb-8 text-center text-yellow-500">
              ${type === 'login' ? 'Connexion' : 'Devenir Apporteur'}
            </h2>

            <form id="loginForm" class="space-y-6 ${type === 'login' ? '' : 'hidden'}">
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                <input type="email" id="loginEmail" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Mot de passe</label>
                <input type="password" id="loginPassword" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <div class="text-right">
                <a href="#" class="text-sm text-yellow-500 hover:underline" onclick="showReset(); return false;">Mot de passe oublié ?</a>
              </div>
              <button type="submit"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300">
                Se connecter
              </button>
              <p class="text-center text-gray-400">
                Pas encore inscrit ? <a href="#" class="text-yellow-500 hover:underline" onclick="showSignup(); return false;">Créer un compte</a>
              </p>
            </form>

            <form id="signupForm" class="space-y-6 ${type === 'signup' ? '' : 'hidden'}">
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Nom complet</label>
                <input type="text" id="signupName" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                <input type="email" id="signupEmail" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Téléphone</label>
                <input type="tel" id="signupPhone" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Mot de passe</label>
                <input type="password" id="signupPassword" required minlength="6"
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                <p class="text-xs text-gray-400 mt-1">Minimum 6 caractères</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Confirmer le mot de passe</label>
                <input type="password" id="signupPasswordConfirm" required minlength="6"
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <button type="submit"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300">
                Créer mon compte
              </button>
              <p class="text-center text-gray-400">
                Déjà inscrit ? <a href="#" class="text-yellow-500 hover:underline" onclick="showLogin(); return false;">Connexion</a>
              </p>
            </form>

            <form id="resetForm" class="space-y-6 hidden">
              <div class="text-center mb-6">
                <p class="text-gray-300">Entrez votre email pour recevoir un lien de réinitialisation</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                <input type="email" id="resetEmail" required
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <button type="submit"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300">
                Envoyer le lien
              </button>
              <p class="text-center text-gray-400">
                <a href="#" class="text-yellow-500 hover:underline" onclick="showLogin(); return false;">Retour à la connexion</a>
              </p>
            </form>
          </div>
        </div>
      `;
      
      const loginForm = document.getElementById('loginForm');
      if (loginForm) loginForm.onsubmit = window.handleLogin;

      const signupForm = document.getElementById('signupForm');
      if (signupForm) signupForm.onsubmit = window.handleSignup;

      const resetForm = document.getElementById('resetForm');
      if (resetForm) resetForm.onsubmit = window.handleReset;
    }

    function showUpdatePasswordPage() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center px-4">
          <div class="max-w-md w-full bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl shadow-2xl p-8">
            <h2 class="text-3xl font-bold mb-8 text-center text-yellow-500">
              Nouveau mot de passe
            </h2>

            <form id="updatePasswordForm" class="space-y-6">
              <div class="text-center mb-6">
                <p class="text-gray-300">Entrez votre nouveau mot de passe</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Nouveau mot de passe</label>
                <input type="password" id="newPassword" required minlength="6"
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                <p class="text-xs text-gray-400 mt-1">Minimum 6 caractères</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-200 mb-2">Confirmer le mot de passe</label>
                <input type="password" id="confirmPassword" required minlength="6"
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              </div>
              <button type="submit"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300">
                Mettre à jour le mot de passe
              </button>
            </form>
          </div>
        </div>
      `;

      const updatePasswordForm = document.getElementById('updatePasswordForm');
      if (updatePasswordForm) {
        updatePasswordForm.onsubmit = window.handleUpdatePassword;
      }
    }

    function showReferrerDashboard() {
      loadReferrerLeads();
    }

    async function loadReferrerLeads() {
      const { data: leads, error } = await supabase
        .from('leads')
        .select('*')
        .eq('referrer_id', currentUser.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erreur chargement leads:', error);
        return;
      }

      const stats = {
        total: leads.reduce((sum, lead) => sum + (lead.referrer_commission || 0), 0),
        active: leads.filter(l => l.status !== 'vendu').length,
        sold: leads.filter(l => l.status === 'vendu').length
      };

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-gray-900">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-yellow-500">Dashboard Apporteur</h1>
                <div class="flex items-center gap-4">
                  <span class="text-gray-300">${currentProfile.name}</span>
                  <button onclick="logout()" class="text-gray-300 hover:text-white">Déconnexion</button>
                </div>
              </div>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Gains totaux</div>
                <div class="text-3xl font-bold text-yellow-500">${stats.total.toLocaleString()} AED</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Leads en cours</div>
                <div class="text-3xl font-bold text-blue-400">${stats.active}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Ventes conclues</div>
                <div class="text-3xl font-bold text-green-400">${stats.sold}</div>
              </div>
            </div>

            <div class="mb-6">
              <button onclick="showAddLeadForm()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg transition">
                + Ajouter un lead
              </button>
            </div>

            <div class="bg-gray-800 rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Client</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Type</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Budget</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Commission</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700">
                    ${leads.map(lead => `
                      <tr class="hover:bg-gray-700">
                        <td class="px-6 py-4">
                          <div class="font-medium text-white">${lead.client_name}</div>
                          <div class="text-sm text-gray-400">${lead.client_email}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-300">${lead.property_type}</td>
                        <td class="px-6 py-4 text-gray-300">${lead.budget.toLocaleString()} AED</td>
                        <td class="px-6 py-4">
                          <span class="px-3 py-1 rounded-full text-xs font-medium
                            ${lead.status === 'nouveau' ? 'bg-blue-900 text-blue-300' : ''}
                            ${lead.status === 'visite' ? 'bg-yellow-900 text-yellow-300' : ''}
                            ${lead.status === 'offre' ? 'bg-orange-900 text-orange-300' : ''}
                            ${lead.status === 'vendu' ? 'bg-green-900 text-green-300' : ''}">
                            ${lead.status}
                          </span>
                        </td>
                        <td class="px-6 py-4 font-medium text-yellow-500">
                          ${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : '-'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showAddLeadForm() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full">
          <h3 class="text-2xl font-bold text-yellow-500 mb-6">Ajouter un lead</h3>
          <form id="addLeadForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Nom du client</label>
              <input type="text" id="leadClientName" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
              <input type="email" id="leadClientEmail" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Téléphone</label>
              <input type="tel" id="leadClientPhone" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Type de propriété</label>
              <select id="leadPropertyType" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <option value="">Sélectionner...</option>
                <option value="Appartement">Appartement</option>
                <option value="Villa">Villa</option>
                <option value="Penthouse">Penthouse</option>
                <option value="Studio">Studio</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Budget (AED)</label>
              <input type="number" id="leadBudget" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div class="flex gap-4 mt-6">
              <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg">
                Ajouter
              </button>
              <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                Annuler
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const leadData = {
          referrer_id: currentUser.id,
          client_name: document.getElementById('leadClientName').value,
          client_email: document.getElementById('leadClientEmail').value,
          client_phone: document.getElementById('leadClientPhone').value,
          property_type: document.getElementById('leadPropertyType').value,
          budget: parseFloat(document.getElementById('leadBudget').value),
          status: 'nouveau'
        };

        const { error } = await supabase.from('leads').insert([leadData]);

        if (error) {
          alert('Erreur lors de l\'ajout du lead');
          console.error(error);
        } else {
          modal.remove();
          loadReferrerLeads();
        }
      });
    }

    async function showAdminDashboard() {
      // SOLUTION SIMPLE : Utiliser une jointure SQL directe
      const { data: leadsWithReferrers, error } = await supabase
        .from('leads')
        .select(`
          *,
          referrer:profiles!leads_referrer_id_fkey(name)
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erreur:', error);
        return;
      }

      // Récupérer les profils pour les stats
      const { data: profiles } = await supabase.from('profiles').select('*');
      
      const referrers = profiles ? profiles.filter(p => p.role === 'referrer') : [];
      const activeLeads = leadsWithReferrers ? leadsWithReferrers.filter(l => l.status !== 'vendu').length : 0;
      const sales = leadsWithReferrers ? leadsWithReferrers.filter(l => l.status === 'vendu').length : 0;
      const totalCommissions = leadsWithReferrers ? leadsWithReferrers.reduce((sum, l) => sum + (l.referrer_commission || 0), 0) : 0;

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-gray-900">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-yellow-500">Admin Dashboard</h1>
                <div class="flex items-center gap-4">
                  <span class="text-gray-300">${currentProfile.name}</span>
                  <button onclick="logout()" class="text-gray-300 hover:text-white">Déconnexion</button>
                </div>
              </div>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid md:grid-cols-4 gap-6 mb-8">
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Apporteurs</div>
                <div class="text-3xl font-bold text-blue-400">${referrers.length}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Leads actifs</div>
                <div class="text-3xl font-bold text-yellow-500">${activeLeads}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Ventes</div>
                <div class="text-3xl font-bold text-green-400">${sales}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400 mb-1">Commissions</div>
                <div class="text-3xl font-bold text-yellow-500">${totalCommissions.toLocaleString()} AED</div>
              </div>
            </div>

            <div class="bg-gray-800 rounded-xl overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">Tous les leads</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Apporteur</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Client</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Type</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Budget</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700">
                    ${leadsWithReferrers && leadsWithReferrers.length > 0 ? leadsWithReferrers.map(lead => `
                      <tr class="hover:bg-gray-700">
                        <td class="px-6 py-4 text-gray-300">${lead.referrer ? lead.referrer.name : 'N/A'}</td>
                        <td class="px-6 py-4">
                          <div class="font-medium text-white">${lead.client_name}</div>
                          <div class="text-sm text-gray-400">${lead.client_phone}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-300">${lead.property_type}</td>
                        <td class="px-6 py-4 text-gray-300">${lead.budget.toLocaleString()} AED</td>
                        <td class="px-6 py-4">
                          <select onchange="updateLeadStatus(${lead.id}, this.value)" class="px-3 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                            <option value="nouveau" ${lead.status === 'nouveau' ? 'selected' : ''}>Nouveau</option>
                            <option value="visite" ${lead.status === 'visite' ? 'selected' : ''}>Visite</option>
                            <option value="offre" ${lead.status === 'offre' ? 'selected' : ''}>Offre</option>
                            <option value="vendu" ${lead.status === 'vendu' ? 'selected' : ''}>Vendu</option>
                          </select>
                        </td>
                        <td class="px-6 py-4">
                          ${lead.status === 'vendu' ? `<span class="text-green-400 text-sm">${lead.referrer_commission?.toLocaleString() || 0} AED</span>` : 
                            `<button onclick="markAsSold(${lead.id})" class="text-yellow-500 hover:text-yellow-400 text-sm">Marquer vendu</button>`}
                        </td>
                      </tr>
                    `).join('') : '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">Aucun lead</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function updateLeadStatus(leadId, newStatus) {
      const { error } = await supabase
        .from('leads')
        .update({ status: newStatus })
        .eq('id', leadId);

      if (error) {
        alert('Erreur lors de la mise à jour');
        console.error(error);
      }
    }

    async function markAsSold(leadId) {
      const salePrice = prompt('Prix de vente (AED):');
      if (!salePrice) return;

      const price = parseFloat(salePrice);
      const totalCommission = price * 0.02;
      const agentCommission = totalCommission * 0.5;
      const referrerCommission = agentCommission * 0.2;

      const { error } = await supabase
        .from('leads')
        .update({
          status: 'vendu',
          sale_price: price,
          agent_commission: agentCommission,
          referrer_commission: referrerCommission,
          closed_at: new Date().toISOString()
        })
        .eq('id', leadId);

      if (error) {
        alert('Erreur lors de la mise à jour');
        console.error(error);
      } else {
        showAdminDashboard();
      }
    }

    window.showAuthPage = showAuthPage;
    window.showLogin = showLogin;
    window.showSignup = showSignup;
    window.showReset = showReset;
    window.logout = logout;
    window.showAddLeadForm = showAddLeadForm;
    window.updateLeadStatus = updateLeadStatus;
    window.markAsSold = markAsSold;
  </script>
</body>
</html>
