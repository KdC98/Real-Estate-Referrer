<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/js/config.js';
    import * as VALIDATION from '/js/validation.js';
    window.VALIDATION = VALIDATION;
    import * as UTILS from '/js/utils.js';
    import * as AUTH from '/js/auth.js';
    import * as DASHBOARD from '/js/dashboard.js';
    import * as LEADS from '/js/leads.js';
    import * as TFA from './js/2fa.js';
    import * as RENDERING from './js/rendering.js';
    
    (async () => {
        await i18next
            .use(i18nextHttpBackend)
            .use(i18nextBrowserLanguageDetector)
            .init({
                fallbackLng: 'fr',
                debug: true,
                load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'],
                defaultNS: 'translation',
                backend: {
                    loadPath: '/locales/{{lng}}/{{ns}}.json'
                },
                detection: {
                    order: ['localStorage', 'navigator'],
                    caches: ['localStorage']
                }
            });
        console.log('ğŸŒ Loading translations...');
        await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
        console.log('âœ… All translations loaded!');
        const t = (key) => i18next.t(key);
        
        async function changeLanguage(langCode) {
            try {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            } catch (error) {
                console.error('Erreur changement de langue:', error);
            }
        }
        window.changeLanguage = changeLanguage;
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
        window.SUPABASE_URL = SUPABASE_URL;
        window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;
        
        // âœ… TRADUCTIONS OAUTH (8 LANGUES)
        const oauthTranslations = {
            fr: {
                security_info: "Information de sÃ©curitÃ©",
                redirect_message: "Vous allez Ãªtre redirigÃ© vers notre service d'authentification sÃ©curisÃ© <strong>(Supabase)</strong> pour vous connecter avec",
                normal_secure: "C'est normal et sÃ©curisÃ©.",
                will_return: "Vous reviendrez automatiquement sur notre site aprÃ¨s connexion.",
                continue_btn: "Continuer",
                cancel_btn: "Annuler"
            },
            en: {
                security_info: "Security Information",
                redirect_message: "You will be redirected to our secure authentication service <strong>(Supabase)</strong> to sign in with",
                normal_secure: "This is normal and secure.",
                will_return: "You will automatically return to our site after signing in.",
                continue_btn: "Continue",
                cancel_btn: "Cancel"
            },
            ar: {
                security_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†",
                redirect_message: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© <strong>(Supabase)</strong> Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…",
                normal_secure: "Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ¢Ù…Ù†.",
                will_return: "Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
                continue_btn: "Ù…ØªØ§Ø¨Ø¹Ø©",
                cancel_btn: "Ø¥Ù„ØºØ§Ø¡"
            },
            ru: {
                security_info: "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
                redirect_message: "Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° Ğ½Ğ°ÑˆÑƒ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½ÑƒÑ ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ <strong>(Supabase)</strong> Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ·",
                normal_secure: "Ğ­Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.",
                will_return: "Ğ’Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²ĞµÑ€Ğ½ĞµÑ‚ĞµÑÑŒ Ğ½Ğ° Ğ½Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°.",
                continue_btn: "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ",
                cancel_btn: "ĞÑ‚Ğ¼ĞµĞ½Ğ°"
            },
            hi: {
                security_info: "à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€",
                redirect_message: "à¤†à¤ªà¤•à¥‹ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤ªà¥à¤°à¤®à¤¾à¤£à¥€à¤•à¤°à¤£ à¤¸à¥‡à¤µà¤¾ <strong>(Supabase)</strong> à¤ªà¤° à¤ªà¥à¤¨à¤°à¥à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾à¤à¤—à¤¾",
                normal_secure: "à¤¯à¤¹ à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤”à¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆà¥¤",
                will_return: "à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤†à¤ª à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¤¾à¤‡à¤Ÿ à¤ªà¤° à¤²à¥Œà¤Ÿ à¤†à¤à¤‚à¤—à¥‡à¥¤",
                continue_btn: "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
                cancel_btn: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚"
            },
            ur: {
                security_info: "Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
                redirect_message: "Ø¢Ù¾ Ú©Ùˆ ÛÙ…Ø§Ø±ÛŒ Ù…Ø­ÙÙˆØ¸ ØªØµØ¯ÛŒÙ‚ Ø®Ø¯Ù…Øª <strong>(Supabase)</strong> Ù¾Ø± Ø¨Ú¾ÛŒØ¬Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§",
                normal_secure: "ÛŒÛ Ù†Ø§Ø±Ù…Ù„ Ø§ÙˆØ± Ù…Ø­ÙÙˆØ¸ ÛÛ’Û”",
                will_return: "Ø³Ø§Ø¦Ù† Ø§Ù† Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ø®ÙˆØ¯ Ø¨Ø®ÙˆØ¯ ÛÙ…Ø§Ø±ÛŒ Ø³Ø§Ø¦Ù¹ Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¢ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”",
                continue_btn: "Ø¬Ø§Ø±ÛŒ Ø±Ú©Ú¾ÛŒÚº",
                cancel_btn: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº"
            },
            zh: {
                security_info: "å®‰å…¨ä¿¡æ¯",
                redirect_message: "æ‚¨å°†è¢«é‡å®šå‘åˆ°æˆ‘ä»¬çš„å®‰å…¨è®¤è¯æœåŠ¡<strong>(Supabase)</strong>ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•",
                normal_secure: "è¿™æ˜¯æ­£å¸¸ä¸”å®‰å…¨çš„ã€‚",
                will_return: "ç™»å½•åæ‚¨å°†è‡ªåŠ¨è¿”å›æˆ‘ä»¬çš„ç½‘ç«™ã€‚",
                continue_btn: "ç»§ç»­",
                cancel_btn: "å–æ¶ˆ"
            },
            tl: {
                security_info: "Impormasyon sa Seguridad",
                redirect_message: "Ire-redirect ka sa aming secure authentication service <strong>(Supabase)</strong> para mag-sign in gamit ang",
                normal_secure: "Ito ay normal at secure.",
                will_return: "Awtomatikong babalik ka sa aming site pagkatapos mag-sign in.",
                continue_btn: "Magpatuloy",
                cancel_btn: "Kanselahin"
            }
        };
        
        let currentUser = null;
        let userProfile = null;
        let profileLoadAttempts = 0;
        const MAX_PROFILE_LOAD_ATTEMPTS = 10;
        let currentPage = 'landing';

        window.setCurrentPage = function(newPage) {
            console.log('ğŸ“ setCurrentPage called:', newPage);
            currentPage = newPage;
            window.currentPage = newPage;
        };
        
        let isPasswordRecoveryMode = false;
        let is2FAMode = false;
        let isSignupInProgress = false;
        let tempPhone = null;  // âœ… NOUVEAU: stocker le tÃ©lÃ©phone temporairement
        let pendingSignupId = null;  // âœ… NOUVEAU: ID du pending_signup
        let globalIsUploading = false;
        let contractJustSigned = false;

        window.currentUser = null;
        window.userProfile = null;
        window.currentPage = 'landing';
        window.contractJustSigned = false;
        window.tempPhone = null;
        window.pendingSignupId = null;
        
        // âœ… NOUVEAU: Fonctions setters
        window.setIs2FAMode = function(value) {
            is2FAMode = value;
            window.is2FAMode = value;
        };
        
        window.setTempPhone = function(phone) {
            tempPhone = phone;
            window.tempPhone = phone;
        };
        
        window.setPendingSignupId = function(id) {
            pendingSignupId = id;
            window.pendingSignupId = id;
        };
        
        function getQueryParams() {
            const params = {};
            const search = window.location.search.substring(1);
            if (!search) return params;
            
            for (const part of search.split('&')) {
                const [key, value] = part.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            }
            return params;
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'signup') {
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
        }
        
        function prefillTestData() {
            if (document.getElementById('name')) {
                document.getElementById('name').value = 'Test User';
                document.getElementById('countryCode').value = '+33';
                document.getElementById('phone').value = '612345678';
                document.getElementById('email').value = 'karyne@itooki.fr';
                document.getElementById('password').value = 'Test1234';
                document.getElementById('confirmPassword').value = 'Test1234';
                VALIDATION.validateName();
                VALIDATION.validatePhone();
                VALIDATION.validateEmail();
                VALIDATION.validatePassword();
                VALIDATION.validateConfirmPassword();
                console.log('âœ… DonnÃ©es de test prÃ©-remplies');
            }
        }

        function handleAuth(mode) {
            console.log('ğŸ”§ handleAuth called for mode:', mode);
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            if (!form) {
                console.error('âŒ Form not found');
                return;
            }
            console.log('âœ… Form found, attaching handler');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                console.log('ğŸ“¤ Form submitted for', mode);
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password')?.value;
                
                try {
                    if (mode === 'signup') {
                        console.log('ğŸ“ Processing signup with 2FA');
                        const name = document.getElementById('name').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const countryCode = document.getElementById('countryCode').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        // Validations
                        if (!VALIDATION.validateName(name)) throw new Error('Nom invalide');
                        if (!VALIDATION.validatePhone(fullPhone)) throw new Error('NumÃ©ro de tÃ©lÃ©phone invalide');
                        if (!VALIDATION.validateEmail(email)) throw new Error('Email invalide');
                        if (!VALIDATION.validatePassword(password)) throw new Error('Mot de passe invalide');
                        if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));
                        
                        const fullPhone = countryCode + phone;

                        // âœ… Ã‰TAPE 1: VÃ©rifier que le tÃ©lÃ©phone n'existe pas dÃ©jÃ 
                        console.log('ğŸ” Checking if phone exists:', fullPhone);
                        const phoneCheck = await TFA.checkPhoneExists(fullPhone);
                        
                        if (phoneCheck.exists) {
                            const message = `Ce numÃ©ro de tÃ©lÃ©phone est dÃ©jÃ  utilisÃ©${phoneCheck.userName ? ' par ' + phoneCheck.userName : ''}`;
                            
                            if (errorDiv) {
                                errorDiv.textContent = message;
                                errorDiv.classList.remove('hidden');
                            }
                            
                            const submitButton = document.getElementById('submitButton');
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = t('auth:signup_button');
                            }
                            
                            console.log('âŒ Phone already exists, blocking signup');
                            return;
                        }
                        
                        // âœ… Ã‰TAPE 2: DÃ©sactiver le bouton
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = true;
                        submitButton.textContent = 'Envoi du code SMS...';
                        
                        isSignupInProgress = true;
                        console.log('ğŸ”’ Signup in progress - sending SMS first');
                        
                        try {
                            // âœ… Ã‰TAPE 3: Envoyer le SMS SANS crÃ©er de compte
                            console.log('ğŸ“± Sending SMS code BEFORE creating account...');
                            const currentLang = i18next.language || 'fr';
                            
                            const pendingSignupData = {
                                email: email,
                                password: password,  // Sera hashÃ© par Supabase lors de signUp
                                name: name,
                                phone: fullPhone
                            };
                            
                            const smsResult = await TFA.send2FACode(fullPhone, currentLang, pendingSignupData);
                            
                            if (!smsResult.success) {
                                throw new Error('Erreur lors de l\'envoi du SMS');
                            }
                            
                            console.log('âœ… SMS sent successfully');
                            
                            // âœ… Ã‰TAPE 4: Stocker le tÃ©lÃ©phone temporairement
                            tempPhone = fullPhone;
                            window.tempPhone = fullPhone;
                            
                            // âœ… Ã‰TAPE 5: Activer le mode 2FA
                            is2FAMode = true;
                            window.is2FAMode = true;
                            isSignupInProgress = false;
                            
                            console.log('âœ… 2FA mode activated, showing keyboard');
                            render();
                            
                        } catch (error) {
                            console.error('âŒ Error sending SMS:', error);
                            isSignupInProgress = false;
                            
                            // RÃ©activer le bouton
                            submitButton.disabled = false;
                            submitButton.textContent = t('auth:signup_button');
                            
                            // Afficher l'erreur
                            let errorMessage = error.message;
                            
                            if (error.message.includes('wait')) {
                                errorMessage = error.message; // Message rate limiting dÃ©jÃ  traduit
                            } else if (error.message.includes('maximum')) {
                                errorMessage = error.message;
                            }
                            
                            if (errorDiv) {
                                errorDiv.textContent = errorMessage;
                                errorDiv.classList.remove('hidden');
                            }
                            
                            throw error;
                        }
                        
                    } else if (mode === 'login') {
                        console.log('ğŸ” Processing login');
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        console.log('âœ… Login successful');
                    }
                } catch (error) {
                    console.error('âŒ Auth error:', error);
                    let errorMessage = error.message;
                    
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Email ou mot de passe incorrect';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Veuillez confirmer votre email avant de vous connecter';
                    } else if (error.message.includes('User already registered')) {
                        errorMessage = 'Cet email est dÃ©jÃ  utilisÃ©';
                    } else if (error.message.includes('Password should be at least')) {
                        errorMessage = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    
                    if (mode === 'signup') {
                        const submitButton = document.getElementById('submitButton');
                        submitButton.disabled = false;
                        submitButton.textContent = t('auth:signup_button');
                    }
                }
            };
        }
        
        async function handleReset() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value;
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    
                    if (error) throw error;
                    
                    alert(t('auth:reset_email_sent'));
                    UTILS.showLogin();
                } catch (error) {
                    console.error('Reset error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        function showOAuthWarning(provider) {
            const modal = document.getElementById('oauthWarningModal');
            const providerName = provider === 'google' ? 'Google' : 'Apple';
            const currentLang = i18next.language || 'fr';
            const trans = oauthTranslations[currentLang] || oauthTranslations['fr'];
            
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full border-2 border-yellow-500">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-4">âš ï¸</div>
                            <h3 class="text-2xl font-bold mb-4">${trans.security_info}</h3>
                        </div>
                        
                        <p class="text-gray-300 mb-6 leading-relaxed">
                            ${trans.redirect_message} ${providerName}.
                        </p>
                        
                        <p class="text-gray-300 mb-6">
                            <span class="text-green-400 font-semibold">âœ“ ${trans.normal_secure}</span><br>
                            ${trans.will_return}
                        </p>
                        
                        <div class="flex gap-4">
                            <button 
                                onclick="proceedWithOAuth('${provider}')" 
                                class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition"
                            >
                                ${trans.continue_btn}
                            </button>
                            <button 
                                onclick="closeOAuthWarning()" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition"
                            >
                                ${trans.cancel_btn}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        function closeOAuthWarning() {
            const modal = document.getElementById('oauthWarningModal');
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }
        
        async function proceedWithOAuth(provider) {
            closeOAuthWarning();
            
            try {
                console.log(`ğŸ” Starting ${provider} Sign In...`);
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                console.log(`âœ… ${provider} redirect initiated`);
            } catch (error) {
                console.error(`âŒ ${provider} Sign In error:`, error);
                alert(`Erreur lors de la connexion avec ${provider}: ` + error.message);
            }
        }
        
        async function signInWithGoogle() {
            showOAuthWarning('google');
        }
        
        async function signInWithApple() {
            showOAuthWarning('apple');
        }
        
        async function handleChangePassword() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (newPassword.length < 8) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[a-zA-Z]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins une lettre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!/[0-9]/.test(newPassword)) {
                    errorDiv.textContent = 'Le mot de passe doit contenir au moins un chiffre';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    console.log('ğŸ”‘ Updating password...');
                    const { error } = await supabase.auth.updateUser({ 
                        password: newPassword 
                    });
                    
                    if (error) throw error;
                    
                    console.log('âœ… Password updated successfully');
                    isPasswordRecoveryMode = false;
                    alert('âœ… Mot de passe changÃ© avec succÃ¨s !');
                    await supabase.auth.signOut();
                    UTILS.showLogin();
                } catch (error) {
                    console.error('âŒ Change password error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        async function loadUserProfile(user = null) {
            const targetUser = user || currentUser;
            console.log('ğŸ” loadUserProfile called for user:', targetUser?.id);

            if (!targetUser || !targetUser.id) {
                console.error('âŒ No user provided to loadUserProfile');
                return false;
            }

            try {
                console.log('ğŸ” Fetching profile from Supabase for:', targetUser.id);

                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', targetUser.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('âŒ Error loading profile:', error);
                    alert('Erreur lors du chargement du profil: ' + error.message);
                    return false;
                }

                let profile = data;
                if (!profile) {
                    console.log('ğŸ“ Profile does not exist, creating it...');
                    const { data: newProfile, error: insertError } = await supabase
                        .from('profiles')
                        .upsert([{
                            id: targetUser.id,
                            name: targetUser.user_metadata?.name || targetUser.email.split('@')[0],
                            phone: targetUser.user_metadata?.phone || '',
                            email: targetUser.email,
                            role: 'referrer',
                            contract_status: 'pending',
                            phone_verified: false
                        }], { onConflict: 'id' })
                        .select()
                        .single();

                    if (insertError) {
                        console.error('âŒ Error creating profile:', insertError);
                        alert('Erreur lors de la crÃ©ation du profil: ' + insertError.message);
                        return false;
                    }

                    profile = newProfile;
                }

                console.log('âœ… Profile data retrieved:', profile);

                if (profile && profile.contract_status) {
                    profile.contract_status = profile.contract_status.trim().replace(/\*+/g, '');
                }

                userProfile = profile;
                window.userProfile = profile;
                console.log('âœ… userProfile set:', userProfile);
                return true;

            } catch (err) {
                console.error('âŒ Exception loading profile:', err);
                alert('Exception lors du chargement du profil: ' + err.message);
                return false;
            }
        }
        window.loadUserProfile = loadUserProfile;
        
        async function logout() {
            console.log('ğŸšª Logout called');
            
            try {
                console.log('ğŸ”“ Signing out from Supabase...');
                supabase.auth.signOut();
                
                console.log('ğŸ§¹ Cleaning ALL session data...');
                localStorage.clear();
                sessionStorage.clear();
                
                currentUser = null;
                userProfile = null;
                currentPage = 'landing';
                isPasswordRecoveryMode = false;
                is2FAMode = false;
                tempPhone = null;
                pendingSignupId = null;
                globalIsUploading = false;
                
                window.currentUser = null;
                window.userProfile = null;
                window.currentPage = 'landing';
                window.tempPhone = null;
                window.pendingSignupId = null;
                
                console.log('âœ… Local state cleaned');
                console.log('ğŸ”„ Reloading page NOW...');
                window.location.href = window.location.origin;
                
            } catch (error) {
                console.error('âŒ Logout exception:', error);
                console.log('ğŸš¨ Forcing logout despite error...');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = window.location.origin;
            }
        }
        
        async function render() {
            console.log('ğŸ¨ RENDER called');
            console.log('- currentUser:', !!currentUser);
            console.log('- userProfile:', !!userProfile);
            console.log('- currentPage:', currentPage);
            console.log('- isPasswordRecoveryMode:', isPasswordRecoveryMode);
            console.log('- is2FAMode:', is2FAMode);
            console.log('- isSignupInProgress:', isSignupInProgress);
            
            if (contractJustSigned && currentUser && userProfile) {
                console.log('ğŸ‰ Contract just signed! Reloading profile and showing confirmation');
                
                contractJustSigned = false;
                window.contractJustSigned = false;

                try {
                    await loadUserProfile(currentUser);
                } catch (e) {
                    console.error('Erreur lors du rechargement du profil aprÃ¨s signature:', e);
                }

                setTimeout(() => {
                    const confirmationDiv = document.createElement('div');
                    confirmationDiv.innerHTML = `
                        <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">âœ…</span>
                                <div>
                                    <div class="font-bold">Contrat signÃ© avec succÃ¨s !</div>
                                    <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmationDiv);

                    setTimeout(() => {
                        confirmationDiv.remove();
                    }, 5000);
                }, 500);
            }
            
            const app = document.getElementById('app');
            
            if (is2FAMode) {
                console.log('ğŸ“± 2FA mode active - showing 2FA form');
                app.innerHTML = RENDERING.renderAuthPage('2fa');  // âœ… ChangÃ© de 'login' Ã  '2fa'
                
                // âœ… Attacher le handler du formulaire 2FA
                setTimeout(() => {
                    const form2FA = document.getElementById('form2FA');
                    if (form2FA) {
                        form2FA.addEventListener('submit', TFA.handle2FASubmit);
                        console.log('âœ… 2FA form handler attached');
                    }
                    // Auto-focus sur le champ code
                    document.getElementById('code2fa')?.focus();
                }, 100);
                return;
            }
            
            if (isPasswordRecoveryMode && currentPage === 'change-password') {
                console.log('ğŸ”‘ Password recovery mode - showing change password form');
                app.innerHTML = RENDERING.renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
                return;
            }
            
            if (currentUser && userProfile) {
                console.log('âœ… User connected with profile, showing dashboard');
                currentPage = 'dashboard';
                window.currentPage = 'dashboard';
                app.innerHTML = RENDERING.renderDashboard();
                await DASHBOARD.loadDashboardContent();
                
                if (userProfile.role !== 'admin') {
                    const contractForm = document.getElementById('contractForm');
                    if (contractForm) {
                        console.log('âœ… Contract form found, attaching submit handler');
                        
                        contractForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            
                            if (globalIsUploading) {
                                console.log('âš ï¸ Upload already in progress, ignoring duplicate submit');
                                return;
                            }
                            
                            globalIsUploading = true;
                            console.log('ğŸ“„ Starting contract upload...');
                            
                            const submitBtn = document.getElementById('contractSubmitBtn');
                            const errorDiv = document.getElementById('uploadError');
                            const progressDiv = document.getElementById('uploadProgress');
                            const originalText = submitBtn.textContent;
                            
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Upload en cours...';
                            errorDiv.classList.add('hidden');
                            progressDiv.classList.remove('hidden');
                            progressDiv.textContent = 'â³ PrÃ©paration du fichier...';
                            
                            try {
                                const fileInput = document.getElementById('contractFile');
                                const file = fileInput.files[0];
                                
                                if (!file) {
                                    throw new Error('Veuillez sÃ©lectionner un fichier');
                                }
                                if (file.type !== 'application/pdf') {
                                    throw new Error('Seuls les fichiers PDF sont acceptÃ©s');
                                }
                                const maxSize = 10 * 1024 * 1024;
                                if (file.size > maxSize) {
                                    throw new Error('Le fichier est trop volumineux. Taille maximum : 10MB');
                                }
                                
                                console.log('ğŸ“„ File validated:', file.name, 'Size:', file.size, 'bytes');
                                
                                progressDiv.textContent = 'â³ TÃ©lÃ©chargement vers le serveur...';
                                
                                const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;
                                console.log('ğŸ“„ Uploading to Storage with name:', fileName);
                                
                                const { data: { session } } = await supabase.auth.getSession();
                                if (!session) {
                                    throw new Error('Session expirÃ©e, veuillez vous reconnecter');
                                }
                                
                                const uploadUrl = `${SUPABASE_URL}/storage/v1/object/contracts/${fileName}`;
                                console.log('ğŸš€ Uploading via REST API to:', uploadUrl);
                                
                                const uploadResponse = await fetch(uploadUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${session.access_token}`,
                                        'Content-Type': file.type,
                                        'x-upsert': 'false'
                                    },
                                    body: file
                                });
                                
                                if (!uploadResponse.ok) {
                                    const errorText = await uploadResponse.text();
                                    console.error('âŒ Upload failed:', uploadResponse.status, errorText);
                                    throw new Error(`Erreur d'upload: ${uploadResponse.status} - ${errorText}`);
                                }
                                
                                const uploadData = await uploadResponse.json();
                                console.log('âœ… File uploaded successfully to Storage');
                                console.log('ğŸ“ Upload response:', uploadData);
                                
                                progressDiv.textContent = 'â³ Mise Ã  jour de votre profil...';
                                
                                const { error: updateError } = await supabase.from('profiles').update({
                                    contract_path: fileName,
                                    contract_status: 'signed',
                                    contract_file_url: fileName
                                }).eq('id', currentUser.id);
                                
                                if (updateError) {
                                    console.error('âŒ Error updating profile:', updateError);
                                    throw new Error(`Erreur de mise Ã  jour : ${updateError.message}`);
                                }
                                
                                console.log('âœ… Profile updated successfully with contract_path:', fileName);
                                
                                alert('âœ… Contrat uploadÃ© avec succÃ¨s !');
                                await loadUserProfile();
                                globalIsUploading = false;
                                render();
                            } catch (error) {
                                console.error('âŒ Upload exception:', error);
                                errorDiv.textContent = error.message;
                                errorDiv.classList.remove('hidden');
                                progressDiv.classList.add('hidden');
                            } finally {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                globalIsUploading = false;
                            }
                        });
                    } else {
                        console.log('â„¹ï¸ Contract form not found (contract already uploaded or admin user)');
                    }
                } else {
                    console.log('â„¹ï¸ Admin user - no contract form needed');
                }
            } else if (currentUser && !userProfile) {
                profileLoadAttempts++;
                
                if (profileLoadAttempts >= MAX_PROFILE_LOAD_ATTEMPTS) {
                    console.error('âŒ Failed to load profile after max attempts');
                    profileLoadAttempts = 0;
                    supabase.auth.signOut();
                    currentPage = 'landing';
                    render();
                    return;
                }
                
                console.log(`â³ User connected but no profile, waiting... (attempt ${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS})`);
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">â³</div><div class="text-xl text-gray-600">Chargement de votre profil... (tentative ' + profileLoadAttempts + '/' + MAX_PROFILE_LOAD_ATTEMPTS + ')</div></div></div>';
                
                setTimeout(() => {
                    loadUserProfile().then(() => render());
                }, profileLoadAttempts * 1000);
                return;
            } else if (currentPage === 'auth-login') {
                console.log('ğŸ” Rendering login page');
                app.innerHTML = RENDERING.renderAuthPage('login');
                setTimeout(() => {
                    console.log('â±ï¸ Attempting to attach login handler');
                    handleAuth('login');
                }, 500);
            } else if (currentPage === 'auth-signup') {
                console.log('ğŸ“ Rendering signup page');
                app.innerHTML = RENDERING.renderAuthPage('signup');
                setTimeout(() => {
    console.log('â±ï¸ Attempting to attach signup handler');
    handleAuth('signup');
    
    // âœ… Attacher la validation du mot de passe
    if (window.VALIDATION && window.VALIDATION.attachPasswordValidation) {
        window.VALIDATION.attachPasswordValidation();
        console.log('âœ… Password validation attached in signup render');
    }
}, 500);
            } else if (currentPage === 'auth-reset') {
                console.log('ğŸ”‘ Rendering reset page');
                app.innerHTML = RENDERING.renderAuthPage('reset');
                setTimeout(() => handleReset(), 500);
            } else if (currentPage === 'change-password') {
                console.log('ğŸ”‘ Rendering change password page');
                app.innerHTML = RENDERING.renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
            } else {
                console.log('ğŸ  Rendering landing page');
                app.innerHTML = RENDERING.renderLandingPage();
            }
        }
        
        window.showAddLeadForm = LEADS.showAddLeadForm;
        window.closeAddLeadModal = LEADS.closeAddLeadModal;
        window.addLead = LEADS.addLead;
        window.updateLeadStatus = LEADS.updateLeadStatus;
        window.markAsSold = LEADS.markAsSold;
        window.renderAddLeadModal = LEADS.renderAddLeadModal;
        window.togglePasswordVisibility = VALIDATION.togglePasswordVisibility;
        window.validateName = VALIDATION.validateName;
        window.validatePhone = VALIDATION.validatePhone;
        window.validateEmail = VALIDATION.validateEmail;
        window.validatePassword = VALIDATION.validatePassword;
        window.validateConfirmPassword = VALIDATION.validateConfirmPassword;
        window.checkFormValidity = VALIDATION.checkFormValidity;
        window.prefillTestData = UTILS.prefillTestData;
        window.render = render;
        window.loadDashboardContent = DASHBOARD.loadDashboardContent;
        window.handleChangePassword = handleChangePassword;
        window.downloadContractTemplate = UTILS.downloadContractTemplate;
        window.checkPhoneExists = TFA.checkPhoneExists;
        window.handle2FASubmit = TFA.handle2FASubmit;
        window.resend2FACode = TFA.resend2FACode;
        window.signInWithGoogle = signInWithGoogle;
        window.signInWithApple = signInWithApple;
        window.showOAuthWarning = showOAuthWarning;
        window.closeOAuthWarning = closeOAuthWarning;
        window.proceedWithOAuth = proceedWithOAuth;
        window.toggleMobileMenu = UTILS.toggleMobileMenu;
        window.showLogin = UTILS.showLogin;
        window.showSignup = UTILS.showSignup;
        window.showReset = UTILS.showReset;
        window.backToHome = UTILS.backToHome;
        window.renderLandingPage = RENDERING.renderLandingPage;
        window.renderAuthPage = RENDERING.renderAuthPage;
        window.renderDashboard = RENDERING.renderDashboard;
        window.logout = logout;
        
        console.log('â³ Displaying initial loader');
        document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">â³</div><div class="text-xl">Chargement...</div></div></div>';
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('ğŸ”” Auth state changed:', event);
            
            if (isSignupInProgress && event !== 'SIGNED_IN') {
                console.log('âš ï¸ Ignoring event during signup process:', event);
                return;
            }
            
            if (event === 'PASSWORD_RECOVERY') {
                console.log('ğŸ”‘ Password recovery detected - blocking auto-login');
                isPasswordRecoveryMode = true;
                currentPage = 'change-password';
                window.currentPage = 'change-password';
                currentUser = session?.user || null;
                window.currentUser = currentUser;
                render();
                return;
            }
            
            if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') {
                console.log('âš ï¸ Ignoring event during password recovery:', event);
                return;
            }
            
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            
            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('âš ï¸ Email not confirmed, signing out');
                await supabase.auth.signOut();
                currentUser = null;
                window.currentUser = null;
            }
            
            if (currentUser) {
                console.log('ğŸ‘¤ User authenticated, loading profile...');
                
                loadUserProfile(currentUser).then(profileLoaded => {
                    if (!profileLoaded) {
                        console.error('âŒ Failed to load profile, signing out');
                        supabase.auth.signOut();
                        currentUser = null;
                        window.currentUser = null;
                        userProfile = null;
                        window.userProfile = null;
                    }
                    render();
                }).catch(err => {
                    console.error('âŒ Exception loading profile:', err);
                    render();
                });
            }
            
            render();
        });
        
        console.log('ğŸ” Getting initial session...');
        
        supabase.auth.getSession().then(async ({ data: { session }, error }) => {
            if (error) {
                console.error('âŒ Session error:', error);
                currentUser = null;
                window.currentUser = null;
                render();
                return;
            }

            currentUser = session?.user || null;
            window.currentUser = currentUser;

            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('âš ï¸ Email not confirmed on init, cleaning session');
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                currentUser = null;
                window.currentUser = null;
                render();
                return;
            }

            if (currentUser) {
                console.log('ğŸ‘¤ Session found, loading profile...');
                const profileLoaded = await loadUserProfile(currentUser);

                if (!profileLoaded) {
                    console.error('âŒ Failed to load profile on init, signing out');
                    await supabase.auth.signOut();
                    localStorage.clear();
                    sessionStorage.clear();
                    currentUser = null;
                    window.currentUser = null;
                    userProfile = null;
                    window.userProfile = null;
                }
            }

            render();
        });

        render();
        
        setTimeout(() => {
            if (window.contractJustSigned && currentUser && userProfile) {
                const confirmationDiv = document.createElement('div');
                confirmationDiv.innerHTML = `
                    <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âœ…</span>
                            <div>
                                <div class="font-bold">Contrat signÃ© avec succÃ¨s !</div>
                                <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationDiv);
                setTimeout(() => confirmationDiv.remove(), 5000);
                window.contractJustSigned = false;
            }
        }, 2000);
    })();
    </script>
</body>
</html>
