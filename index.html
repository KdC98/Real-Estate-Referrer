<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Referrer - Karyne de Clercq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-amber-600 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700 text-lg font-semibold" data-i18n="connecting_google">Connexion avec Google...</p>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="container mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-white mb-4" data-i18n="landing_title">Devenez Apporteur d'Affaires Immobilier</h1>
            <p class="text-2xl text-blue-100 mb-8" data-i18n="landing_subtitle">Gagnez jusqu'√† 20% de commission sur chaque vente</p>
        </div>

        <!-- CTA Section -->
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-2xl p-8 mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-i18n="landing_cta_title">Commencez √† gagner aujourd'hui</h2>
            
            <!-- OAuth Buttons -->
            <div class="space-y-4 mb-6">
                <!-- Google Sign In -->
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span data-i18n="sign_in_google">Sign in with Google</span>
                </button>

                <!-- Apple Sign In -->
                <button onclick="signInWithApple()" class="w-full flex items-center justify-center gap-3 bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-900 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span data-i18n="sign_in_apple">Sign in with Apple</span>
                </button>
            </div>

            <!-- Separator -->
            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500" data-i18n="or_email">Ou avec votre email</span>
                </div>
            </div>

            <!-- Email Sign In Button -->
            <button onclick="showSignupForm()" class="w-full bg-gradient-to-r from-blue-600 to-amber-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-amber-600 transition-all shadow-lg">
                <span data-i18n="landing_cta_button">Cr√©er mon compte gratuit</span>
            </button>
            
            <p class="text-center mt-4 text-gray-600">
                <span data-i18n="already_account">D√©j√† inscrit ?</span>
                <a href="#" onclick="showLoginForm(); return false;" class="text-blue-600 hover:underline font-semibold" data-i18n="login_here">Connectez-vous ici</a>
            </p>
        </div>

        <!-- Benefits Section -->
        <div class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-lg p-6 text-center">
                <div class="text-4xl font-bold text-amber-400 mb-2">20%</div>
                <p class="text-white text-lg" data-i18n="benefit_commission">De commission sur chaque vente</p>
            </div>
            <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-lg p-6 text-center">
                <div class="text-4xl font-bold text-amber-400 mb-2">24/7</div>
                <p class="text-white text-lg" data-i18n="benefit_support">Support et suivi en temps r√©el</p>
            </div>
            <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-lg p-6 text-center">
                <div class="text-4xl font-bold text-amber-400 mb-2">48h</div>
                <p class="text-white text-lg" data-i18n="benefit_payment">Paiement apr√®s signature</p>
            </div>
        </div>
    </div>

    <!-- Login Form (Hidden by default) -->
    <div id="loginForm" class="hidden container mx-auto px-4 py-12 max-w-md">
        <div class="bg-white rounded-lg shadow-2xl p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-i18n="login_title">Connexion</h2>
            
            <!-- OAuth Buttons in Login -->
            <div class="space-y-4 mb-6">
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span data-i18n="sign_in_google">Sign in with Google</span>
                </button>

                <button onclick="signInWithApple()" class="w-full flex items-center justify-center gap-3 bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-900 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span data-i18n="sign_in_apple">Sign in with Apple</span>
                </button>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500" data-i18n="or_email">Ou avec votre email</span>
                </div>
            </div>

            <form id="loginFormElement" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="email">Email</label>
                    <input type="email" id="loginEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="password">Mot de passe</label>
                    <input type="password" id="loginPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-amber-500 text-white px-8 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-amber-600 transition-all">
                    <span data-i18n="login_button">Se connecter</span>
                </button>
            </form>

            <div class="mt-4 text-center">
                <a href="#" onclick="showForgotPasswordForm(); return false;" class="text-blue-600 hover:underline text-sm" data-i18n="forgot_password">Mot de passe oubli√© ?</a>
            </div>

            <p class="text-center mt-6 text-gray-600">
                <span data-i18n="no_account">Pas encore inscrit ?</span>
                <a href="#" onclick="showSignupForm(); return false;" class="text-blue-600 hover:underline font-semibold" data-i18n="signup_here">Cr√©ez votre compte</a>
            </p>
        </div>
    </div>

    <!-- Signup Form (Hidden by default) -->
    <div id="signupForm" class="hidden container mx-auto px-4 py-12 max-w-md">
        <div class="bg-white rounded-lg shadow-2xl p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-i18n="signup_title">Cr√©er un compte</h2>
            
            <!-- OAuth Buttons in Signup -->
            <div class="space-y-4 mb-6">
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span data-i18n="sign_in_google">Sign in with Google</span>
                </button>

                <button onclick="signInWithApple()" class="w-full flex items-center justify-center gap-3 bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-900 transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span data-i18n="sign_in_apple">Sign in with Apple</span>
                </button>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500" data-i18n="or_email">Ou avec votre email</span>
                </div>
            </div>

            <form id="signupFormElement" onsubmit="handleSignup(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="full_name">Nom complet</label>
                    <input type="text" id="signupName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="phone">T√©l√©phone</label>
                    <div class="flex gap-2">
                        <select id="signupCountryCode" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="+971">üá¶üá™ +971</option>
                            <option value="+33">üá´üá∑ +33</option>
                            <option value="+44">üá¨üáß +44</option>
                            <option value="+1">üá∫üá∏ +1</option>
                            <option value="+91">üáÆüá≥ +91</option>
                            <option value="+86">üá®üá≥ +86</option>
                            <option value="+7">üá∑üá∫ +7</option>
                            <option value="+63">üáµüá≠ +63</option>
                        </select>
                        <input type="tel" id="signupPhone" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="612345678">
                    </div>
                    <div class="mt-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-sm text-blue-800" data-i18n="sms_verification_notice">Un code SMS de v√©rification vous sera envoy√© lors de l'inscription.</p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="email">Email</label>
                    <input type="email" id="signupEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="password">Mot de passe</label>
                    <div class="relative">
                        <input type="password" id="signupPassword" required minlength="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" oninput="checkPasswordStrength()">
                        <button type="button" onclick="togglePasswordVisibility('signupPassword')" class="absolute right-3 top-2.5 text-gray-600">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div id="passwordStrength" class="mt-2 hidden">
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="strengthBar" class="h-full transition-all duration-300"></div>
                        </div>
                        <p id="strengthText" class="text-sm mt-1"></p>
                        <ul class="text-xs mt-2 space-y-1">
                            <li id="check8chars" class="text-gray-500">‚úó <span data-i18n="password_8_chars">Minimum 8 caract√®res</span></li>
                            <li id="checkLetter" class="text-gray-500">‚úó <span data-i18n="password_letter">Au moins une lettre</span></li>
                            <li id="checkNumber" class="text-gray-500">‚úó <span data-i18n="password_number">Au moins un chiffre</span></li>
                        </ul>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="confirm_password">Confirmer le mot de passe</label>
                    <div class="relative">
                        <input type="password" id="signupPasswordConfirm" required minlength="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="button" onclick="togglePasswordVisibility('signupPasswordConfirm')" class="absolute right-3 top-2.5 text-gray-600">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-amber-500 text-white px-8 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-amber-600 transition-all">
                    <span data-i18n="signup_button">Cr√©er mon compte</span>
                </button>
            </form>

            <p class="text-center mt-6 text-gray-600">
                <span data-i18n="already_account">D√©j√† inscrit ?</span>
                <a href="#" onclick="showLoginForm(); return false;" class="text-blue-600 hover:underline font-semibold" data-i18n="login_here">Connectez-vous ici</a>
            </p>
        </div>
    </div>

    <!-- Forgot Password Form -->
    <div id="forgotPasswordForm" class="hidden container mx-auto px-4 py-12 max-w-md">
        <div class="bg-white rounded-lg shadow-2xl p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-i18n="forgot_password_title">Mot de passe oubli√©</h2>
            <p class="text-gray-600 mb-6 text-center" data-i18n="forgot_password_description">Entrez votre email pour recevoir un lien de r√©initialisation</p>
            
            <form id="forgotPasswordFormElement" onsubmit="handleForgotPassword(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" data-i18n="email">Email</label>
                    <input type="email" id="forgotEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-amber-500 text-white px-8 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-amber-600 transition-all">
                    <span data-i18n="send_reset_link">Envoyer le lien</span>
                </button>
            </form>

            <p class="text-center mt-6 text-gray-600">
                <a href="#" onclick="showLoginForm(); return false;" class="text-blue-600 hover:underline" data-i18n="back_to_login">Retour √† la connexion</a>
            </p>
        </div>
    </div>

    <!-- Dashboard Apporteur -->
    <div id="dashboardReferrer" class="hidden">
        <div class="bg-gradient-to-br from-blue-900 via-blue-800 to-amber-600 min-h-screen">
            <!-- Header -->
            <div class="bg-white shadow-lg">
                <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-amber-500" data-i18n="dashboard_referrer_title">Dashboard Apporteur</h1>
                    <div class="flex items-center gap-4">
                        <span class="text-gray-700" id="userName"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                            <span data-i18n="logout">D√©connexion</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contract Required Alert -->
            <div id="contractAlert" class="container mx-auto px-4 py-6">
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-lg font-bold" data-i18n="contract_required_title">Contrat requis</p>
                            <p class="mt-1" data-i18n="contract_required_description">Veuillez t√©l√©charger et signer le contrat d'apporteur avant d'ajouter des leads</p>
                            
                            <div class="mt-4 grid md:grid-cols-2 gap-4">
                                <div class="bg-white bg-opacity-50 rounded-lg p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">üì•</span>
                                        <h3 class="font-bold" data-i18n="step1_download">√âtape 1 : T√©l√©charger</h3>
                                    </div>
                                    <p class="text-sm mb-3" id="upload_instructions" data-i18n="upload_instructions"></p>
                                    <button onclick="downloadContractTemplate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                        <span data-i18n="download_contract_template">download_contract_template</span>
                                    </button>
                                </div>

                                <div class="bg-white bg-opacity-50 rounded-lg p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">üì§</span>
                                        <h3 class="font-bold" data-i18n="step2_upload">√âtape 2 : Uploader</h3>
                                    </div>
                                    <form id="contractForm" onsubmit="submitContract(event)" class="space-y-3">
                                        <input type="file" id="contractFile" accept=".pdf" required class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-amber-500 file:text-white hover:file:bg-amber-600 file:cursor-pointer">
                                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                            <span data-i18n="submit_contract">submit_contract</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="container mx-auto px-4 py-8">
                <!-- Stats Cards -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="total_earnings">Gains totaux</h3>
                        <p class="text-3xl font-bold text-blue-600"><span id="totalEarnings">0</span> AED</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="active_leads">Leads en cours</h3>
                        <p class="text-3xl font-bold text-amber-500" id="activeLeads">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="closed_sales">Ventes conclues</h3>
                        <p class="text-3xl font-bold text-green-600" id="closedSales">0</p>
                    </div>
                </div>

                <!-- Add Lead Button -->
                <div class="mb-6">
                    <button id="addLeadBtn" onclick="showAddLeadForm()" disabled class="bg-gradient-to-r from-blue-600 to-amber-500 text-white px-6 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-amber-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        + <span data-i18n="add_lead">Ajouter un lead</span>
                    </button>
                </div>

                <!-- Leads Table -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="client_name">Nom du client</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="lead_type">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="property_type">Type de propri√©t√©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="budget">Budget</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="status">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="commission">Commission</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500" data-i18n="no_leads_yet">Aucun lead pour le moment</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <div id="dashboardAdmin" class="hidden">
        <div class="bg-gradient-to-br from-blue-900 via-blue-800 to-amber-600 min-h-screen">
            <div class="bg-white shadow-lg">
                <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-amber-500" data-i18n="dashboard_admin_title">Dashboard Admin</h1>
                    <div class="flex items-center gap-4">
                        <span class="text-gray-700" id="adminName"></span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                            <span data-i18n="logout">D√©connexion</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="container mx-auto px-4 py-8">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="total_referrers">Apporteurs</h3>
                        <p class="text-3xl font-bold text-blue-600" id="totalReferrers">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="active_leads">Leads actifs</h3>
                        <p class="text-3xl font-bold text-amber-500" id="adminActiveLeads">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="total_sales">Ventes totales</h3>
                        <p class="text-3xl font-bold text-green-600" id="totalSales">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-gray-600 text-sm font-semibold mb-2" data-i18n="commissions_paid">Commissions vers√©es</h3>
                        <p class="text-3xl font-bold text-purple-600"><span id="totalCommissions">0</span> AED</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="referrer">Apporteur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="client_name">Client</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="lead_type">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="property_type">Propri√©t√©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="budget">Budget</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="status">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeadsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800" data-i18n="add_lead_title">Ajouter un lead</h2>
                    <button onclick="closeAddLeadForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>

                <form id="addLeadFormElement" onsubmit="handleAddLead(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="lead_type">Type de lead</label>
                        <select id="leadType" onchange="updateLeadForm()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="sale_buyer" data-i18n="sale_buyer">Achat - Acheteur</option>
                            <option value="sale_seller" data-i18n="sale_seller">Vente - Vendeur</option>
                            <option value="rental_landlord" data-i18n="rental_landlord">Location - Propri√©taire</option>
                            <option value="rental_tenant" data-i18n="rental_tenant">Location - Locataire</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="client_name">Nom du client</label>
                        <input type="text" id="clientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="client_email">Email du client</label>
                        <input type="email" id="clientEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="client_phone">T√©l√©phone du client</label>
                        <input type="tel" id="clientPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="property_type">Type de propri√©t√©</label>
                        <select id="propertyType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="apartment" data-i18n="apartment">Appartement</option>
                            <option value="villa" data-i18n="villa">Villa</option>
                            <option value="townhouse" data-i18n="townhouse">Townhouse</option>
                            <option value="penthouse" data-i18n="penthouse">Penthouse</option>
                            <option value="studio" data-i18n="studio">Studio</option>
                        </select>
                    </div>

                    <div id="budgetField" class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2" data-i18n="budget">Budget (AED)</label>
                        <input type="number" id="budget" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="closeAddLeadForm()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-bold transition-all">
                            <span data-i18n="cancel">Annuler</span>
                        </button>
                        <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-amber-500 text-white px-6 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-amber-600 transition-all">
                            <span data-i18n="add_lead">Ajouter</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkwMDY0MTIsImV4cCI6MjA0NDU4MjQxMn0.Y2vMUusE5LTJX3FwUZGd84Ll9NJW4LDz-Xj6z0b4aqM';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userProfile = null;
        let currentPage = 'landing';
        let isPasswordRecoveryMode = false;
        let is2FAMode = false;

        // OAuth Popup Manager
        let oauthPopup = null;

        // Initialize i18next
        i18next.use(i18nextHttpBackend).init({
            lng: 'fr',
            fallbackLng: 'fr',
            backend: {
                loadPath: '/locales/{{lng}}/translation.json'
            }
        }, function(err, t) {
            updateContent();
        });

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = i18next.t(key);
            });
        }

        // Check if we're in a popup opened for OAuth
        if (window.opener && !window.opener.closed) {
            // We're in a popup - check for auth state change
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    // Send message to parent window
                    window.opener.postMessage({ type: 'OAUTH_SUCCESS', session: session }, window.location.origin);
                    // Close popup
                    window.close();
                }
            });
        }

        // Listen for messages from OAuth popup
        window.addEventListener('message', async (event) => {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'OAUTH_SUCCESS') {
                console.log('OAuth success, refreshing session...');
                // Refresh the session in the main window
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (session) {
                    await checkAuth();
                }
            }
        });

        // Google Sign In with Popup
        async function signInWithGoogle() {
            try {
                console.log('Starting Google Sign In with popup...');
                showLoading(true);

                // Get the OAuth URL
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin,
                        skipBrowserRedirect: true
                    }
                });

                if (error) throw error;

                // Open popup
                const width = 600;
                const height = 700;
                const left = window.screen.width / 2 - width / 2;
                const top = window.screen.height / 2 - height / 2;

                oauthPopup = window.open(
                    data.url,
                    'Google Sign In',
                    `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
                );

                if (!oauthPopup) {
                    // Popup blocked - fallback to redirect
                    console.log('Popup blocked, falling back to redirect');
                    window.location.href = data.url;
                    return;
                }

                // Check if popup was closed manually
                const popupTimer = setInterval(() => {
                    if (oauthPopup.closed) {
                        clearInterval(popupTimer);
                        showLoading(false);
                        console.log('Popup closed');
                    }
                }, 500);

            } catch (error) {
                console.error('Error signing in with Google:', error);
                alert(i18next.t('error_google_signin') || 'Erreur lors de la connexion avec Google');
                showLoading(false);
            }
        }

        // Apple Sign In with Popup
        async function signInWithApple() {
            try {
                console.log('Starting Apple Sign In with popup...');
                showLoading(true);

                // Get the OAuth URL
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'apple',
                    options: {
                        redirectTo: window.location.origin,
                        skipBrowserRedirect: true
                    }
                });

                if (error) throw error;

                // Open popup
                const width = 600;
                const height = 700;
                const left = window.screen.width / 2 - width / 2;
                const top = window.screen.height / 2 - height / 2;

                oauthPopup = window.open(
                    data.url,
                    'Apple Sign In',
                    `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
                );

                if (!oauthPopup) {
                    // Popup blocked - fallback to redirect
                    console.log('Popup blocked, falling back to redirect');
                    window.location.href = data.url;
                    return;
                }

                // Check if popup was closed manually
                const popupTimer = setInterval(() => {
                    if (oauthPopup.closed) {
                        clearInterval(popupTimer);
                        showLoading(false);
                        console.log('Popup closed');
                    }
                }, 500);

            } catch (error) {
                console.error('Error signing in with Apple:', error);
                alert(i18next.t('error_apple_signin') || 'Erreur lors de la connexion avec Apple');
                showLoading(false);
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // Navigation functions
        function showLandingPage() {
            hideAll();
            document.getElementById('landingPage').classList.remove('hidden');
            currentPage = 'landing';
        }

        function showLoginForm() {
            hideAll();
            document.getElementById('loginForm').classList.remove('hidden');
            currentPage = 'login';
        }

        function showSignupForm() {
            hideAll();
            document.getElementById('signupForm').classList.remove('hidden');
            currentPage = 'signup';
        }

        function showForgotPasswordForm() {
            hideAll();
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            currentPage = 'forgot';
        }

        function hideAll() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('dashboardReferrer').classList.add('hidden');
            document.getElementById('dashboardAdmin').classList.add('hidden');
        }

        // Password strength checker
        function checkPasswordStrength() {
            const password = document.getElementById('signupPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            strengthDiv.classList.remove('hidden');
            
            let strength = 0;
            const checks = {
                length: password.length >= 8,
                letter: /[a-zA-Z]/.test(password),
                number: /\d/.test(password)
            };
            
            document.getElementById('check8chars').className = checks.length ? 'text-green-600' : 'text-gray-500';
            document.getElementById('check8chars').innerHTML = (checks.length ? '‚úì' : '‚úó') + ' ' + document.getElementById('check8chars').querySelector('span').outerHTML;
            
            document.getElementById('checkLetter').className = checks.letter ? 'text-green-600' : 'text-gray-500';
            document.getElementById('checkLetter').innerHTML = (checks.letter ? '‚úì' : '‚úó') + ' ' + document.getElementById('checkLetter').querySelector('span').outerHTML;
            
            document.getElementById('checkNumber').className = checks.number ? 'text-green-600' : 'text-gray-500';
            document.getElementById('checkNumber').innerHTML = (checks.number ? '‚úì' : '‚úó') + ' ' + document.getElementById('checkNumber').querySelector('span').outerHTML;
            
            strength = Object.values(checks).filter(Boolean).length;
            
            if (strength === 0) {
                strengthBar.className = 'h-full bg-red-500 w-0';
                strengthText.textContent = '';
            } else if (strength === 1) {
                strengthBar.className = 'h-full bg-red-500 w-1/3 transition-all duration-300';
                strengthText.textContent = i18next.t('password_weak') || 'Faible';
                strengthText.className = 'text-sm mt-1 text-red-600';
            } else if (strength === 2) {
                strengthBar.className = 'h-full bg-yellow-500 w-2/3 transition-all duration-300';
                strengthText.textContent = i18next.t('password_medium') || 'Moyen';
                strengthText.className = 'text-sm mt-1 text-yellow-600';
            } else {
                strengthBar.className = 'h-full bg-green-500 w-full transition-all duration-300';
                strengthText.textContent = i18next.t('password_strong') || 'Fort';
                strengthText.className = 'text-sm mt-1 text-green-600';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Auth handlers
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                await checkAuth();
            } catch (error) {
                console.error('Error logging in:', error);
                alert(i18next.t('error_login') || error.message);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const countryCode = document.getElementById('signupCountryCode').value;
            const phone = document.getElementById('signupPhone').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

            if (password !== passwordConfirm) {
                alert(i18next.t('passwords_no_match') || 'Les mots de passe ne correspondent pas');
                return;
            }

            const fullPhone = countryCode + phone;

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    phone: fullPhone,
                    options: {
                        data: {
                            name: name,
                            phone: fullPhone
                        }
                    }
                });

                if (error) throw error;

                alert(i18next.t('account_created') || 'Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.');
                showLoginForm();
            } catch (error) {
                console.error('Error signing up:', error);
                alert(error.message);
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value;

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password.html'
                });

                if (error) throw error;

                alert(i18next.t('reset_link_sent') || 'Un lien de r√©initialisation a √©t√© envoy√© √† votre email');
                showLoginForm();
            } catch (error) {
                console.error('Error sending reset email:', error);
                alert(error.message);
            }
        }

        async function logout() {
            try {
                console.log('Logout called');
                console.log('Signing out from Supabase...');
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                currentUser = null;
                userProfile = null;
                console.log('Signed out successfully, redirecting to landing page');
                showLandingPage();
            } catch (error) {
                console.error('Error logging out:', error);
                alert(i18next.t('error_logout') || 'Erreur lors de la d√©connexion');
            }
        }

        // Check auth state
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;

                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                } else {
                    showLandingPage();
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                showLandingPage();
            }
        }

        async function loadUserProfile() {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;

                userProfile = data;

                console.log('User authenticated, loading profile...');
                console.log('User profile:', userProfile);

                if (userProfile.role === 'admin') {
                    console.log('User is admin');
                    await loadAdminDashboard();
                } else {
                    console.log('User is referrer');
                    await loadReferrerDashboard();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadReferrerDashboard() {
            hideAll();
            document.getElementById('dashboardReferrer').classList.remove('hidden');
            console.log('User connected with profile, showing dashboard');
            
            document.getElementById('userName').textContent = userProfile.name || currentUser.email;

            await checkContractStatus();
            await loadReferrerLeads();
        }

        async function loadAdminDashboard() {
            hideAll();
            document.getElementById('dashboardAdmin').classList.remove('hidden');
            
            document.getElementById('adminName').textContent = userProfile.name || currentUser.email;

            await loadAdminStats();
            await loadAllLeads();
        }

        async function checkContractStatus() {
            try {
                const { data, error } = await supabaseClient.storage
                    .from('contracts')
                    .list(currentUser.id);

                if (error) throw error;

                const hasContract = data && data.length > 0;
                
                if (hasContract) {
                    document.getElementById('contractAlert').classList.add('hidden');
                    document.getElementById('addLeadBtn').disabled = false;
                } else {
                    document.getElementById('contractAlert').classList.remove('hidden');
                    document.getElementById('addLeadBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error checking contract:', error);
            }
        }

        function downloadContractTemplate() {
            const link = document.createElement('a');
            link.href = '/contract_template.pdf';
            link.download = 'Contrat_Apporteur_Affaires.pdf';
            link.click();
        }

        async function submitContract(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('contractFile');
            const file = fileInput.files[0];

            if (!file) {
                alert(i18next.t('please_select_file') || 'Veuillez s√©lectionner un fichier');
                return;
            }

            if (file.type !== 'application/pdf') {
                alert(i18next.t('only_pdf') || 'Seuls les fichiers PDF sont accept√©s');
                return;
            }

            try {
                const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
                
                const { error } = await supabaseClient.storage
                    .from('contracts')
                    .upload(fileName, file);

                if (error) throw error;

                alert(i18next.t('contract_uploaded') || 'Contrat upload√© avec succ√®s !');
                await checkContractStatus();
                fileInput.value = '';
            } catch (error) {
                console.error('Error uploading contract:', error);
                alert(i18next.t('error_upload') || 'Erreur lors de l\'upload du contrat');
            }
        }

        async function loadReferrerLeads() {
            try {
                const { data, error } = await supabaseClient
                    .from('leads')
                    .select('*')
                    .eq('referrer_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const totalEarnings = data
                    .filter(lead => lead.status === 'vendu')
                    .reduce((sum, lead) => sum + (lead.referrer_commission || 0), 0);
                
                const activeLeads = data.filter(lead => ['nouveau', 'visite', 'offre'].includes(lead.status)).length;
                const closedSales = data.filter(lead => lead.status === 'vendu').length;

                document.getElementById('totalEarnings').textContent = totalEarnings.toLocaleString();
                document.getElementById('activeLeads').textContent = activeLeads;
                document.getElementById('closedSales').textContent = closedSales;

                displayReferrerLeads(data);
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        function displayReferrerLeads(leads) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500" data-i18n="no_leads_yet">Aucun lead pour le moment</td></tr>`;
                updateContent();
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const statusColors = {
                    'nouveau': 'bg-blue-100 text-blue-800',
                    'visite': 'bg-yellow-100 text-yellow-800',
                    'offre': 'bg-purple-100 text-purple-800',
                    'vendu': 'bg-green-100 text-green-800'
                };

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${lead.client_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${i18next.t(lead.lead_type) || lead.lead_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${i18next.t(lead.property_type) || lead.property_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${lead.budget ? lead.budget.toLocaleString() + ' AED' : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[lead.status]}">
                                ${i18next.t('status_' + lead.status) || lead.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold ${lead.referrer_commission ? 'text-green-600' : 'text-gray-400'}">
                            ${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadAdminStats() {
            try {
                const [profilesResult, leadsResult] = await Promise.all([
                    supabaseClient.from('profiles').select('*').eq('role', 'referrer'),
                    supabaseClient.from('leads').select('*')
                ]);

                if (profilesResult.error) throw profilesResult.error;
                if (leadsResult.error) throw leadsResult.error;

                const totalReferrers = profilesResult.data.length;
                const activeLeads = leadsResult.data.filter(lead => ['nouveau', 'visite', 'offre'].includes(lead.status)).length;
                const totalSales = leadsResult.data.filter(lead => lead.status === 'vendu').length;
                const totalCommissions = leadsResult.data
                    .filter(lead => lead.status === 'vendu')
                    .reduce((sum, lead) => sum + (lead.referrer_commission || 0), 0);

                document.getElementById('totalReferrers').textContent = totalReferrers;
                document.getElementById('adminActiveLeads').textContent = activeLeads;
                document.getElementById('totalSales').textContent = totalSales;
                document.getElementById('totalCommissions').textContent = totalCommissions.toLocaleString();
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadAllLeads() {
            try {
                const { data, error } = await supabaseClient
                    .from('leads')
                    .select(`
                        *,
                        referrer:profiles!leads_referrer_id_fkey(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayAdminLeads(data);
            } catch (error) {
                console.error('Error loading all leads:', error);
            }
        }

        function displayAdminLeads(leads) {
            const tbody = document.getElementById('adminLeadsTableBody');
            
            tbody.innerHTML = leads.map(lead => {
                const statusColors = {
                    'nouveau': 'bg-blue-100 text-blue-800',
                    'visite': 'bg-yellow-100 text-yellow-800',
                    'offre': 'bg-purple-100 text-purple-800',
                    'vendu': 'bg-green-100 text-green-800'
                };

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold">${lead.referrer?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${lead.client_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${i18next.t(lead.lead_type) || lead.lead_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${i18next.t(lead.property_type) || lead.property_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${lead.budget ? lead.budget.toLocaleString() + ' AED' : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select onchange="updateLeadStatus(${lead.id}, this.value)" class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[lead.status]} border-0">
                                <option value="nouveau" ${lead.status === 'nouveau' ? 'selected' : ''}>${i18next.t('status_nouveau') || 'Nouveau'}</option>
                                <option value="visite" ${lead.status === 'visite' ? 'selected' : ''}>${i18next.t('status_visite') || 'Visite'}</option>
                                <option value="offre" ${lead.status === 'offre' ? 'selected' : ''}>${i18next.t('status_offre') || 'Offre'}</option>
                                <option value="vendu" ${lead.status === 'vendu' ? 'selected' : ''}>${i18next.t('status_vendu') || 'Vendu'}</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${lead.status !== 'vendu' ? `
                                <button onclick="markAsSold(${lead.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold">
                                    ${i18next.t('mark_sold') || 'Marquer vendu'}
                                </button>
                            ` : `
                                <span class="text-green-600 font-semibold">${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : 'Calcul√©'}</span>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                const { error } = await supabaseClient
                    .from('leads')
                    .update({ status: newStatus })
                    .eq('id', leadId);

                if (error) throw error;

                await loadAllLeads();
                await loadAdminStats();
            } catch (error) {
                console.error('Error updating lead status:', error);
                alert(i18next.t('error_update') || 'Erreur lors de la mise √† jour');
            }
        }

        async function markAsSold(leadId) {
            const salePrice = prompt(i18next.t('enter_sale_price') || 'Entrez le prix de vente (AED):');
            
            if (!salePrice) return;

            const price = parseFloat(salePrice);
            if (isNaN(price) || price <= 0) {
                alert(i18next.t('invalid_price') || 'Prix invalide');
                return;
            }

            try {
                const agentCommission = price * 0.01;
                const referrerCommission = agentCommission * 0.20;

                const { error } = await supabaseClient
                    .from('leads')
                    .update({
                        status: 'vendu',
                        sale_price: price,
                        agent_commission: agentCommission,
                        referrer_commission: referrerCommission,
                        closed_at: new Date().toISOString()
                    })
                    .eq('id', leadId);

                if (error) throw error;

                alert(i18next.t('commission_calculated') || `Commissions calcul√©es:\nAgent: ${agentCommission.toLocaleString()} AED\nApporteur: ${referrerCommission.toLocaleString()} AED`);
                await loadAllLeads();
                await loadAdminStats();
            } catch (error) {
                console.error('Error marking as sold:', error);
                alert(i18next.t('error_mark_sold') || 'Erreur lors du marquage comme vendu');
            }
        }

        // Add Lead Modal functions
        function showAddLeadForm() {
            document.getElementById('addLeadModal').classList.remove('hidden');
        }

        function closeAddLeadForm() {
            document.getElementById('addLeadModal').classList.add('hidden');
            document.getElementById('addLeadFormElement').reset();
        }

        function updateLeadForm() {
            const leadType = document.getElementById('leadType').value;
            // Update form fields based on lead type if needed
        }

        async function handleAddLead(event) {
            event.preventDefault();
            
            const leadData = {
                referrer_id: currentUser.id,
                lead_type: document.getElementById('leadType').value,
                client_name: document.getElementById('clientName').value,
                client_email: document.getElementById('clientEmail').value,
                client_phone: document.getElementById('clientPhone').value,
                property_type: document.getElementById('propertyType').value,
                budget: parseFloat(document.getElementById('budget').value) || null,
                status: 'nouveau'
            };

            try {
                const { error } = await supabaseClient
                    .from('leads')
                    .insert([leadData]);

                if (error) throw error;

                alert(i18next.t('lead_added') || 'Lead ajout√© avec succ√®s !');
                closeAddLeadForm();
                await loadReferrerLeads();
            } catch (error) {
                console.error('Error adding lead:', error);
                alert(i18next.t('error_add_lead') || 'Erreur lors de l\'ajout du lead');
            }
        }

        // Initialize
        window.onload = function() {
            console.log('RENDER called');
            console.log('currentUser:', currentUser);
            console.log('userProfile:', userProfile);
            console.log('currentPage:', currentPage);
            console.log('isPasswordRecoveryMode:', isPasswordRecoveryMode);
            console.log('is2FAMode:', is2FAMode);

            checkAuth();
            
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session);
                if (event === 'SIGNED_IN' && session && !window.opener) {
                    checkAuth();
                } else if (event === 'SIGNED_OUT') {
                    showLandingPage();
                }
            });
        };
    </script>
</body>
</html>
