<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div id="app"></div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    (async () => {
        await i18next
            .use(i18nextHttpBackend)
            .use(i18nextBrowserLanguageDetector)
            .init({
                fallbackLng: 'fr',
                debug: true,
                load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'],
                defaultNS: 'translation',
                backend: {
                    loadPath: '/locales/{{lng}}/{{ns}}.json'
                },
                detection: {
                    order: ['localStorage', 'navigator'],
                    caches: ['localStorage']
                }
            });
        const t = (key) => i18next.t(key);
        async function changeLanguage(langCode) {
            try {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            } catch (error) {
                console.error('Erreur changement de langue:', error);
            }
        }
        window.changeLanguage = changeLanguage;
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
        
        let currentUser = null;
        let userProfile = null;
        let currentPage = 'landing';
        
        window.currentUser = null;
        window.userProfile = null;
        window.currentPage = 'landing';
        function renderLandingPage() {
            return `
                <div class="min-h-screen">
                    <header class="container mx-auto px-4 py-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-yellow-400">${t('nav.brand')}</h1>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                                    <button onclick="changeLanguage('fr')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Français">🇫🇷</button>
                                    <button onclick="changeLanguage('en')" class="text-2xl hover:scale-125 transition-transform duration-200" title="English">🇬🇧</button>
                                    <button onclick="changeLanguage('ar')" class="text-2xl hover:scale-125 transition-transform duration-200" title="العربية">🇦🇪</button>
                                    <button onclick="changeLanguage('ru')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Русский">🇷🇺</button>
                                    <button onclick="changeLanguage('hi')" class="text-2xl hover:scale-125 transition-transform duration-200" title="हिन्दी">🇮🇳</button>
                                    <button onclick="changeLanguage('ur')" class="text-2xl hover:scale-125 transition-transform duration-200" title="اردو">🇵🇰</button>
                                    <button onclick="changeLanguage('zh')" class="text-2xl hover:scale-125 transition-transform duration-200" title="中文">🇨🇳</button>
                                    <button onclick="changeLanguage('tl')" class="text-2xl hover:scale-125 transition-transform duration-200" title="Tagalog">🇵🇭</button>
                                </div>
                                <a href="how-it-works.html" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.how_it_works')}</a>
                                <button onclick="showLogin()" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.login')}</button>
                                <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition">${t('nav.signup')}</button>
                            </div>
                        </div>
                    </header>
                    <main class="container mx-auto px-4 py-20">
                        <div class="text-center mb-12">
                            <h2 class="text-5xl md:text-6xl font-bold mb-6">
                                ${t('hero.title')}
                            </h2>
                            <p class="text-xl text-gray-300 mb-8">
                                ${t('hero.subtitle')}
                            </p>
                            <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-8 py-4 rounded-lg transition transform hover:scale-105">
                                ${t('hero.cta_button')}
                            </button>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6 my-16">
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800&q=80" alt="Burj Khalifa Dubai" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1582672060674-bc2bd808a8b5?w=800&q=80" alt="Dubai Marina" class="w-full h-64 object-cover">
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-2xl">
                                <img src="https://images.unsplash.com/photo-1518684079-3c830dcef090?w=800&q=80" alt="Dubai Skyline" class="w-full h-64 object-cover">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-8 mt-20">
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.commission_value')}</div>
                                <div class="text-gray-300">${t('stats.commission_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.support_value')}</div>
                                <div class="text-gray-300">${t('stats.support_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.timeline_value')}</div>
                                <div class="text-gray-300">${t('stats.timeline_label')}</div>
                            </div>
                        </div>
                        <div class="mt-20 bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-12">
                            <h3 class="text-3xl font-bold text-center mb-12">${t('gains.title')}</h3>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.sale_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.sale_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.sale_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-900 bg-opacity-50 rounded-xl p-8">
                                    <div class="text-yellow-500 text-xl font-bold mb-4">${t('gains.rental_title')}</div>
                                    <div class="space-y-3 text-gray-300">
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_1_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_1_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_2_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_2_commission')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${t('gains.rental_example_3_property')}</span>
                                            <span class="font-bold text-yellow-500">${t('gains.rental_example_3_commission')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }
        function renderAuthPage(mode) {
            let title, buttonText, linkText, linkAction;
            if (mode === 'login') {
                title = t('auth.login_title');
                buttonText = t('auth.login_button');
                linkText = t('auth.no_account');
                linkAction = 'showSignup()';
            } else if (mode === 'signup') {
                title = t('auth.signup_title');
                buttonText = t('auth.signup_button');
                linkText = t('auth.have_account');
                linkAction = 'showLogin()';
            } else if (mode === 'reset') {
                title = t('auth.reset_title');
                buttonText = t('auth.reset_button');
                linkText = t('auth.back_to_login');
                linkAction = 'showLogin()';
            }
            return `
                <div class="min-h-screen flex items-center justify-center px-4">
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 w-full max-w-md">
                        <button onclick="backToHome()" class="text-gray-400 hover:text-white mb-6 flex items-center">
                            ← ${t('auth.back_home')}
                        </button>
                        <h2 class="text-3xl font-bold mb-6 text-center">${title}</h2>
                        <form id="authForm" class="space-y-4">
                            ${mode === 'signup' ? `
                                <div>
                                    <label class="block mb-2">${t('auth.name_label')}</label>
                                    <input type="text" id="name" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block mb-2">${t('auth.phone_label')}</label>
                                    <input type="tel" id="phone" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                            ` : ''}
                            <div>
                                <label class="block mb-2">${t('auth.email_label')}</label>
                                <input type="email" id="email" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                            </div>
                            ${mode !== 'reset' ? `
                                <div>
                                    <label class="block mb-2">${t('auth.password_label')}</label>
                                    <div class="relative">
                                        <input type="password" id="password" required minlength="8" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12">
                                        <button type="button" onclick="togglePasswordVisibility('password', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                                            <span class="text-xl">👁️</span>
                                        </button>
                                    </div>
                                    <div class="text-sm text-gray-400 mt-1">${t('auth.password_hint')}</div>
                                </div>
                            ` : ''}
                            ${mode === 'signup' ? `
                                <div>
                                    <label class="block mb-2">${t('auth.confirm_password_label')}</label>
                                    <div class="relative">
                                        <input type="password" id="confirmPassword" required minlength="8" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none pr-12">
                                        <button type="button" onclick="togglePasswordVisibility('confirmPassword', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                                            <span class="text-xl">👁️</span>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${mode === 'login' ? `
                                <div class="text-right">
                                    <button type="button" onclick="showReset()" class="text-yellow-400 hover:text-yellow-300 text-sm">
                                        ${t('auth.forgot_password')}
                                    </button>
                                </div>
                            ` : ''}
                            <div id="authError" class="text-red-400 text-sm hidden"></div>
                            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                ${buttonText}
                            </button>
                        </form>
                        <p class="text-center mt-6 text-gray-400">
                            <button onclick="${linkAction}" class="text-yellow-400 hover:text-yellow-300">
                                ${linkText}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }
        function renderDashboard() {
            if (!userProfile) {
                return '<div class="min-h-screen flex items-center justify-center"><div class="text-xl">⏳ Chargement du profil...</div></div>';
            }
            const isAdmin = userProfile.role === 'admin';
            const dashboardTitle = isAdmin ? t('dashboard.admin_title') : t('dashboard.referrer_title');
            return `
                <div class="min-h-screen">
                    <header class="bg-gray-800 bg-opacity-50 backdrop-blur-md">
                        <div class="container mx-auto px-4 py-4">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold text-yellow-400">${dashboardTitle}</h1>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-300">${userProfile.name}</span>
                                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">
                                        ${t('dashboard.logout')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    <main class="container mx-auto px-4 py-8">
                        ${userProfile.contract_status === 'signed' ? `
                            <div id="stats" class="grid md:grid-cols-4 gap-6 mb-8"></div>
                            ${!isAdmin ? `
                                <div class="mb-6">
                                    <button onclick="showAddLeadForm()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg transition">
                                        ${t('dashboard.add_lead')}
                                    </button>
                                </div>
                            ` : ''}
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">${isAdmin ? t('dashboard.all_leads') : t('dashboard.my_leads')}</h2>
                                <div id="leadsTable" class="overflow-x-auto"></div>
                            </div>
                        ` : `
                            <div class="bg-yellow-500 bg-opacity-20 border-2 border-yellow-500 rounded-xl p-8 text-center">
                                <div class="text-4xl mb-4">📋</div>
                                <h3 class="text-2xl font-bold mb-4">${t('dashboard.contract_required_title')}</h3>
                                <p class="text-lg mb-6">${t('dashboard.contract_required_message')}</p>
                                <form id="contractForm" class="max-w-md mx-auto">
                                    <input type="file" id="contractFile" accept=".pdf,.jpg,.jpeg,.png" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none mb-4">
                                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                        ${t('dashboard.upload_contract')}
                                    </button>
                                </form>
                            </div>
                        `}
                    </main>
                    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                        <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full">
                            <h3 class="text-2xl font-bold mb-6">${t('dashboard.add_lead')}</h3>
                            <form id="addLeadForm" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block mb-2">${t('dashboard.client_name')}</label>
                                        <input type="text" id="clientName" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard.client_email')}</label>
                                        <input type="email" id="clientEmail" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard.client_phone')}</label>
                                        <input type="tel" id="clientPhone" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard.property_type')}</label>
                                        <select id="propertyType" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                            <option value="">${t('dashboard.select_type')}</option>
                                            <option value="sale_buyer">${t('dashboard.sale_buyer')}</option>
                                            <option value="sale_seller">${t('dashboard.sale_seller')}</option>
                                            <option value="rental_landlord">${t('dashboard.rental_landlord')}</option>
                                            <option value="rental_tenant">${t('dashboard.rental_tenant')}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block mb-2">${t('dashboard.budget')}</label>
                                        <input type="number" id="budget" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                        ${t('dashboard.add')}
                                    </button>
                                    <button type="button" onclick="document.getElementById('addLeadModal').classList.add('hidden')" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-lg transition">
                                        ${t('dashboard.cancel')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        function showLogin() {
            console.log('🔐 showLogin called');
            currentPage = 'auth-login';
            window.currentPage = 'auth-login';
            render();
        }
        function showSignup() {
            console.log('📝 showSignup called');
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
            render();
        }
        function showReset() {
            console.log('🔑 showReset called');
            currentPage = 'auth-reset';
            window.currentPage = 'auth-reset';
            render();
        }
        function backToHome() {
            console.log('🏠 backToHome called');
            currentPage = 'landing';
            window.currentPage = 'landing';
            render();
        }
        function handleAuth(mode) {
            console.log(`🔧 handleAuth called for mode: ${mode}`);
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            if (!form) {
                console.error('❌ Form not found');
                return;
            }
            
            console.log('✅ Form found, attaching handler');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                console.log(`📤 Form submitted for ${mode}`);
                errorDiv.classList.add('hidden');
                const email = document.getElementById('email').value;
                const password = document.getElementById('password')?.value;
                
                try {
                    if (mode === 'signup') {
                        console.log('📝 Processing signup');
                        const name = document.getElementById('name').value;
                        const phone = document.getElementById('phone').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        
                        if (password !== confirmPassword) {
                            errorDiv.textContent = t('auth.password_mismatch');
                            errorDiv.classList.remove('hidden');
                            return;
                        }
                        
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name, phone }
                            }
                        });
                        
                        if (error) throw error;
                        console.log('✅ Signup successful');
                        alert(t('auth.signup_success'));
                        showLogin();
                    } else if (mode === 'login') {
                        console.log('🔐 Processing login');
                        isAuthenticating = true;
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        console.log('✅ Login successful, waiting for auth state change');
                    }
                } catch (error) {
                    console.error('❌ Auth error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                    isAuthenticating = false;
                }
            };
        }
        async function handleReset() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                const email = document.getElementById('email').value;
                
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    if (error) throw error;
                    alert(t('auth.reset_email_sent'));
                    showLogin();
                } catch (error) {
                    console.error('Reset error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        async function loadDashboardContent() {
            if (!userProfile) return;
            
            const isAdmin = userProfile.role === 'admin';
            
            let leads;
            if (isAdmin) {
                const { data, error } = await supabase.from('leads').select(`
                    *,
                    referrer:profiles!leads_referrer_id_fkey(name)
                `).order('created_at', { ascending: false });
                if (error) {
                    console.error('Error loading leads:', error);
                    return;
                }
                leads = data;
            } else {
                const { data, error } = await supabase.from('leads').select('*').eq('referrer_id', currentUser.id).order('created_at', { ascending: false });
                if (error) {
                    console.error('Error loading leads:', error);
                    return;
                }
                leads = data;
            }
            
            const totalEarnings = leads.filter(l => l.status === 'vendu').reduce((sum, l) => sum + (l.referrer_commission || 0), 0);
            const activeLeads = leads.filter(l => l.status !== 'vendu').length;
            const closedSales = leads.filter(l => l.status === 'vendu').length;
            
            document.getElementById('stats').innerHTML = `
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${leads.length}</div>
                        <div class="text-gray-300">${t('dashboard.total_referrers')}</div>
                    </div>
                ` : `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard.total_earnings')}</div>
                    </div>
                `}
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${activeLeads}</div>
                    <div class="text-gray-300">${t('dashboard.active_leads')}</div>
                </div>
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                    <div class="text-3xl font-bold text-yellow-500">${closedSales}</div>
                    <div class="text-gray-300">${t('dashboard.closed_sales')}</div>
                </div>
                ${isAdmin ? `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-6">
                        <div class="text-3xl font-bold text-yellow-500">${totalEarnings.toLocaleString()} AED</div>
                        <div class="text-gray-300">${t('dashboard.commissions_paid')}</div>
                    </div>
                ` : ''}
            `;
            
            const statusColors = {
                'nouveau': 'bg-blue-500',
                'visite': 'bg-yellow-500',
                'offre': 'bg-orange-500',
                'vendu': 'bg-green-500'
            };
            
            document.getElementById('leadsTable').innerHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard.referrer')}</th>` : ''}
                            <th class="text-left py-3 px-4">${t('dashboard.client_name')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard.property_type')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard.budget')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard.status')}</th>
                            <th class="text-left py-3 px-4">${t('dashboard.commission')}</th>
                            ${isAdmin ? `<th class="text-left py-3 px-4">${t('dashboard.actions')}</th>` : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${leads.map(lead => `
                            <tr class="border-b border-gray-700">
                                ${isAdmin ? `<td class="py-3 px-4">${lead.referrer?.name || 'N/A'}</td>` : ''}
                                <td class="py-3 px-4">${lead.client_name}</td>
                                <td class="py-3 px-4">${t('dashboard.' + lead.property_type)}</td>
                                <td class="py-3 px-4">${lead.budget?.toLocaleString()} AED</td>
                                <td class="py-3 px-4">
                                    ${isAdmin ? `
                                        <select onchange="updateLeadStatus(${lead.id}, this.value)" class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            <option value="nouveau" ${lead.status === 'nouveau' ? 'selected' : ''}>${t('dashboard.status_new')}</option>
                                            <option value="visite" ${lead.status === 'visite' ? 'selected' : ''}>${t('dashboard.status_visit')}</option>
                                            <option value="offre" ${lead.status === 'offre' ? 'selected' : ''}>${t('dashboard.status_offer')}</option>
                                            <option value="vendu" ${lead.status === 'vendu' ? 'selected' : ''}>${t('dashboard.status_sold')}</option>
                                        </select>
                                    ` : `
                                        <span class="px-3 py-1 rounded-full ${statusColors[lead.status]} text-gray-900 font-bold text-sm">
                                            ${t('dashboard.status_' + lead.status.replace('é', 'e'))}
                                        </span>
                                    `}
                                </td>
                                <td class="py-3 px-4 font-bold text-yellow-500">
                                    ${lead.referrer_commission ? lead.referrer_commission.toLocaleString() + ' AED' : '-'}
                                </td>
                                ${isAdmin ? `
                                    <td class="py-3 px-4">
                                        ${lead.status !== 'vendu' ? `
                                            <button onclick="markAsSold(${lead.id})" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                                ${t('dashboard.mark_sold')}
                                            </button>
                                        ` : '-'}
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        function showAddLeadForm() {
            document.getElementById('addLeadModal').classList.remove('hidden');
            
            const form = document.getElementById('addLeadForm');
            form.onsubmit = async (e) => {
                e.preventDefault();
                
                const leadData = {
                    referrer_id: currentUser.id,
                    client_name: document.getElementById('clientName').value,
                    client_email: document.getElementById('clientEmail').value,
                    client_phone: document.getElementById('clientPhone').value,
                    property_type: document.getElementById('propertyType').value,
                    budget: parseFloat(document.getElementById('budget').value),
                    status: 'nouveau'
                };
                
                const { error } = await supabase.from('leads').insert([leadData]);
                
                if (error) {
                    console.error('Error adding lead:', error);
                    alert('Erreur lors de l\'ajout du lead');
                    return;
                }
                
                document.getElementById('addLeadModal').classList.add('hidden');
                form.reset();
                await loadDashboardContent();
            };
        }
        async function updateLeadStatus(leadId, newStatus) {
            const { error } = await supabase.from('leads').update({ status: newStatus }).eq('id', leadId);
            
            if (error) {
                console.error('Error updating status:', error);
                alert('Erreur lors de la mise à jour du statut');
                return;
            }
            
            await loadDashboardContent();
        }
        async function markAsSold(leadId) {
            const salePrice = prompt('Prix de vente (AED):');
            if (!salePrice) return;
            
            const price = parseFloat(salePrice);
            const agentCommission = price * 0.01;
            const referrerCommission = agentCommission * 0.20;
            
            const { error } = await supabase.from('leads').update({
                status: 'vendu',
                sale_price: price,
                agent_commission: agentCommission,
                referrer_commission: referrerCommission,
                closed_at: new Date().toISOString()
            }).eq('id', leadId);
            
            if (error) {
                console.error('Error marking as sold:', error);
                alert('Erreur lors de la vente');
                return;
            }
            
            await loadDashboardContent();
        }
        async function handleContractSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('contractFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Veuillez sélectionner un fichier');
                return;
            }
            
            const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabase.storage.from('contracts').upload(fileName, file);
            
            if (uploadError) {
                console.error('Error uploading contract:', uploadError);
                alert('Erreur lors de l\'upload du contrat');
                return;
            }
            
            const { error: updateError } = await supabase.from('profiles').update({
                contract_status: 'uploaded',
                contract_file: fileName
            }).eq('id', currentUser.id);
            
            if (updateError) {
                console.error('Error updating profile:', updateError);
                alert('Erreur lors de la mise à jour du profil');
                return;
            }
            
            await loadUserProfile();
            render();
        }
        async function loadUserProfile(user = null) {
            const targetUser = user || currentUser;
            console.log('🔍 loadUserProfile called for user:', targetUser?.id);
            
            if (!targetUser || !targetUser.id) {
                console.error('❌ No user provided to loadUserProfile');
                return false;
            }
            
            try {
                console.log('🔍 Fetching profile from Supabase for:', targetUser.id);
                const { data, error } = await supabase.from('profiles').select('*').eq('id', targetUser.id).single();
                
                if (error) {
                    console.error('❌ Error loading profile:', error);
                    
                    if (error.code === 'PGRST116') {
                        console.log('📝 Profile does not exist, creating it...');
                        const { data: newProfile, error: insertError } = await supabase.from('profiles').insert([{
                            id: targetUser.id,
                            name: targetUser.user_metadata?.name || targetUser.email.split('@')[0],
                            phone: targetUser.user_metadata?.phone || '',
                            role: 'referrer',
                            contract_status: 'pending'
                        }]).select().single();
                        
                        if (insertError) {
                            console.error('❌ Error creating profile:', insertError);
                            alert('Erreur lors de la création du profil: ' + insertError.message);
                            return false;
                        }
                        
                        console.log('✅ Profile created:', newProfile);
                        userProfile = newProfile;
                        window.userProfile = newProfile;
                        return true;
                    }
                    
                    alert('Erreur lors du chargement du profil: ' + error.message);
                    return false;
                }
                
                console.log('✅ Profile data retrieved:', data);
                
                if (data && data.contract_status) {
                    data.contract_status = data.contract_status.trim().replace(/\*+/g, '');
                }
                
                userProfile = data;
                window.userProfile = data;
                console.log('✅ userProfile set:', userProfile);
                return true;
            } catch (error) {
                console.error('❌ Exception loading profile:', error);
                alert('Exception lors du chargement du profil: ' + error.message);
                return false;
            }
        }
        
        window.loadUserProfile = loadUserProfile;
        
        async function logout() {
            console.log('🚪 Logout called');
            try {
                await supabase.auth.signOut();
                currentUser = null;
                userProfile = null;
                currentPage = 'landing';
                window.currentUser = null;
                window.userProfile = null;
                window.currentPage = 'landing';
                console.log('✅ Logout successful');
                render();
            } catch (error) {
                console.error('❌ Logout error:', error);
                alert('Erreur lors de la déconnexion: ' + error.message);
            }
        }
        async function render() {
            console.log('🎨 RENDER called');
            console.log('- currentUser:', !!currentUser);
            console.log('- userProfile:', !!userProfile);
            console.log('- currentPage:', currentPage);
            
            const app = document.getElementById('app');
            
            if (currentUser && userProfile) {
                console.log('✅ User connected with profile, showing dashboard');
                currentPage = 'dashboard';
                window.currentPage = 'dashboard';
                app.innerHTML = renderDashboard();
                await loadDashboardContent();
                const contractForm = document.getElementById('contractForm');
                if (contractForm) {
                    contractForm.addEventListener('submit', handleContractSubmit);
                }
            } else if (currentUser && !userProfile) {
                console.log('⏳ User connected but no profile, waiting...');
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">⏳</div><div class="text-xl">Chargement de votre profil...</div></div></div>';
            } else if (currentPage === 'auth-login') {
                console.log('🔐 Rendering login page');
                app.innerHTML = renderAuthPage('login');
                setTimeout(() => {
                    console.log('⏱️ Attempting to attach login handler (500ms delay)');
                    handleAuth('login');
                }, 500);
            } else if (currentPage === 'auth-signup') {
                console.log('📝 Rendering signup page');
                app.innerHTML = renderAuthPage('signup');
                setTimeout(() => {
                    console.log('⏱️ Attempting to attach signup handler (500ms delay)');
                    handleAuth('signup');
                }, 500);
            } else if (currentPage === 'auth-reset') {
                console.log('🔑 Rendering reset page');
                app.innerHTML = renderAuthPage('reset');
                setTimeout(() => handleReset(), 500);
            } else {
                console.log('🏠 Rendering landing page');
                app.innerHTML = renderLandingPage();
            }
        }
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.innerHTML = '<span class="text-xl">🙈</span>';
            } else {
                field.type = 'password';
                button.innerHTML = '<span class="text-xl">👁️</span>';
            }
        }
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.showReset = showReset;
        window.logout = logout;
        window.backToHome = backToHome;
        window.showAddLeadForm = showAddLeadForm;
        window.updateLeadStatus = updateLeadStatus;
        window.markAsSold = markAsSold;
        window.handleContractSubmit = handleContractSubmit;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.render = render;
        
        console.log('⏳ Displaying initial loader');
        document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">⏳</div><div class="text-xl">Chargement...</div></div></div>';
        
        let isAuthenticating = false;
        let initialLoadComplete = false;
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('🔔 Auth state changed:', event);
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            
            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('⚠️ Email not confirmed, signing out');
                await supabase.auth.signOut();
                currentUser = null;
                window.currentUser = null;
            }
            
            if (currentUser) {
                console.log('👤 User authenticated, loading profile...');
                const profileLoaded = await loadUserProfile(currentUser);
                if (!profileLoaded) {
                    console.error('❌ Failed to load profile, signing out');
                    await supabase.auth.signOut();
                    currentUser = null;
                    window.currentUser = null;
                    userProfile = null;
                    window.userProfile = null;
                }
            }
            render();
        });
        
        console.log('🔍 Getting initial session...');
        supabase.auth.getSession().then(async ({ data: { session }, error }) => {
            if (error) {
                console.error('❌ Session error:', error);
                currentUser = null;
                window.currentUser = null;
                render();
                initialLoadComplete = true;
                return;
            }
            
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            
            if (currentUser && !currentUser.email_confirmed_at) {
                console.warn('⚠️ Email not confirmed on init, cleaning session');
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                currentUser = null;
                window.currentUser = null;
                render();
                initialLoadComplete = true;
                return;
            }
            
            if (currentUser) {
                console.log('👤 Session found, loading profile...');
                const profileLoaded = await loadUserProfile(currentUser);
                if (!profileLoaded) {
                    console.error('❌ Failed to load profile on init, signing out');
                    await supabase.auth.signOut();
                    localStorage.clear();
                    sessionStorage.clear();
                    currentUser = null;
                    window.currentUser = null;
                    userProfile = null;
                    window.userProfile = null;
                }
            }
            render();
            initialLoadComplete = true;
        }).catch((err) => {
            console.error('❌ Fatal session error:', err);
            currentUser = null;
            window.currentUser = null;
            render();
            initialLoadComplete = true;
        });
    })();
    </script>
</body>
</html>
