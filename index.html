<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Estate Referrer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body class="text-white">
  <div id="app"></div>

  <script type="module">
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      'https://cgizcgwhwxswvoodqver.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc'
    );

    let currentUser = null;
    let currentProfile = null;

    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        currentUser = session.user;
        loadProfile();
      } else {
        showLanding();
      }
    });

    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        currentUser = session.user;
        loadProfile();
      }
    });

    async function loadProfile() {
      const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      currentProfile = data;
      data.role === 'admin' ? showAdminDashboard() : showReferrerDashboard();
    }

    function showLanding() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center">
          <div class="text-center">
            <h1 class="text-6xl font-bold mb-6">Dubai Real Estate</h1>
            <button onclick="showAuthPage('login')" class="bg-yellow-500 text-gray-900 font-bold px-8 py-3 rounded-lg mr-4">Connexion</button>
            <button onclick="showAuthPage('signup')" class="bg-white text-gray-900 font-bold px-8 py-3 rounded-lg">S'inscrire</button>
          </div>
        </div>
      `;
    }

    function showAuthPage(type) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center px-4">
          <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full">
            <h2 class="text-3xl font-bold mb-6 text-yellow-500">${type === 'login' ? 'Connexion' : 'Inscription'}</h2>
            
            ${type === 'login' ? `
              <form id="form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <input type="password" id="password" placeholder="Mot de passe" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg">Connexion</button>
              </form>
            ` : `
              <form id="form" class="space-y-4">
                <input type="text" id="name" placeholder="Nom" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <input type="email" id="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <input type="tel" id="phone" placeholder="Téléphone" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <input type="password" id="password" placeholder="Mot de passe" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <input type="password" id="password2" placeholder="Confirmer" required class="w-full px-4 py-3 bg-gray-700 rounded-lg text-white">
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg">S'inscrire</button>
              </form>
            `}
          </div>
        </div>
      `;

      document.getElementById('form').onsubmit = async (e) => {
        e.preventDefault();
        if (type === 'login') {
          const { error } = await supabase.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
          });
          if (error) alert('Erreur: ' + error.message);
        } else {
          const pw = document.getElementById('password').value;
          const pw2 = document.getElementById('password2').value;
          if (pw !== pw2) { alert('Mots de passe différents'); return; }
          const { error } = await supabase.auth.signUp({
            email: document.getElementById('email').value,
            password: pw,
            options: {
              data: {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                role: 'referrer'
              }
            }
          });
          if (error) alert('Erreur: ' + error.message);
          else { alert('Compte créé !'); showAuthPage('login'); }
        }
      };
    }

    async function showReferrerDashboard() {
      const { data: leads } = await supabase.from('leads').select('*').eq('referrer_id', currentUser.id);
      const total = leads.reduce((s, l) => s + (l.referrer_commission || 0), 0);

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-gray-900 p-4">
            <div class="flex justify-between items-center max-w-7xl mx-auto">
              <h1 class="text-xl font-bold text-yellow-500">Dashboard Apporteur</h1>
              <button onclick="logout()" class="text-white">Déconnexion</button>
            </div>
          </nav>
          <div class="max-w-7xl mx-auto p-8">
            <div class="bg-gray-800 rounded-xl p-6 mb-8">
              <div class="text-sm text-gray-400">Gains totaux</div>
              <div class="text-3xl font-bold text-yellow-500">${total.toLocaleString()} AED</div>
            </div>
            <button onclick="addLead()" class="bg-yellow-500 text-gray-900 font-bold px-6 py-3 rounded-lg mb-6">+ Ajouter un lead</button>
            <div class="bg-gray-800 rounded-xl overflow-hidden">
              <table class="w-full">
                <thead class="bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left">Client</th>
                    <th class="px-6 py-3 text-left">Status</th>
                    <th class="px-6 py-3 text-left">Commission</th>
                  </tr>
                </thead>
                <tbody>
                  ${leads.map(l => `
                    <tr class="border-t border-gray-700">
                      <td class="px-6 py-4">${l.client_name}</td>
                      <td class="px-6 py-4">${l.status}</td>
                      <td class="px-6 py-4">${l.referrer_commission ? l.referrer_commission.toLocaleString() + ' AED' : '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    async function showAdminDashboard() {
      console.log('🔵 DÉBUT showAdminDashboard');
      
      const { data: allProfiles, error: profilesError } = await supabase.from('profiles').select('*');
      const { data: allLeads, error: leadsError } = await supabase.from('leads').select('*');

      console.log('📊 PROFILES récupérés:', allProfiles);
      console.log('📊 LEADS récupérés:', allLeads);

      if (profilesError) console.error('❌ Erreur profiles:', profilesError);
      if (leadsError) console.error('❌ Erreur leads:', leadsError);

      const profileMap = {};
      if (allProfiles) {
        allProfiles.forEach(p => {
          console.log(`➕ Ajout au map: ${p.id} → ${p.name}`);
          profileMap[p.id] = p;
        });
      }

      console.log('🗺️ PROFILE MAP FINAL:', profileMap);

      const referrers = allProfiles ? allProfiles.filter(p => p.role === 'referrer') : [];
      const total = allLeads ? allLeads.reduce((s, l) => s + (l.referrer_commission || 0), 0) : 0;

      console.log('📈 Stats - Referrers:', referrers.length, 'Total:', total);

      // Pour chaque lead, logger ce qui se passe
      if (allLeads) {
        allLeads.forEach(lead => {
          const ref = profileMap[lead.referrer_id];
          console.log(`🔎 Lead "${lead.client_name}":`, {
            referrer_id: lead.referrer_id,
            profile_trouvé: ref ? 'OUI' : 'NON',
            nom: ref ? ref.name : 'N/A'
          });
        });
      }

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-gray-900 p-4">
            <div class="flex justify-between items-center max-w-7xl mx-auto">
              <h1 class="text-xl font-bold text-yellow-500">Admin Dashboard</h1>
              <button onclick="logout()" class="text-white">Déconnexion</button>
            </div>
          </nav>
          <div class="max-w-7xl mx-auto p-8">
            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400">Apporteurs</div>
                <div class="text-3xl font-bold text-blue-400">${referrers.length}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400">Leads</div>
                <div class="text-3xl font-bold text-yellow-500">${allLeads ? allLeads.length : 0}</div>
              </div>
              <div class="bg-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-400">Commissions</div>
                <div class="text-3xl font-bold text-yellow-500">${total.toLocaleString()} AED</div>
              </div>
            </div>
            <div class="bg-gray-800 rounded-xl overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold">Tous les leads</h3>
              </div>
              <table class="w-full">
                <thead class="bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left">Apporteur</th>
                    <th class="px-6 py-3 text-left">Client</th>
                    <th class="px-6 py-3 text-left">Budget</th>
                    <th class="px-6 py-3 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${allLeads ? allLeads.map(l => {
                    const ref = profileMap[l.referrer_id];
                    const displayName = ref && ref.name ? ref.name : 'N/A';
                    return `
                      <tr class="border-t border-gray-700">
                        <td class="px-6 py-4">${displayName}</td>
                        <td class="px-6 py-4">${l.client_name}</td>
                        <td class="px-6 py-4">${l.budget.toLocaleString()} AED</td>
                        <td class="px-6 py-4">${l.status}</td>
                      </tr>
                    `;
                  }).join('') : '<tr><td colspan="4" class="px-6 py-4 text-center">Aucun lead</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    window.addLead = () => alert('Fonction à venir');
    window.showAuthPage = showAuthPage;
    window.logout = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      showLanding();
    };
  </script>
</body>
</html>
