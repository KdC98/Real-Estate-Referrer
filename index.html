<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- intl-tel-input -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    
    <!-- Version: 3.20.4 - Timeout loadUserProfile + fallback profil -->
    
<style>
.iti { width: 100% !important; display: block !important; }
.iti input[type="tel"], .iti input#phone, .iti input#completionPhone, .iti input#clientPhone, .iti--separate-dial-code input[type="tel"] {
    width: 100% !important; box-sizing: border-box !important;
    padding: 0.75rem 1rem 0.75rem 95px !important;
    background: rgba(51, 65, 85, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem !important; color: white !important;
}
.iti input#phone, .iti--separate-dial-code input#phone { padding: 0.5rem 1rem 0.5rem 95px !important; }
.iti input[type="tel"]:focus { border-color: #eab308 !important; box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.3) !important; outline: none !important; }
.iti input[type="tel"]::placeholder { color: rgba(191, 219, 254, 0.5) !important; }
.iti__flag-container { padding: 0 !important; }
.iti__selected-flag { background: rgba(51, 65, 85, 0.8) !important; border-radius: 0.5rem 0 0 0.5rem !important; padding: 0 8px !important; height: 100% !important; }
.iti__selected-flag:hover { background: rgba(51, 65, 85, 1) !important; }
.iti__arrow { border-top-color: white !important; }
.iti__arrow--up { border-bottom-color: white !important; }
.iti__country-list { background: #1e293b !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 0.5rem !important; max-height: 200px !important; z-index: 9999 !important; }
.iti__country { padding: 8px 12px !important; color: white !important; }
.iti__country:hover { background: rgba(234, 179, 8, 0.2) !important; }
.iti__country.iti__highlight { background: rgba(234, 179, 8, 0.3) !important; }
.iti__dial-code { color: #94a3b8 !important; }
.iti__country-name { color: white !important; }
.iti--separate-dial-code .iti__selected-flag { background: rgba(51, 65, 85, 0.8) !important; }
.iti--separate-dial-code .iti__selected-dial-code { color: white !important; margin-left: 6px !important; }
</style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    
    <script type="module">
        // ============================================
        // v3.20.4 - Timeout loadUserProfile + fallback
        // ============================================
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './js/config.js';
        import * as VALIDATION from './js/validation.js';
        window.VALIDATION = VALIDATION;
        import * as UTILS from './js/utils.js';
        import * as AUTH from './js/auth.js';
        import * as DASHBOARD from './js/dashboard.js';
        import * as LEADS from './js/leads.js';
        import * as TFA from './js/2fa.js';
        import * as RENDERING from './js/rendering.js';

        (async () => {
            console.log('üöÄ App starting v3.20.4...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = window.location.hash;
            const hasCodeParam = urlParams.get('code') !== null;
            const hasHashToken = hashParams.includes('access_token');
            const hasError = hashParams.includes('error') || urlParams.get('error') !== null;
            const isOAuthReturn = hasCodeParam || hasHashToken;
            const isContractSignedReturn = urlParams.get('signed') !== null;
            
            if (isOAuthReturn) console.log('üîÑ OAuth return detected');
            if (hasError) console.error('‚ùå OAuth error in URL');
            
            if (isContractSignedReturn && !isOAuthReturn) {
                window.history.replaceState(null, '', window.location.pathname);
            }
            
            if (isOAuthReturn && !hasError) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4 animate-spin">üîÑ</div>
                            <div class="text-xl text-blue-200">Connexion en cours...</div>
                        </div>
                    </div>
                `;
            }

            // i18next
            await i18next.use(i18nextHttpBackend).use(i18nextBrowserLanguageDetector).init({
                fallbackLng: 'fr', debug: false, load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'], defaultNS: 'translation',
                backend: { loadPath: '/locales/{{lng}}/{{ns}}.json' },
                detection: { order: ['localStorage', 'navigator'], caches: ['localStorage'] }
            });
            console.log('üåê Loading translations...');
            await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
            console.log('‚úÖ All translations loaded!');
            const t = (key) => window.i18next.t(key);

            async function changeLanguage(langCode) {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            }
            window.changeLanguage = changeLanguage;

            // Supabase
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true,
                    flowType: 'pkce'
                }
            });
            
            window.supabase = supabase;
            window.SUPABASE_URL = SUPABASE_URL;
            window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

            const oauthTranslations = {
                fr: { security_info: "Information de s√©curit√©", redirect_message: "Vous allez √™tre redirig√© vers notre service d'authentification s√©curis√© <strong>(Supabase)</strong> pour vous connecter avec", normal_secure: "C'est normal et s√©curis√©.", will_return: "Vous reviendrez automatiquement sur notre site apr√®s connexion.", continue_btn: "Continuer", cancel_btn: "Annuler" },
                en: { security_info: "Security Information", redirect_message: "You will be redirected to our secure authentication service <strong>(Supabase)</strong> to sign in with", normal_secure: "This is normal and secure.", will_return: "You will automatically return to our site after signing in.", continue_btn: "Continue", cancel_btn: "Cancel" }
            };

            // State
            let currentUser = null;
            let userProfile = null;
            let profileLoadAttempts = 0;
            const MAX_PROFILE_LOAD_ATTEMPTS = 3; // R√©duit de 10 √† 3
            let currentPage = 'landing';
            let isPasswordRecoveryMode = false;
            let is2FAMode = false;
            let isSignupInProgress = false;
            let tempPhone = null;
            let pendingSignupId = null;
            let contractJustSigned = isContractSignedReturn;
            let isRendering = false;
            let initialLoadComplete = false;
            let waitingForOAuth = isOAuthReturn;
            let phoneInputInstances = {};

            window.currentUser = null;
            window.userProfile = null;
            window.currentPage = 'landing';
            window.contractJustSigned = contractJustSigned;
            window.tempPhone = null;
            window.pendingSignupId = null;

            window.setCurrentPage = (p) => { currentPage = p; window.currentPage = p; };
            window.setIs2FAMode = (v) => { is2FAMode = v; window.is2FAMode = v; };
            window.setTempPhone = (p) => { tempPhone = p; window.tempPhone = p; };
            window.setPendingSignupId = (id) => { pendingSignupId = id; window.pendingSignupId = id; };

            if (urlParams.get('action') === 'signup') {
                currentPage = 'auth-signup';
                window.currentPage = 'auth-signup';
            }

            // Helpers
            function wait2Frames() { return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r))); }
            function waitFonts() { return document.fonts?.ready || Promise.resolve(); }
            
            // ‚úÖ v3.20.4: Promise avec timeout
            function withTimeout(promise, ms, fallback = null) {
                return Promise.race([
                    promise,
                    new Promise((resolve) => setTimeout(() => {
                        console.warn(`‚è∞ Timeout after ${ms}ms`);
                        resolve(fallback);
                    }, ms))
                ]);
            }
            
            function initPhoneInput(inputId, initialNumber = '') {
                const input = document.getElementById(inputId);
                if (!input) return null;
                if (phoneInputInstances[inputId]) { phoneInputInstances[inputId].destroy(); delete phoneInputInstances[inputId]; }
                const iti = window.intlTelInput(input, {
                    initialCountry: "ae", preferredCountries: ["ae", "in", "pk", "ph", "gb", "fr", "ru", "cn", "sa", "eg", "us", "ca", "de", "lb", "jo"],
                    separateDialCode: true, nationalMode: false, autoPlaceholder: "polite", formatOnDisplay: true,
                    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
                });
                phoneInputInstances[inputId] = iti;
                if (initialNumber) iti.setNumber(initialNumber);
                return iti;
            }
            window.initPhoneInput = initPhoneInput;

            async function initPhoneInputForModal(inputId, initialNumber = '') {
                const input = document.getElementById(inputId);
                if (!input) return null;
                if (phoneInputInstances[inputId]) { phoneInputInstances[inputId].destroy(); delete phoneInputInstances[inputId]; }
                const iti = window.intlTelInput(input, {
                    initialCountry: "ae", preferredCountries: ["ae", "in", "pk", "ph", "gb", "fr", "ru", "cn", "sa", "eg", "us", "ca", "de", "lb", "jo"],
                    separateDialCode: true, nationalMode: false, autoPlaceholder: "polite", formatOnDisplay: true,
                    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
                });
                phoneInputInstances[inputId] = iti;
                if (initialNumber) iti.setNumber(initialNumber);
                if (iti.promise) await iti.promise;
                await wait2Frames(); await waitFonts();
                const forceRecalc = () => { iti.setCountry(iti.getSelectedCountryData().iso2); window.dispatchEvent(new Event("resize")); };
                forceRecalc(); await new Promise(r => setTimeout(r, 50)); forceRecalc();
                return iti;
            }
            window.initPhoneInputForModal = initPhoneInputForModal;

            function getFullPhoneNumber(inputId) {
                const iti = phoneInputInstances[inputId];
                return iti ? iti.getNumber() : (document.getElementById(inputId)?.value || '');
            }
            window.getFullPhoneNumber = getFullPhoneNumber;

            // Auth handlers
            function handleAuth(mode) {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                if (errorDiv) { errorDiv.textContent = ''; errorDiv.classList.add('hidden'); }
                if (!form) return;
                if (mode === 'signup') setTimeout(() => initPhoneInput('phone'), 100);

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password')?.value;

                    try {
                        if (mode === 'signup') {
                            const name = document.getElementById('name').value.trim();
                            const fullPhone = getFullPhoneNumber('phone');
                            const confirmPassword = document.getElementById('confirmPassword').value;
                            if (!VALIDATION.validateName(name)) throw new Error('Nom invalide');
                            if (!VALIDATION.validatePhone(fullPhone)) throw new Error('T√©l√©phone invalide');
                            if (!VALIDATION.validateEmail(email)) throw new Error('Email invalide');
                            if (!VALIDATION.validatePassword(password)) throw new Error('Mot de passe invalide');
                            if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));

                            const phoneCheck = await TFA.checkPhoneExists(fullPhone);
                            if (phoneCheck.exists) { errorDiv.textContent = 'Num√©ro d√©j√† utilis√©'; errorDiv.classList.remove('hidden'); return; }

                            const submitButton = document.getElementById('submitButton');
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Envoi SMS...';

                            isSignupInProgress = true;
                            const smsResult = await TFA.send2FACode(fullPhone, i18next.language || 'fr', { email, password, name, phone: fullPhone, email_opt_in: document.getElementById('emailOptIn')?.checked || false });
                            if (!smsResult.success) throw new Error('Erreur SMS');
                            tempPhone = fullPhone; window.tempPhone = fullPhone;
                            is2FAMode = true; window.is2FAMode = true;
                            isSignupInProgress = false;
                            render();
                        } else if (mode === 'login') {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                        }
                    } catch (error) {
                        let msg = error.message;
                        if (msg.includes('Invalid login')) msg = 'Email ou mot de passe incorrect';
                        errorDiv.textContent = msg; errorDiv.classList.remove('hidden');
                        if (mode === 'signup') { document.getElementById('submitButton').disabled = false; document.getElementById('submitButton').textContent = t('auth:signup_button'); }
                    }
                };
            }

            async function handleReset() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                form.onsubmit = async (e) => {
                    e.preventDefault(); errorDiv.classList.add('hidden');
                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(document.getElementById('email').value, { redirectTo: window.location.origin });
                        if (error) throw error;
                        alert(t('auth:reset_email_sent')); UTILS.showLogin();
                    } catch (error) { errorDiv.textContent = error.message; errorDiv.classList.remove('hidden'); }
                };
            }

            function showOAuthWarning(provider) {
                const modal = document.getElementById('oauthWarningModal');
                const trans = oauthTranslations[i18next.language?.split('-')[0]] || oauthTranslations.fr;
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full border border-yellow-500/50">
                            <div class="text-center mb-6"><div class="text-5xl mb-4">‚ö†Ô∏è</div><h3 class="text-2xl font-bold text-yellow-400">${trans.security_info}</h3></div>
                            <p class="text-blue-200 mb-6">${trans.redirect_message} ${provider === 'google' ? 'Google' : 'Apple'}.</p>
                            <p class="text-blue-200 mb-6"><span class="text-green-400 font-semibold">‚úì ${trans.normal_secure}</span><br>${trans.will_return}</p>
                            <div class="flex gap-4">
                                <button onclick="proceedWithOAuth('${provider}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg">${trans.continue_btn}</button>
                                <button onclick="closeOAuthWarning()" class="flex-1 bg-white/20 hover:bg-white/30 text-white font-bold py-3 rounded-lg border border-white/20">${trans.cancel_btn}</button>
                            </div>
                        </div>
                    </div>`;
                modal.classList.remove('hidden');
            }
            function closeOAuthWarning() { const m = document.getElementById('oauthWarningModal'); m.classList.add('hidden'); m.innerHTML = ''; }
            async function proceedWithOAuth(provider) {
                closeOAuthWarning();
                const { error } = await supabase.auth.signInWithOAuth({ provider, options: { redirectTo: window.location.origin } });
                if (error) alert('Erreur: ' + error.message);
            }
            async function signInWithGoogle() { showOAuthWarning('google'); }
            async function signInWithApple() { showOAuthWarning('apple'); }

            async function handleChangePassword() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                form.onsubmit = async (e) => {
                    e.preventDefault(); errorDiv.classList.add('hidden');
                    const np = document.getElementById('newPassword').value;
                    const cp = document.getElementById('confirmNewPassword').value;
                    if (np !== cp) { errorDiv.textContent = 'Mots de passe diff√©rents'; errorDiv.classList.remove('hidden'); return; }
                    if (np.length < 8) { errorDiv.textContent = 'Min 8 caract√®res'; errorDiv.classList.remove('hidden'); return; }
                    try {
                        const { error } = await supabase.auth.updateUser({ password: np });
                        if (error) throw error;
                        isPasswordRecoveryMode = false; alert('‚úÖ Mot de passe chang√© !');
                        await supabase.auth.signOut(); UTILS.showLogin();
                    } catch (error) { errorDiv.textContent = error.message; errorDiv.classList.remove('hidden'); }
                };
            }

            // ‚úÖ v3.20.4: loadUserProfile avec timeout
            async function loadUserProfile(user = null) {
                const u = user || currentUser;
                console.log('üîç loadUserProfile for:', u?.id);
                if (!u?.id) { console.warn('‚ö†Ô∏è No user for loadUserProfile'); return false; }

                // Cr√©er un profil temporaire imm√©diatement
                const tempProfile = {
                    id: u.id,
                    name: u.user_metadata?.full_name || u.user_metadata?.name || u.email?.split('@')[0] || 'User',
                    email: u.email,
                    phone: u.user_metadata?.phone || '',
                    role: 'referrer',
                    contract_status: 'pending',
                    phone_verified: false
                };

                try {
                    console.log('üì° Fetching profile from Supabase...');
                    
                    // ‚úÖ v3.20.4: Timeout de 5 secondes
                    const result = await withTimeout(
                        supabase.from('profiles').select('*').eq('id', u.id).maybeSingle(),
                        5000,
                        { data: null, error: { message: 'Timeout' } }
                    );
                    
                    const { data, error } = result || { data: null, error: null };
                    
                    console.log('üì° Supabase response:', { data, error });
                    
                    if (error && error.message !== 'Timeout' && error.code !== 'PGRST116') {
                        console.error('‚ùå Profile DB error:', error);
                        // Utiliser le profil temporaire
                        userProfile = tempProfile;
                        window.userProfile = userProfile;
                        console.log('‚ö†Ô∏è Using temp profile due to error');
                        return true;
                    }

                    if (!data) {
                        console.log('üìù No profile found, creating...');
                        
                        // Essayer de cr√©er avec timeout
                        const insertResult = await withTimeout(
                            supabase.from('profiles').upsert([tempProfile], { onConflict: 'id' }).select().single(),
                            5000,
                            { data: null, error: { message: 'Insert timeout' } }
                        );
                        
                        if (insertResult?.data) {
                            userProfile = insertResult.data;
                            console.log('‚úÖ Profile created:', userProfile.name);
                        } else {
                            console.warn('‚ö†Ô∏è Insert failed, using temp profile');
                            userProfile = tempProfile;
                        }
                    } else {
                        userProfile = data;
                        if (userProfile.contract_status) {
                            userProfile.contract_status = userProfile.contract_status.trim().replace(/\*+/g, '');
                        }
                        console.log('‚úÖ Profile loaded:', userProfile.name);
                    }
                    
                    window.userProfile = userProfile;
                    return true;
                    
                } catch (err) {
                    console.error('‚ùå loadUserProfile exception:', err);
                    // Fallback au profil temporaire
                    userProfile = tempProfile;
                    window.userProfile = userProfile;
                    console.log('‚ö†Ô∏è Using temp profile due to exception');
                    return true;
                }
            }
            window.loadUserProfile = loadUserProfile;

            async function logout() {
                try { await supabase.auth.signOut(); } catch(e) {}
                try { localStorage.clear(); sessionStorage.clear(); } catch(e) {}
                currentUser = null; userProfile = null; currentPage = 'landing';
                window.currentUser = null; window.userProfile = null; window.currentPage = 'landing';
                setTimeout(() => { window.location.href = window.location.origin; }, 100);
            }
            window.logout = logout;

            // Render
            async function render() {
                if (isRendering) { console.log('‚è≥ Render already in progress'); return; }
                
                if (waitingForOAuth && !currentUser) {
                    console.log('‚è≥ Waiting for OAuth session...');
                    return;
                }
                
                isRendering = true;
                console.log('üé® RENDER - user:', !!currentUser, 'profile:', !!userProfile, 'page:', currentPage);

                const app = document.getElementById('app');

                if (contractJustSigned && currentUser && userProfile) {
                    contractJustSigned = false; window.contractJustSigned = false;
                    await loadUserProfile(currentUser);
                    setTimeout(() => {
                        const d = document.createElement('div');
                        d.innerHTML = `<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce"><span class="text-3xl mr-2">‚úÖ</span><strong>Contrat sign√© !</strong></div>`;
                        document.body.appendChild(d); setTimeout(() => d.remove(), 5000);
                    }, 500);
                }

                if (is2FAMode) {
                    app.innerHTML = RENDERING.renderAuthPage('2fa');
                    document.getElementById('form2FA').onsubmit = TFA.handle2FASubmit;
                    document.getElementById('code2fa')?.focus();
                    isRendering = false; return;
                }

                if (isPasswordRecoveryMode && currentPage === 'change-password') {
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);
                    isRendering = false; return;
                }

                if (currentUser && userProfile) {
                    const isComplete = RENDERING.isProfileComplete(userProfile);
                    
                    if (!isComplete && userProfile.role !== 'admin') {
                        currentPage = 'profile-completion'; window.currentPage = 'profile-completion';
                        app.innerHTML = RENDERING.renderDashboard() + RENDERING.renderProfileCompletionModal();
                        
                        setTimeout(async () => { await initPhoneInputForModal('completionPhone', userProfile.phone || ''); }, 100);
                        
                        setTimeout(() => {
                            const form = document.getElementById('profileCompletionForm');
                            if (form) {
                                form.onsubmit = async (e) => {
                                    e.preventDefault();
                                    const btn = document.getElementById('completionSubmitBtn');
                                    const err = document.getElementById('completionError');
                                    btn.disabled = true; btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>...';
                                    err.classList.add('hidden');
                                    try {
                                        const name = document.getElementById('completionName')?.value?.trim() || '';
                                        const email = document.getElementById('completionEmail')?.value?.trim() || '';
                                        const phone = getFullPhoneNumber('completionPhone');
                                        const address = document.getElementById('completionAddress')?.value?.trim() || '';
                                        const area = document.getElementById('completionArea')?.value?.trim() || '';
                                        const emirate = document.getElementById('completionEmirate')?.value || '';
                                        if (!name || name.length < 2) throw new Error('Nom requis');
                                        if (!email || !email.includes('@') || email.includes('privaterelay')) throw new Error('Email valide requis');
                                        if (!phone || phone.length < 8) throw new Error('T√©l√©phone requis');
                                        if (!address) throw new Error('Adresse requise');
                                        if (!emirate) throw new Error('√âmirat requis');
                                        const fullAddr = area ? `${address}, ${area}, ${emirate}` : `${address}, ${emirate}`;
                                        const { error } = await supabase.from('profiles').update({ name, email, phone, address: fullAddr }).eq('id', currentUser.id);
                                        if (error) throw error;
                                        await loadUserProfile(currentUser);
                                        document.getElementById('profileCompletionModal')?.remove();
                                        currentPage = 'dashboard'; window.currentPage = 'dashboard';
                                        isRendering = false; render();
                                    } catch (ex) { err.textContent = ex.message; err.classList.remove('hidden'); btn.disabled = false; btn.textContent = 'Enregistrer ‚Üí'; }
                                };
                            }
                        }, 150);
                        isRendering = false; return;
                    }
                    
                    currentPage = 'dashboard'; window.currentPage = 'dashboard';
                    app.innerHTML = RENDERING.renderDashboard();
                    await DASHBOARD.loadDashboardContent();
                    isRendering = false; return;

                } else if (currentUser && !userProfile) {
                    // ‚úÖ v3.20.4: R√©duit √† 3 tentatives max
                    profileLoadAttempts++;
                    console.log(`‚è≥ Profile retry ${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS}`);
                    
                    if (profileLoadAttempts >= MAX_PROFILE_LOAD_ATTEMPTS) {
                        console.log('‚ö†Ô∏è Max attempts reached, creating fallback profile');
                        // Cr√©er un profil en m√©moire et continuer
                        userProfile = {
                            id: currentUser.id,
                            name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                            email: currentUser.email,
                            phone: '',
                            role: 'referrer',
                            contract_status: 'pending'
                        };
                        window.userProfile = userProfile;
                        profileLoadAttempts = 0;
                        isRendering = false;
                        render();
                        return;
                    }
                    
                    app.innerHTML = `<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">‚è≥</div><div class="text-xl text-blue-200">Chargement... (${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS})</div></div></div>`;
                    isRendering = false;
                    setTimeout(() => loadUserProfile().then(() => render()), 2000);
                    return;

                } else if (currentPage === 'auth-login') {
                    app.innerHTML = RENDERING.renderAuthPage('login');
                    setTimeout(() => handleAuth('login'), 500);
                } else if (currentPage === 'auth-signup') {
                    app.innerHTML = RENDERING.renderAuthPage('signup');
                    setTimeout(() => { handleAuth('signup'); VALIDATION.attachPasswordValidation?.(); }, 500);
                } else if (currentPage === 'auth-reset') {
                    app.innerHTML = RENDERING.renderAuthPage('reset');
                    setTimeout(() => handleReset(), 500);
                } else if (currentPage === 'change-password') {
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);
                } else {
                    app.innerHTML = RENDERING.renderLandingPage();
                }
                isRendering = false;
            }

            // Expose functions
            window.showAddLeadForm = LEADS.showAddLeadForm;
            window.closeAddLeadModal = LEADS.closeAddLeadModal;
            window.addLead = LEADS.addLead;
            window.updateLeadStatus = LEADS.updateLeadStatus;
            window.markAsSold = LEADS.markAsSold;
            window.renderAddLeadModal = LEADS.renderAddLeadModal;
            window.togglePasswordVisibility = VALIDATION.togglePasswordVisibility;
            window.validateName = VALIDATION.validateName;
            window.validatePhone = VALIDATION.validatePhone;
            window.validateEmail = VALIDATION.validateEmail;
            window.validatePassword = VALIDATION.validatePassword;
            window.validateConfirmPassword = VALIDATION.validateConfirmPassword;
            window.checkFormValidity = VALIDATION.checkFormValidity;
            window.prefillTestData = UTILS.prefillTestData;
            window.render = render;
            window.loadDashboardContent = DASHBOARD.loadDashboardContent;
            window.handleChangePassword = handleChangePassword;
            window.downloadContractTemplate = UTILS.downloadContractTemplate;
            window.checkPhoneExists = TFA.checkPhoneExists;
            window.handle2FASubmit = TFA.handle2FASubmit;
            window.resend2FACode = TFA.resend2FACode;
            window.signInWithGoogle = signInWithGoogle;
            window.signInWithApple = signInWithApple;
            window.showOAuthWarning = showOAuthWarning;
            window.closeOAuthWarning = closeOAuthWarning;
            window.proceedWithOAuth = proceedWithOAuth;
            window.toggleMobileMenu = UTILS.toggleMobileMenu;
            window.showLogin = UTILS.showLogin;
            window.showSignup = UTILS.showSignup;
            window.showReset = UTILS.showReset;
            window.backToHome = UTILS.backToHome;
            window.backTo2FASignup = function() { is2FAMode = false; tempPhone = null; pendingSignupId = null; currentPage = 'auth-signup'; window.currentPage = 'auth-signup'; render(); };
            window.renderLandingPage = RENDERING.renderLandingPage;
            window.renderAuthPage = RENDERING.renderAuthPage;
            window.renderDashboard = RENDERING.renderDashboard;
            window.logout = logout;

            // Auth state handler
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('üîî Auth event:', event, session?.user?.email || 'no session');

                if (isSignupInProgress && event !== 'SIGNED_IN') return;

                if (event === 'PASSWORD_RECOVERY') {
                    isPasswordRecoveryMode = true;
                    currentPage = 'change-password'; window.currentPage = 'change-password';
                    currentUser = session?.user || null; window.currentUser = currentUser;
                    render(); return;
                }
                if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') return;

                if (event === 'SIGNED_IN' && session?.user) {
                    console.log('‚úÖ SIGNED_IN received for:', session.user.email);
                    currentUser = session.user;
                    window.currentUser = currentUser;
                    
                    await loadUserProfile(currentUser);
                    
                    if (window.location.search.includes('code=') || window.location.hash.includes('access_token')) {
                        console.log('üßπ Cleaning URL after OAuth');
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                    
                    waitingForOAuth = false;
                    initialLoadComplete = true;
                    render();
                    return;
                }
                
                if (event === 'SIGNED_OUT') {
                    currentUser = null; userProfile = null;
                    window.currentUser = null; window.userProfile = null;
                    currentPage = 'landing'; window.currentPage = 'landing';
                    waitingForOAuth = false;
                    render();
                    return;
                }
                
                if (event === 'INITIAL_SESSION') {
                    console.log('üìã INITIAL_SESSION - session:', !!session?.user);
                    
                    if (session?.user) {
                        currentUser = session.user;
                        window.currentUser = currentUser;
                        await loadUserProfile(currentUser);
                        waitingForOAuth = false;
                        initialLoadComplete = true;
                        render();
                    } else if (waitingForOAuth) {
                        console.log('‚è≥ Waiting for OAuth SIGNED_IN...');
                        setTimeout(() => {
                            if (waitingForOAuth && !currentUser) {
                                console.log('‚è∞ OAuth timeout, showing landing');
                                waitingForOAuth = false;
                                initialLoadComplete = true;
                                render();
                            }
                        }, 5000);
                    } else {
                        initialLoadComplete = true;
                        render();
                    }
                    return;
                }
                
                if (event === 'TOKEN_REFRESHED') return;
            });

            // Init timeout
            console.log('üîß Waiting for onAuthStateChange...');
            setTimeout(() => {
                if (!initialLoadComplete && !waitingForOAuth) {
                    console.log('‚è∞ No auth event, showing landing');
                    initialLoadComplete = true;
                    render();
                }
            }, 3000);

        })();
    </script>
    <script src="./js/crisp-chat.js"></script>
</body>
</html>
