<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- Tom Select pour dropdown pays searchable -->
    <!-- intl-tel-input pour tÃ©lÃ©phone international -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    
    <!-- Version: 3.17.0 - Tom Select dropdown pays searchable -->
    
    <style>
/* intl-tel-input - ThÃ¨me sombre Dubai */
.iti { width: 100% !important; }
.iti__tel-input {
    width: 100% !important;
    padding: 0.75rem 1rem 0.75rem 90px !important;
    background: rgba(51, 65, 85, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem !important;
    color: white !important;
}
.iti__tel-input:focus {
    border-color: #eab308 !important;
    box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.3) !important;
    outline: none !important;
}
.iti__tel-input::placeholder { color: rgba(191, 219, 254, 0.5) !important; }
.iti__selected-country {
    background: rgba(51, 65, 85, 0.8) !important;
    border-radius: 0.5rem 0 0 0.5rem !important;
}
.iti__selected-dial-code { color: white !important; }
.iti__arrow { border-top-color: white !important; }
.iti__dropdown-content {
    background: #1e293b !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem !important;
}
.iti__search-input {
    background: rgba(51, 65, 85, 0.8) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}
.iti__search-input::placeholder { color: rgba(191, 219, 254, 0.5) !important; }
.iti__country { color: white !important; }
.iti__country:hover { background: rgba(234, 179, 8, 0.2) !important; }
.iti__dial-code { color: #94a3b8 !important; }
.iti--container { z-index: 9999 !important; }
</style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    <script type="module">
        // âœ… v3.15.9: Version spÃ©cifique de Supabase pour Ã©viter le bug "Invalid data"
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './js/config.js';
        import * as VALIDATION from './js/validation.js';
        window.VALIDATION = VALIDATION;
        import * as UTILS from './js/utils.js';
        import * as AUTH from './js/auth.js';
        import * as DASHBOARD from './js/dashboard.js';
        import * as LEADS from './js/leads.js';
        import * as TFA from './js/2fa.js';
        import * as RENDERING from './js/rendering.js';

        (async () => {
            console.log('ğŸš€ App starting v3.17.0...');
            
            // âœ… v3.15.6: DÃ©tecter les paramÃ¨tres URL d'abord (mais ne pas encore modifier les variables)
            const urlParams = new URLSearchParams(window.location.search);
            const isContractSignedReturn = urlParams.get('signed') !== null;
            
            // âœ… v3.12.0: DÃ©tecter retour OAuth de maniÃ¨re robuste
            const hashParams = window.location.hash;
            const isOAuthReturn = hashParams.includes('access_token') || 
                                  hashParams.includes('error') || 
                                  urlParams.get('code') !== null;
            
            // âœ… v3.16.3: Ne nettoyer l'URL que pour le retour contrat, PAS pour OAuth
            // Supabase a besoin du hash pour rÃ©cupÃ©rer la session OAuth
            if (isContractSignedReturn && !isOAuthReturn) {
                console.log('ğŸ”„ Contract return detected, cleaning URL...');
                if (window.history && window.history.replaceState) {
                    window.history.replaceState(null, '', window.location.pathname);
                }
            }
            
            if (isOAuthReturn) {
                console.log('ğŸ”„ OAuth return detected - keeping hash for Supabase');
            }
            
            if (isContractSignedReturn) {
                console.log('ğŸ“ Contract signed return detected');
            }
            
            // âœ… v3.15.4: Afficher loader SEULEMENT pour OAuth
            if (isOAuthReturn) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4 animate-spin">ğŸ”„</div>
                            <div class="text-xl text-blue-200">Connexion en cours...</div>
                            <div class="text-sm text-blue-300 mt-2">Veuillez patienter</div>
                        </div>
                    </div>
                `;
                
                // âœ… v3.16.3: Fallback - recharger aprÃ¨s 8s si toujours bloquÃ©
                setTimeout(() => {
                    if (document.getElementById('app').innerHTML.includes('Connexion en cours')) {
                        console.log('â° OAuth fallback: still on loader after 8s');
                        // Nettoyer l'URL et recharger
                        window.history.replaceState(null, '', window.location.pathname);
                        window.location.reload();
                    }
                }, 5000);
            }

            // Initialiser i18next
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'fr',
                    debug: false,
                    load: 'languageOnly',
                    ns: ['translation', 'auth', 'dashboard', 'common'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}/{{ns}}.json'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            console.log('ğŸŒ Loading translations...');
            await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
            console.log('âœ… All translations loaded!');

            const t = (key) => i18next.t(key);

            async function changeLanguage(langCode) {
                try {
                    await i18next.changeLanguage(langCode);
                    localStorage.setItem('i18nextLng', langCode);
                    window.location.reload();
                } catch (error) {
                    console.error('Erreur changement de langue:', error);
                }
            }
            window.changeLanguage = changeLanguage;

            // âœ… v3.16.1: Client Supabase avec Realtime complÃ¨tement dÃ©sactivÃ©
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                realtime: false,
                db: {
                    schema: 'public'
                },
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            });
            window.supabase = supabase;
            window.SUPABASE_URL = SUPABASE_URL;
            window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

            // Traductions OAuth
            const oauthTranslations = {
                fr: {
                    security_info: "Information de sÃ©curitÃ©",
                    redirect_message: "Vous allez Ãªtre redirigÃ© vers notre service d'authentification sÃ©curisÃ© <strong>(Supabase)</strong> pour vous connecter avec",
                    normal_secure: "C'est normal et sÃ©curisÃ©.",
                    will_return: "Vous reviendrez automatiquement sur notre site aprÃ¨s connexion.",
                    continue_btn: "Continuer",
                    cancel_btn: "Annuler"
                },
                en: {
                    security_info: "Security Information",
                    redirect_message: "You will be redirected to our secure authentication service <strong>(Supabase)</strong> to sign in with",
                    normal_secure: "This is normal and secure.",
                    will_return: "You will automatically return to our site after signing in.",
                    continue_btn: "Continue",
                    cancel_btn: "Cancel"
                },
                ar: {
                    security_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†",
                    redirect_message: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© <strong>(Supabase)</strong> Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…",
                    normal_secure: "Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ¢Ù…Ù†.",
                    will_return: "Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
                    continue_btn: "Ù…ØªØ§Ø¨Ø¹Ø©",
                    cancel_btn: "Ø¥Ù„ØºØ§Ø¡"
                },
                ru: {
                    security_info: "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
                    redirect_message: "Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° Ğ½Ğ°ÑˆÑƒ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½ÑƒÑ ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ <strong>(Supabase)</strong> Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ·",
                    normal_secure: "Ğ­Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.",
                    will_return: "Ğ’Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²ĞµÑ€Ğ½ĞµÑ‚ĞµÑÑŒ Ğ½Ğ° Ğ½Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°.",
                    continue_btn: "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ",
                    cancel_btn: "ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                },
                hi: {
                    security_info: "à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€",
                    redirect_message: "à¤†à¤ªà¤•à¥‹ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤ªà¥à¤°à¤®à¤¾à¤£à¥€à¤•à¤°à¤£ à¤¸à¥‡à¤µà¤¾ <strong>(Supabase)</strong> à¤ªà¤° à¤ªà¥à¤¨à¤°à¥à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾à¤à¤—à¤¾",
                    normal_secure: "à¤¯à¤¹ à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤”à¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆà¥¤",
                    will_return: "à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤†à¤ª à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¤¾à¤‡à¤Ÿ à¤ªà¤° à¤²à¥Œà¤Ÿ à¤†à¤à¤‚à¤—à¥‡à¥¤",
                    continue_btn: "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
                    cancel_btn: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚"
                },
                ur: {
                    security_info: "Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
                    redirect_message: "Ø¢Ù¾ Ú©Ùˆ ÛÙ…Ø§Ø±ÛŒ Ù…Ø­ÙÙˆØ¸ ØªØµØ¯ÛŒÙ‚ Ø®Ø¯Ù…Øª <strong>(Supabase)</strong> Ù¾Ø± Ø¨Ú¾ÛŒØ¬Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§",
                    normal_secure: "ÛŒÛ Ù†Ø§Ø±Ù…Ù„ Ø§ÙˆØ± Ù…Ø­ÙÙˆØ¸ ÛÛ’Û”",
                    will_return: "Ø³Ø§Ø¦Ù† Ø§Ù† Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ø®ÙˆØ¯ Ø¨Ø®ÙˆØ¯ ÛÙ…Ø§Ø±ÛŒ Ø³Ø§Ø¦Ù¹ Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¢ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”",
                    continue_btn: "Ø¬Ø§Ø±ÛŒ Ø±Ú©Ú¾ÛŒÚº",
                    cancel_btn: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº"
                },
                zh: {
                    security_info: "å®‰å…¨ä¿¡æ¯",
                    redirect_message: "æ‚¨å°†è¢«é‡å®šå‘åˆ°æˆ‘ä»¬çš„å®‰å…¨è®¤è¯æœåŠ¡<strong>(Supabase)</strong>ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•",
                    normal_secure: "è¿™æ˜¯æ­£å¸¸ä¸”å®‰å…¨çš„ã€‚",
                    will_return: "ç™»å½•åæ‚¨å°†è‡ªåŠ¨è¿”å›æˆ‘ä»¬çš„ç½‘ç«™ã€‚",
                    continue_btn: "ç»§ç»­",
                    cancel_btn: "å–æ¶ˆ"
                },
                tl: {
                    security_info: "Impormasyon sa Seguridad",
                    redirect_message: "Ire-redirect ka sa aming secure authentication service <strong>(Supabase)</strong> para mag-sign in gamit ang",
                    normal_secure: "Ito ay normal at secure.",
                    will_return: "Awtomatikong babalik ka sa aming site pagkatapos mag-sign in.",
                    continue_btn: "Magpatuloy",
                    cancel_btn: "Kanselahin"
                }
            };

            // Variables d'Ã©tat
            let currentUser = null;
            let userProfile = null;
            let profileLoadAttempts = 0;
            const MAX_PROFILE_LOAD_ATTEMPTS = 10;
            let currentPage = 'landing';
            let isPasswordRecoveryMode = false;
            let is2FAMode = false;
            let isSignupInProgress = false;
            let tempPhone = null;
            let pendingSignupId = null;
            let globalIsUploading = false;
            let contractJustSigned = isContractSignedReturn; // âœ… v3.15.0: DÃ©tecter depuis URL
            let isRendering = false;
            let lastAuthEvent = null;
            let initialLoadComplete = false;

            // Exposer les variables globales
            window.currentUser = null;
            window.userProfile = null;
            window.currentPage = 'landing';
            window.contractJustSigned = contractJustSigned;
            window.tempPhone = null;
            window.pendingSignupId = null;

            window.setCurrentPage = function(newPage) {
                console.log('ğŸ“ setCurrentPage called:', newPage);
                currentPage = newPage;
                window.currentPage = newPage;
            };

            window.setIs2FAMode = function(value) {
                is2FAMode = value;
                window.is2FAMode = value;
            };

            window.setTempPhone = function(phone) {
                tempPhone = phone;
                window.tempPhone = phone;
            };

            window.setPendingSignupId = function(id) {
                pendingSignupId = id;
                window.pendingSignupId = id;
            };

            // VÃ©rifier les paramÃ¨tres URL
            const searchParams = new URLSearchParams(window.location.search);
            if (searchParams.get('action') === 'signup') {
                currentPage = 'auth-signup';
                window.currentPage = 'auth-signup';
            }

           // âœ… v3.18.0: intl-tel-input pour tÃ©lÃ©phone international
function initPhoneInput(inputId, initialNumber = '') {
    const input = document.getElementById(inputId);
    if (!input) return null;
    if (phoneInputInstances[inputId]) phoneInputInstances[inputId].destroy();
    console.log('ğŸ“± Initializing intl-tel-input for:', inputId);
    const iti = window.intlTelInput(input, {
        initialCountry: "ae",
        preferredCountries: ["ae", "in", "pk", "ph", "gb", "fr", "ru", "cn", "sa", "eg", "us", "ca", "de", "lb", "jo"],
        separateDialCode: true,
        countrySearch: true,
        showFlags: true,
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
    });
    phoneInputInstances[inputId] = iti;
    if (initialNumber) iti.setNumber(initialNumber);
    return iti;
}
window.initPhoneInput = initPhoneInput;

function getFullPhoneNumber(inputId) {
    const iti = phoneInputInstances[inputId];
    return iti ? iti.getNumber() : (document.getElementById(inputId)?.value || '');
}
window.getFullPhoneNumber = getFullPhoneNumber;
            // Fonction de gestion de l'authentification
            function handleAuth(mode) {
                console.log('ğŸ”§ handleAuth called for mode:', mode);
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');

                if (errorDiv) {
                    errorDiv.textContent = '';
                    errorDiv.classList.add('hidden');
                }

                if (!form) {
                    console.error('âŒ Form not found');
                    return;
                }

                console.log('âœ… Form found, attaching handler');
                
                // âœ… v3.18.0: Initialiser intl-tel-input pour le signup
                if (mode === 'signup') {
                    initPhoneInput('phone');
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    console.log('ğŸ“¤ Form submitted for', mode);
                    errorDiv.classList.add('hidden');

                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password')?.value;

                    try {
                        if (mode === 'signup') {
                            console.log('ğŸ“ Processing signup with 2FA');
                            const name = document.getElementById('name').value.trim();
                            const phone = document.getElementById('phone').value.trim();
                            // âœ… v3.17.0: RÃ©cupÃ©rer la valeur via Tom Select ou fallback
                            const countryCodeEl = document.getElementById('countryCode');
                            const countryCode = countryCodeEl.tomselect ? countryCodeEl.tomselect.getValue() : countryCodeEl.value;
                            const confirmPassword = document.getElementById('confirmPassword').value;
                            const fullPhone = countryCode + phone;

                            if (!VALIDATION.validateName(name)) throw new Error('Nom invalide');
                            if (!VALIDATION.validatePhone(fullPhone)) throw new Error('NumÃ©ro de tÃ©lÃ©phone invalide');
                            if (!VALIDATION.validateEmail(email)) throw new Error('Email invalide');
                            if (!VALIDATION.validatePassword(password)) throw new Error('Mot de passe invalide');
                            if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));

                            console.log('ğŸ” Checking if phone exists:', fullPhone);
                            const phoneCheck = await TFA.checkPhoneExists(fullPhone);
                            if (phoneCheck.exists) {
                                const message = 'Ce numÃ©ro de tÃ©lÃ©phone est dÃ©jÃ  utilisÃ©' + (phoneCheck.userName ? ' par ' + phoneCheck.userName : '');
                                if (errorDiv) {
                                    errorDiv.textContent = message;
                                    errorDiv.classList.remove('hidden');
                                }
                                const submitButton = document.getElementById('submitButton');
                                if (submitButton) {
                                    submitButton.disabled = false;
                                    submitButton.textContent = t('auth:signup_button');
                                }
                                console.log('âŒ Phone already exists, blocking signup');
                                return;
                            }

                            const submitButton = document.getElementById('submitButton');
                            const originalButtonContent = submitButton.innerHTML;
                            submitButton.disabled = true;
                            submitButton.style.opacity = '0.7';
                            submitButton.style.cursor = 'wait';
                            submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-gray-900 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Envoi du code SMS...';

                            isSignupInProgress = true;
                            console.log('ğŸ”’ Signup in progress - sending SMS first');

                            try {
                                console.log('ğŸ“± Sending SMS code BEFORE creating account...');
                                const currentLang = i18next.language || 'fr';
                                const emailOptIn = document.getElementById('emailOptIn')?.checked || false;
                                console.log('ğŸ“§ Email opt-in preference:', emailOptIn);

                                const pendingSignupData = {
                                    email: email,
                                    password: password,
                                    name: name,
                                    phone: fullPhone,
                                    email_opt_in: emailOptIn
                                };

                                const smsResult = await TFA.send2FACode(fullPhone, currentLang, pendingSignupData);
                                if (!smsResult.success) {
                                    throw new Error('Erreur lors de l\'envoi du SMS');
                                }

                                console.log('âœ… SMS sent successfully');
                                tempPhone = fullPhone;
                                window.tempPhone = fullPhone;
                                is2FAMode = true;
                                window.is2FAMode = true;
                                isSignupInProgress = false;
                                console.log('âœ… 2FA mode activated, showing keyboard');
                                render();
                            } catch (error) {
                                console.error('âŒ Error sending SMS:', error);
                                isSignupInProgress = false;
                                submitButton.disabled = false;
                                submitButton.style.opacity = '1';
                                submitButton.style.cursor = 'pointer';
                                submitButton.innerHTML = originalButtonContent;

                                let errorMessage = error.message;
                                if (error.message.includes('wait')) {
                                    errorMessage = error.message;
                                } else if (error.message.includes('maximum')) {
                                    errorMessage = error.message;
                                }

                                if (errorDiv) {
                                    errorDiv.textContent = errorMessage;
                                    errorDiv.classList.remove('hidden');
                                }
                                throw error;
                            }
                        } else if (mode === 'login') {
                            console.log('ğŸ” Processing login');
                            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            console.log('âœ… Login successful');
                        }
                    } catch (error) {
                        console.error('âŒ Auth error:', error);
                        let errorMessage = error.message;
                        if (error.message.includes('Invalid login credentials')) {
                            errorMessage = 'Email ou mot de passe incorrect';
                        } else if (error.message.includes('Email not confirmed')) {
                            errorMessage = 'Veuillez confirmer votre email avant de vous connecter';
                        } else if (error.message.includes('User already registered')) {
                            errorMessage = 'Cet email est dÃ©jÃ  utilisÃ©';
                        } else if (error.message.includes('Password should be at least')) {
                            errorMessage = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                        }
                        errorDiv.textContent = errorMessage;
                        errorDiv.classList.remove('hidden');

                        if (mode === 'signup') {
                            const submitButton = document.getElementById('submitButton');
                            submitButton.disabled = false;
                            submitButton.textContent = t('auth:signup_button');
                        }
                    }
                };
            }

            async function handleReset() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');
                    const email = document.getElementById('email').value;

                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(email, {
                            redirectTo: window.location.origin
                        });
                        if (error) throw error;
                        alert(t('auth:reset_email_sent'));
                        UTILS.showLogin();
                    } catch (error) {
                        console.error('Reset error:', error);
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                    }
                };
            }

            function showOAuthWarning(provider) {
                const modal = document.getElementById('oauthWarningModal');
                const providerName = provider === 'google' ? 'Google' : 'Apple';
                const currentLang = i18next.language || 'fr';
                const trans = oauthTranslations[currentLang] || oauthTranslations['fr'];

                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full border border-yellow-500/50">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-4">âš ï¸</div>
                                <h3 class="text-2xl font-bold mb-4 text-yellow-400">${trans.security_info}</h3>
                            </div>
                            <p class="text-blue-200 mb-6 leading-relaxed">${trans.redirect_message} ${providerName}.</p>
                            <p class="text-blue-200 mb-6">
                                <span class="text-green-400 font-semibold">âœ“ ${trans.normal_secure}</span><br>
                                ${trans.will_return}
                            </p>
                            <div class="flex gap-4">
                                <button onclick="proceedWithOAuth('${provider}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">${trans.continue_btn}</button>
                                <button onclick="closeOAuthWarning()" class="flex-1 bg-white/20 hover:bg-white/30 text-white font-bold py-3 rounded-lg transition border border-white/20">${trans.cancel_btn}</button>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
            }

            function closeOAuthWarning() {
                const modal = document.getElementById('oauthWarningModal');
                modal.classList.add('hidden');
                modal.innerHTML = '';
            }

            async function proceedWithOAuth(provider) {
                closeOAuthWarning();
                try {
                    console.log('ğŸ” Starting ' + provider + ' Sign In...');
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: provider,
                        options: {
                            redirectTo: window.location.origin,
                            skipBrowserRedirect: false
                        }
                    });
                    if (error) throw error;
                    console.log('âœ… ' + provider + ' redirect initiated');
                } catch (error) {
                    console.error('âŒ ' + provider + ' Sign In error:', error);
                    alert('Erreur lors de la connexion avec ' + provider + ': ' + error.message);
                }
            }

            async function signInWithGoogle() {
                showOAuthWarning('google');
            }

            async function signInWithApple() {
                showOAuthWarning('apple');
            }

            async function handleChangePassword() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');

                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmNewPassword').value;

                    if (newPassword !== confirmPassword) {
                        errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (newPassword.length < 8) {
                        errorDiv.textContent = 'Le mot de passe doit contenir au moins 8 caractÃ¨res';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    try {
                        console.log('ğŸ”‘ Updating password...');
                        const { error } = await supabase.auth.updateUser({
                            password: newPassword
                        });
                        if (error) throw error;

                        console.log('âœ… Password updated successfully');
                        isPasswordRecoveryMode = false;
                        alert('âœ… Mot de passe changÃ© avec succÃ¨s !');
                        await supabase.auth.signOut();
                        UTILS.showLogin();
                    } catch (error) {
                        console.error('âŒ Change password error:', error);
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                    }
                };
            }

            // âœ… v3.16.2: Fonction loadUserProfile avec timeout pour Ã©viter blocage
            async function loadUserProfile(user = null) {
                const targetUser = user || currentUser;
                console.log('ğŸ” loadUserProfile called for user:', targetUser?.id);

                if (!targetUser || !targetUser.id) {
                    console.error('âŒ No user provided to loadUserProfile');
                    return false;
                }

                // âœ… v3.16.2: Timeout de 5 secondes pour Ã©viter blocage
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Profile load timeout')), 5000)
                );

                try {
                    console.log('ğŸ” Fetching profile from Supabase for:', targetUser.id);
                    
                    const queryPromise = supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', targetUser.id)
                        .maybeSingle();
                    
                    // Race entre la requÃªte et le timeout
                    const { data, error } = await Promise.race([queryPromise, timeoutPromise]);

                    if (error && error.code !== 'PGRST116') {
                        console.error('âŒ Error loading profile:', error);
                        return false;
                    }

                    let profile = data;

                    if (!profile) {
                        console.log('ğŸ“ Profile does not exist, creating it...');
                        const userName = targetUser.user_metadata?.full_name ||
                            targetUser.user_metadata?.name ||
                            targetUser.email?.split('@')[0] ||
                            '';

                        const createPromise = supabase
                            .from('profiles')
                            .upsert([{
                                id: targetUser.id,
                                name: userName,
                                phone: targetUser.user_metadata?.phone || '',
                                email: targetUser.email,
                                role: 'referrer',
                                contract_status: 'pending',
                                phone_verified: false
                            }], { onConflict: 'id' })
                            .select()
                            .single();

                        const { data: newProfile, error: insertError } = await Promise.race([createPromise, timeoutPromise]);

                        if (insertError) {
                            console.error('âŒ Error creating profile:', insertError);
                            return false;
                        }

                        profile = newProfile;
                        console.log('âœ… Profile created:', profile);
                    }

                    console.log('âœ… Profile data retrieved:', profile);

                    if (profile && profile.contract_status) {
                        profile.contract_status = profile.contract_status.trim().replace(/\*+/g, '');
                    }

                    userProfile = profile;
                    window.userProfile = profile;
                    console.log('âœ… userProfile set:', userProfile);
                    return true;
                } catch (err) {
                    console.error('âŒ Exception loading profile:', err.message);
                    // âœ… v3.16.2: En cas de timeout, crÃ©er un profil minimal
                    if (err.message === 'Profile load timeout') {
                        console.log('âš ï¸ Timeout - creating minimal profile');
                        userProfile = {
                            id: targetUser.id,
                            name: targetUser.user_metadata?.full_name || targetUser.email?.split('@')[0] || 'User',
                            email: targetUser.email,
                            role: 'referrer',
                            contract_status: 'pending'
                        };
                        window.userProfile = userProfile;
                        return true;
                    }
                    return false;
                }
            }
            window.loadUserProfile = loadUserProfile;

            // âœ… v3.15.0: Fonction logout robuste
            async function logout() {
                console.log('ğŸšª Logout called');
                try {
                    console.log('ğŸ”“ Signing out from Supabase...');
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.warn('âš ï¸ Supabase signOut warning:', error.message);
                    }
                } catch (e) {
                    console.warn('âš ï¸ SignOut exception:', e);
                }
                
                // Toujours nettoyer, mÃªme si signOut Ã©choue
                console.log('ğŸ§¹ Cleaning ALL session data...');
                try { localStorage.clear(); } catch(e) {}
                try { sessionStorage.clear(); } catch(e) {}

                currentUser = null;
                userProfile = null;
                currentPage = 'landing';
                isPasswordRecoveryMode = false;
                is2FAMode = false;
                tempPhone = null;
                pendingSignupId = null;
                globalIsUploading = false;

                window.currentUser = null;
                window.userProfile = null;
                window.currentPage = 'landing';
                window.tempPhone = null;
                window.pendingSignupId = null;

                console.log('âœ… Local state cleaned');
                console.log('ğŸ”„ Redirecting to home...');
                
                // Petit dÃ©lai pour s'assurer que tout est nettoyÃ©
                setTimeout(() => {
                    window.location.href = window.location.origin;
                }, 100);
            }

            window.logout = logout;

            async function render() {
                if (isRendering) {
                    console.log('â³ Render already in progress, skipping...');
                    return;
                }
                isRendering = true;

                console.log('ğŸ¨ RENDER called');
                console.log('- currentUser:', !!currentUser);
                console.log('- userProfile:', !!userProfile);
                console.log('- currentPage:', currentPage);
                console.log('- isPasswordRecoveryMode:', isPasswordRecoveryMode);
                console.log('- is2FAMode:', is2FAMode);
                console.log('- isSignupInProgress:', isSignupInProgress);

                if (contractJustSigned && currentUser && userProfile) {
                    console.log('ğŸ‰ Contract just signed! Reloading profile and showing confirmation');
                    contractJustSigned = false;
                    window.contractJustSigned = false;
                    try {
                        await loadUserProfile(currentUser);
                    } catch (e) {
                        console.error('Erreur lors du rechargement du profil aprÃ¨s signature:', e);
                    }
                    setTimeout(() => {
                        const confirmationDiv = document.createElement('div');
                        confirmationDiv.innerHTML = `
                            <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">âœ…</span>
                                    <div>
                                        <div class="font-bold">Contrat signÃ© avec succÃ¨s !</div>
                                        <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(confirmationDiv);
                        setTimeout(() => confirmationDiv.remove(), 5000);
                    }, 500);
                }

                const app = document.getElementById('app');

                // Mode 2FA
                if (is2FAMode) {
                    console.log('ğŸ“± 2FA mode active - showing 2FA form');
                    app.innerHTML = RENDERING.renderAuthPage('2fa');
                    const form2FA = document.getElementById('form2FA');
                    if (form2FA) {
                        form2FA.onsubmit = TFA.handle2FASubmit;
                        console.log('âœ… 2FA form handler attached immediately');
                    }
                    document.getElementById('code2fa')?.focus();
                    isRendering = false;
                    return;
                }

                // Mode rÃ©cupÃ©ration de mot de passe
                if (isPasswordRecoveryMode && currentPage === 'change-password') {
                    console.log('ğŸ”‘ Password recovery mode - showing change password form');
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);
                    isRendering = false;
                    return;
                }

                // âœ… v3.14.0: Utilisateur connectÃ© avec profil
                if (currentUser && userProfile) {
                    console.log('âœ… User connected with profile');
                    
                    // VÃ©rifier si le profil est complet (nom, tÃ©lÃ©phone, adresse, email)
                    const isComplete = RENDERING.isProfileComplete(userProfile);
                    console.log('ğŸ“‹ Profile complete check:', isComplete, {
                        name: !!userProfile.name,
                        phone: !!userProfile.phone,
                        address: !!userProfile.address,
                        email: !!userProfile.email
                    });
                    
                    // Si profil incomplet et pas admin â†’ afficher modal de complÃ©tion
                    if (!isComplete && userProfile.role !== 'admin') {
                        console.log('âš ï¸ Profile incomplete - showing completion modal');
                        currentPage = 'profile-completion';
                        window.currentPage = 'profile-completion';
                        
                        // Afficher le dashboard AVEC le modal par-dessus
                        app.innerHTML = RENDERING.renderDashboard() + RENDERING.renderProfileCompletionModal();
                        
                        // âœ… v3.18.0: Initialiser intl-tel-input pour le modal
                        setTimeout(() => {
                        const existingPhone = userProfile.phone || '';
                        initPhoneInput('completionPhone', existingPhone);
                        }, 200);
                        
                        // âœ… v3.14.0: Attacher le handler du formulaire - FORMAT UAE
                        setTimeout(() => {
                            const form = document.getElementById('profileCompletionForm');
                            if (form) {
                                console.log('âœ… Profile completion form handler attached');
                                form.onsubmit = async (e) => {
                                    e.preventDefault();
                                    console.log('ğŸ“ Profile completion form submitted');
                                    
                                    const submitBtn = document.getElementById('completionSubmitBtn');
                                    const errorDiv = document.getElementById('completionError');
                                    const originalText = submitBtn.textContent;
                                    
                                    submitBtn.disabled = true;
                                    submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-gray-900 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Enregistrement...';
                                    errorDiv.classList.add('hidden');
                                    
                                    try {
                                        // âœ… v3.14.0: Format UAE - RÃ©cupÃ©rer les champs
                                        const nameEl = document.getElementById('completionName');
                                        const emailEl = document.getElementById('completionEmail');
                                        const countryCodeEl = document.getElementById('completionCountryCode');
                                        const phoneEl = document.getElementById('completionPhone');
                                        const addressEl = document.getElementById('completionAddress');
                                        const areaEl = document.getElementById('completionArea');
                                        const emirateEl = document.getElementById('completionEmirate');
                                        
                                        const name = nameEl?.value?.trim() || '';
                                        const email = emailEl?.value?.trim() || '';
                                        // âœ… v3.17.0: RÃ©cupÃ©rer via Tom Select
                                        const countryCode = countryCodeEl.tomselect ? countryCodeEl.tomselect.getValue() : (countryCodeEl?.value || '+971');
                                        const phone = phoneEl?.value?.trim() || '';
                                        const address = addressEl?.value?.trim() || '';
                                        const area = areaEl?.value?.trim() || '';
                                        const emirate = emirateEl?.value || '';
                                        
                                        console.log('ğŸ“‹ Form values:', { name, email, phone, countryCode, address, area, emirate });
                                        
                                        // Validations
                                        if (!name || name.length < 2) {
                                            throw new Error('Le nom doit contenir au moins 2 caractÃ¨res');
                                        }
                                        if (!email || !email.includes('@')) {
                                            throw new Error('Adresse email invalide');
                                        }
                                        if (email.includes('@privaterelay.appleid.com')) {
                                            throw new Error('Veuillez entrer votre vraie adresse email, pas le relay Apple');
                                        }
                                        if (!phone || phone.length < 6) {
                                            throw new Error('NumÃ©ro de tÃ©lÃ©phone invalide');
                                        }
                                        if (!address || address.length < 3) {
                                            throw new Error('Adresse trop courte (bÃ¢timent, rue)');
                                        }
                                        if (!area || area.length < 2) {
                                            throw new Error('Zone/Quartier requis');
                                        }
                                        if (!emirate) {
                                            throw new Error('Ã‰mirat requis');
                                        }
                                        
                                        const fullPhone = countryCode + phone.replace(/^0+/, '');
                                        
                                        // Construire l'adresse complÃ¨te au format UAE
                                        const fullAddress = `${address}, ${area}, ${emirate}`;
                                        
                                        console.log('ğŸ’¾ Updating profile with:', { name, email, phone: fullPhone, address: fullAddress });
                                        
                                        const { error: updateError } = await supabase
                                            .from('profiles')
                                            .update({
                                                name: name,
                                                email: email,
                                                phone: fullPhone,
                                                address: fullAddress
                                            })
                                            .eq('id', currentUser.id);
                                        
                                        if (updateError) {
                                            throw new Error('Erreur de mise Ã  jour: ' + updateError.message);
                                        }
                                        
                                        console.log('âœ… Profile updated successfully');
                                        
                                        // Recharger le profil
                                        await loadUserProfile(currentUser);
                                        
                                        // Fermer le modal
                                        const modal = document.getElementById('profileCompletionModal');
                                        if (modal) modal.remove();
                                        
                                        currentPage = 'dashboard';
                                        window.currentPage = 'dashboard';
                                        
                                        // Notification de succÃ¨s
                                        const successDiv = document.createElement('div');
                                        successDiv.innerHTML = `
                                            <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-3xl">âœ…</span>
                                                    <div>
                                                        <div class="font-bold">Profil complÃ©tÃ© !</div>
                                                        <div class="text-sm">Bienvenue dans votre espace</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        document.body.appendChild(successDiv);
                                        setTimeout(() => successDiv.remove(), 4000);
                                        
                                        isRendering = false;
                                        render();
                                        
                                    } catch (error) {
                                        console.error('âŒ Profile completion error:', error);
                                        errorDiv.textContent = error.message;
                                        errorDiv.classList.remove('hidden');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                    }
                                };
                            }
                        }, 100);
                        
                        isRendering = false;
                        return;
                    }
                    
                    // Profil complet â†’ afficher dashboard normalement
                    console.log('âœ… Profile complete, showing dashboard');
                    currentPage = 'dashboard';
                    window.currentPage = 'dashboard';
                    app.innerHTML = RENDERING.renderDashboard();
                    await DASHBOARD.loadDashboardContent();

                    // Gestion du formulaire de contrat pour les referrers
                    if (userProfile.role !== 'admin') {
                        const contractForm = document.getElementById('contractForm');
                        if (contractForm) {
                            console.log('âœ… Contract form found, attaching submit handler');
                            contractForm.addEventListener('submit', async (e) => {
                                e.preventDefault();

                                if (globalIsUploading) {
                                    console.log('âš ï¸ Upload already in progress, ignoring duplicate submit');
                                    return;
                                }

                                globalIsUploading = true;
                                console.log('ğŸ“„ Starting contract upload...');

                                const submitBtn = document.getElementById('contractSubmitBtn');
                                const errorDiv = document.getElementById('uploadError');
                                const progressDiv = document.getElementById('uploadProgress');
                                const originalText = submitBtn.textContent;

                                submitBtn.disabled = true;
                                submitBtn.textContent = 'Upload en cours...';
                                errorDiv.classList.add('hidden');
                                progressDiv.classList.remove('hidden');
                                progressDiv.textContent = 'â³ PrÃ©paration du fichier...';

                                try {
                                    const fileInput = document.getElementById('contractFile');
                                    const file = fileInput.files[0];

                                    if (!file) throw new Error('Veuillez sÃ©lectionner un fichier');
                                    if (file.type !== 'application/pdf') throw new Error('Seuls les fichiers PDF sont acceptÃ©s');
                                    const maxSize = 10 * 1024 * 1024;
                                    if (file.size > maxSize) throw new Error('Le fichier est trop volumineux. Taille maximum : 10MB');

                                    console.log('ğŸ“„ File validated:', file.name, 'Size:', file.size, 'bytes');
                                    progressDiv.textContent = 'â³ TÃ©lÃ©chargement vers le serveur...';

                                    const fileName = currentUser.id + '_' + Date.now() + '_' + file.name;
                                    console.log('ğŸ“„ Uploading to Storage with name:', fileName);

                                    const { data: { session } } = await supabase.auth.getSession();
                                    if (!session) throw new Error('Session expirÃ©e, veuillez vous reconnecter');

                                    const uploadUrl = SUPABASE_URL + '/storage/v1/object/contracts/' + fileName;
                                    console.log('ğŸš€ Uploading via REST API to:', uploadUrl);

                                    const uploadResponse = await fetch(uploadUrl, {
                                        method: 'POST',
                                        headers: {
                                            'Authorization': 'Bearer ' + session.access_token,
                                            'Content-Type': file.type,
                                            'x-upsert': 'false'
                                        },
                                        body: file
                                    });

                                    if (!uploadResponse.ok) {
                                        const errorText = await uploadResponse.text();
                                        console.error('âŒ Upload failed:', uploadResponse.status, errorText);
                                        throw new Error('Erreur d\'upload: ' + uploadResponse.status + ' - ' + errorText);
                                    }

                                    const uploadData = await uploadResponse.json();
                                    console.log('âœ… File uploaded successfully to Storage');

                                    progressDiv.textContent = 'â³ Mise Ã  jour de votre profil...';

                                    const { error: updateError } = await supabase.from('profiles').update({
                                        contract_path: fileName,
                                        contract_status: 'signed',
                                        contract_file_url: fileName
                                    }).eq('id', currentUser.id);

                                    if (updateError) {
                                        console.error('âŒ Error updating profile:', updateError);
                                        throw new Error('Erreur de mise Ã  jour : ' + updateError.message);
                                    }

                                    console.log('âœ… Profile updated successfully with contract_path:', fileName);

                                    // Notification email (optionnel)
                                    try {
                                        console.log('ğŸ“§ Sending email notification...');
                                        const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email-notification', {
                                            body: {
                                                referrerName: userProfile.name || 'Inconnu',
                                                referrerEmail: currentUser.email,
                                                contractPath: fileName
                                            }
                                        });
                                        if (emailError) console.error('âŒ Email notification error:', emailError);
                                        else console.log('âœ… Email notification sent:', emailData);
                                    } catch (emailErr) {
                                        console.error('âŒ Email notification exception:', emailErr);
                                    }

                                    alert('âœ… Contrat uploadÃ© avec succÃ¨s !');
                                    await loadUserProfile();
                                    globalIsUploading = false;
                                    render();
                                } catch (error) {
                                    console.error('âŒ Upload exception:', error);
                                    errorDiv.textContent = error.message;
                                    errorDiv.classList.remove('hidden');
                                    progressDiv.classList.add('hidden');
                                } finally {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                    globalIsUploading = false;
                                }
                            });
                        }
                    }

                    isRendering = false;
                    return;

                } else if (currentUser && !userProfile) {
                    // Utilisateur connectÃ© mais profil pas encore chargÃ©
                    profileLoadAttempts++;
                    if (profileLoadAttempts >= MAX_PROFILE_LOAD_ATTEMPTS) {
                        console.error('âŒ Failed to load profile after max attempts');
                        profileLoadAttempts = 0;
                        await supabase.auth.signOut();
                        localStorage.clear();
                        sessionStorage.clear();
                        currentPage = 'landing';
                        currentUser = null;
                        window.currentUser = null;
                        isRendering = false;
                        render();
                        return;
                    }

                    console.log('â³ User connected but no profile, waiting... (attempt ' + profileLoadAttempts + '/' + MAX_PROFILE_LOAD_ATTEMPTS + ')');
                    app.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-6xl mb-4">â³</div>
                                <div class="text-xl text-blue-200">Chargement de votre profil... (tentative ${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS})</div>
                            </div>
                        </div>
                    `;
                    isRendering = false;
                    setTimeout(() => {
                        loadUserProfile().then(() => render());
                    }, profileLoadAttempts * 1000);
                    return;

                } else if (currentPage === 'auth-login') {
                    console.log('ğŸ” Rendering login page');
                    app.innerHTML = RENDERING.renderAuthPage('login');
                    setTimeout(() => handleAuth('login'), 500);

                } else if (currentPage === 'auth-signup') {
                    console.log('ğŸ“ Rendering signup page');
                    app.innerHTML = RENDERING.renderAuthPage('signup');
                    setTimeout(() => {
                        handleAuth('signup');
                        if (window.VALIDATION && window.VALIDATION.attachPasswordValidation) {
                            window.VALIDATION.attachPasswordValidation();
                        }
                    }, 500);

                } else if (currentPage === 'auth-reset') {
                    console.log('ğŸ”‘ Rendering reset page');
                    app.innerHTML = RENDERING.renderAuthPage('reset');
                    setTimeout(() => handleReset(), 500);

                } else if (currentPage === 'change-password') {
                    console.log('ğŸ”‘ Rendering change password page');
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);

                } else {
                    console.log('ğŸ  Rendering landing page');
                    app.innerHTML = RENDERING.renderLandingPage();
                }

                isRendering = false;
            }

            // Exposer les fonctions globales
            window.showAddLeadForm = LEADS.showAddLeadForm;
            window.closeAddLeadModal = LEADS.closeAddLeadModal;
            window.addLead = LEADS.addLead;
            window.updateLeadStatus = LEADS.updateLeadStatus;
            window.markAsSold = LEADS.markAsSold;
            window.renderAddLeadModal = LEADS.renderAddLeadModal;
            window.togglePasswordVisibility = VALIDATION.togglePasswordVisibility;
            window.validateName = VALIDATION.validateName;
            window.validatePhone = VALIDATION.validatePhone;
            window.validateEmail = VALIDATION.validateEmail;
            window.validatePassword = VALIDATION.validatePassword;
            window.validateConfirmPassword = VALIDATION.validateConfirmPassword;
            window.checkFormValidity = VALIDATION.checkFormValidity;
            window.prefillTestData = UTILS.prefillTestData;
            window.render = render;
            window.loadDashboardContent = DASHBOARD.loadDashboardContent;
            window.handleChangePassword = handleChangePassword;
            window.downloadContractTemplate = UTILS.downloadContractTemplate;
            window.checkPhoneExists = TFA.checkPhoneExists;
            window.handle2FASubmit = TFA.handle2FASubmit;
            window.resend2FACode = TFA.resend2FACode;
            window.signInWithGoogle = signInWithGoogle;
            window.signInWithApple = signInWithApple;
            window.showOAuthWarning = showOAuthWarning;
            window.closeOAuthWarning = closeOAuthWarning;
            window.proceedWithOAuth = proceedWithOAuth;
            window.toggleMobileMenu = UTILS.toggleMobileMenu;
            window.showLogin = UTILS.showLogin;
            window.showSignup = UTILS.showSignup;
            window.showReset = UTILS.showReset;
            window.backToHome = UTILS.backToHome;
            window.backTo2FASignup = function() {
                console.log('ğŸ”™ Back to signup from 2FA');
                is2FAMode = false;
                window.is2FAMode = false;
                tempPhone = null;
                window.tempPhone = null;
                pendingSignupId = null;
                window.pendingSignupId = null;
                currentPage = 'auth-signup';
                window.currentPage = 'auth-signup';
                render();
            };
            window.renderLandingPage = RENDERING.renderLandingPage;
            window.renderAuthPage = RENDERING.renderAuthPage;
            window.renderDashboard = RENDERING.renderDashboard;
            window.logout = logout;

            // âœ… v3.15.0: Gestion robuste de l'authentification avec rÃ©cupÃ©ration d'erreur
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('ğŸ”” Auth state changed:', event, session ? 'with session' : 'no session');

                // âœ… v3.15.8: Pour OAuth, ignorer INITIAL_SESSION seulement si pas de session
                // Si on a une session dans INITIAL_SESSION, on la traite !
                if (isOAuthReturn && event === 'INITIAL_SESSION') {
                    if (session) {
                        console.log('âœ… OAuth INITIAL_SESSION with session - processing!');
                        // Continuer le traitement normal
                    } else {
                        console.log('â³ OAuth return: INITIAL_SESSION without session, waiting for SIGNED_IN...');
                        return;
                    }
                }

                if (isSignupInProgress && event !== 'SIGNED_IN') {
                    console.log('âš ï¸ Ignoring event during signup process:', event);
                    return;
                }

                if (event === lastAuthEvent && event === 'TOKEN_REFRESHED') {
                    console.log('â­ï¸ Skipping duplicate TOKEN_REFRESHED event');
                    return;
                }
                lastAuthEvent = event;

                if (event === 'PASSWORD_RECOVERY') {
                    console.log('ğŸ”‘ Password recovery detected - blocking auto-login');
                    isPasswordRecoveryMode = true;
                    currentPage = 'change-password';
                    window.currentPage = 'change-password';
                    currentUser = session?.user || null;
                    window.currentUser = currentUser;
                    render();
                    return;
                }

                if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') {
                    console.log('âš ï¸ Ignoring event during password recovery:', event);
                    return;
                }

                currentUser = session?.user || null;
                window.currentUser = currentUser;

                if (currentUser) {
                    console.log('ğŸ‘¤ User authenticated:', currentUser.email);
                    try {
                        const profileLoaded = await loadUserProfile(currentUser);
                        console.log('ğŸ“‹ Profile load result:', profileLoaded);
                    } catch (err) {
                        console.error('âŒ Exception loading profile:', err);
                    }
                }

                // Nettoyer l'URL aprÃ¨s traitement OAuth
                if (window.location.hash && (window.location.hash.includes('access_token') || window.location.hash.includes('error'))) {
                    console.log('ğŸ§¹ Cleaning URL hash after auth processing');
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                }
                if (window.location.search && window.location.search.includes('code=')) {
                    console.log('ğŸ§¹ Cleaning URL search after PKCE processing');
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                }

                initialLoadComplete = true;
                console.log('âœ… Auth state change handled, calling render...');
                render();
            });

            // âœ… v3.15.4: Chargement initial simple
            async function initializeApp() {
                if (isOAuthReturn) {
                    console.log('ğŸ”„ OAuth return - waiting for onAuthStateChange to handle session...');
                    return;
                }
                
                console.log('ğŸ” Getting session...');
                try {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    
                    if (error) {
                        console.warn('âš ï¸ Session error:', error.message);
                        // Ne rien faire, laisser continuer
                    }
                    
                    console.log('ğŸ“‹ Session result:', session ? 'User found: ' + session.user.email : 'No user');
                    currentUser = session?.user || null;
                    window.currentUser = currentUser;

                    if (currentUser) {
                        console.log('ğŸ‘¤ User found, loading profile...');
                        await loadUserProfile(currentUser);
                    }
                } catch (err) {
                    console.error('âŒ Session error:', err);
                    // Ne rien nettoyer, juste continuer
                }

                initialLoadComplete = true;
                render();
            }
            
            // âœ… v3.15.4: NE PAS intercepter les erreurs - laisser Supabase gÃ©rer
            // L'erreur "Invalid data" est cosmÃ©tique et ne doit pas affecter le fonctionnement
            
            // Lancer l'initialisation
            await initializeApp();

        })();
    </script>
    <script src="./js/crisp-chat.js"></script>
</body>
</html>
