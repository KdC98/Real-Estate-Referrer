<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div id="app"></div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    (async () => {
        // ============================================
        // üåê INITIALISATION I18NEXT
        // ============================================
        await i18next
            .use(i18nextHttpBackend)
            .use(i18nextBrowserLanguageDetector)
            .init({
                fallbackLng: 'fr',
                debug: true,
                load: 'languageOnly',
                ns: ['translation', 'auth', 'dashboard', 'common'],
                defaultNS: 'translation',
                backend: {
                    loadPath: '/locales/{{lng}}/{{ns}}.json'
                },
                detection: {
                    order: ['localStorage', 'navigator'],
                    caches: ['localStorage']
                }
            });
        
        console.log('üåê Loading translations...');
        await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
        console.log('‚úÖ All translations loaded!');
        
        const t = (key) => i18next.t(key);
        
        async function changeLanguage(langCode) {
            try {
                await i18next.changeLanguage(langCode);
                localStorage.setItem('i18nextLng', langCode);
                window.location.reload();
            } catch (error) {
                console.error('Erreur changement de langue:', error);
            }
        }
        window.changeLanguage = changeLanguage;
        
        // ============================================
        // üîß CONFIGURATION SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://cgizcgwhwxswvoodqver.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXpjZ3dod3hzd3Zvb2RxdmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1NDYsImV4cCI6MjA3NjAxMjU0Nn0.d5PWoeuz6Z322dnvLLKg4LBb6jUhWo4MyxlIGdxA3oc';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
        
        // ============================================
        // üì± VARIABLES GLOBALES
        // ============================================
        let currentUser = null;
        let userProfile = null;
        let profileLoadAttempts = 0;
        const MAX_PROFILE_LOAD_ATTEMPTS = 10;
        let currentPage = 'landing';
        let isPasswordRecoveryMode = false;
        let globalIsUploading = false;
        let contractJustSigned = false;
        
        window.currentUser = null;
        window.userProfile = null;
        window.currentPage = 'landing';
        window.contractJustSigned = false;
        
        console.log('üì± 2FA D√âSACTIV√â - Inscription directe activ√©e');
        
        // ============================================
        // üéØ D√âTECTION PARAM√àTRE ?signed=...
        // ============================================
        function getQueryParams() {
            const params = {};
            const search = window.location.search.substring(1);
            if (!search) return params;
            
            for (const part of search.split('&')) {
                const [key, value] = part.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            }
            return params;
        }
        
        (function detectSignedParamOnLoad() {
            const params = getQueryParams();
            if (params.signed) {
                console.log('üéâ Param√®tre ?signed d√©tect√©:', params.signed);
                contractJustSigned = true;
                window.contractJustSigned = true;
                window.history.replaceState({}, '', window.location.pathname);
            }
        })();
        
        // V√©rifier si on arrive avec ?action=signup
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'signup') {
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
        }
        
        // ============================================
        // üé® FONCTIONS DE RENDU
        // ============================================
        
        function renderLandingPage() {
            return `
                <div class="min-h-screen">
                    <header class="container mx-auto px-4 py-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-yellow-400">${t('nav.brand')}</h1>
                            
                            <div class="hidden lg:flex items-center gap-3">
                                <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                                    <button onclick="changeLanguage('fr')" class="text-2xl hover:scale-125 transition-transform duration-200">üá´üá∑</button>
                                    <button onclick="changeLanguage('en')" class="text-2xl hover:scale-125 transition-transform duration-200">üá¨üáß</button>
                                    <button onclick="changeLanguage('ar')" class="text-2xl hover:scale-125 transition-transform duration-200">üá¶üá™</button>
                                    <button onclick="changeLanguage('ru')" class="text-2xl hover:scale-125 transition-transform duration-200">üá∑üá∫</button>
                                    <button onclick="changeLanguage('hi')" class="text-2xl hover:scale-125 transition-transform duration-200">üáÆüá≥</button>
                                    <button onclick="changeLanguage('ur')" class="text-2xl hover:scale-125 transition-transform duration-200">üáµüá∞</button>
                                    <button onclick="changeLanguage('zh')" class="text-2xl hover:scale-125 transition-transform duration-200">üá®üá≥</button>
                                    <button onclick="changeLanguage('tl')" class="text-2xl hover:scale-125 transition-transform duration-200">üáµüá≠</button>
                                </div>
                                <a href="how-it-works.html" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.how_it_works')}</a>
                                <button onclick="showLogin()" class="text-white hover:text-yellow-400 transition font-medium px-4 py-2">${t('nav.login')}</button>
                                <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition">${t('nav.signup')}</button>
                            </div>
                        </div>
                    </header>
                    
                    <main class="container mx-auto px-4 py-20">
                        <div class="text-center mb-12">
                            <h2 class="text-5xl md:text-6xl font-bold mb-6">${t('hero.title')}</h2>
                            <p class="text-xl text-gray-300 mb-8">${t('hero.subtitle')}</p>
                            <button onclick="showSignup()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-8 py-4 rounded-lg transition transform hover:scale-105">
                                ${t('hero.cta_button')}
                            </button>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-8 mt-20">
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.commission_value')}</div>
                                <div class="text-gray-300">${t('stats.commission_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.support_value')}</div>
                                <div class="text-gray-300">${t('stats.support_label')}</div>
                            </div>
                            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 text-center">
                                <div class="text-4xl font-bold text-yellow-500 mb-2">${t('stats.timeline_value')}</div>
                                <div class="text-gray-300">${t('stats.timeline_label')}</div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }
        
        function renderAuthPage(mode) {
            let title, buttonText, linkText, linkAction;
            
            if (mode === 'login') {
                title = t('auth:login_title');
                buttonText = t('auth:login_button');
                linkText = t('auth:no_account');
                linkAction = 'showSignup()';
            } else if (mode === 'signup') {
                title = t('auth:signup_title');
                buttonText = t('auth:signup_button');
                linkText = t('auth:have_account');
                linkAction = 'showLogin()';
            } else if (mode === 'reset') {
                title = t('auth:reset_title');
                buttonText = t('auth:reset_button');
                linkText = t('auth:back_to_login');
                linkAction = 'showLogin()';
            } else if (mode === 'change-password') {
                title = 'Nouveau mot de passe';
                buttonText = 'Changer le mot de passe';
                linkText = 'Retour √† la connexion';
                linkAction = 'showLogin()';
            }
            
            return `
                <div class="min-h-screen flex items-center justify-center px-4">
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-xl p-8 w-full max-w-md">
                        <button onclick="backToHome()" class="text-gray-400 hover:text-white mb-6 flex items-center">
                            ‚Üê ${t('auth:back_home')}
                        </button>
                        
                        <h2 class="text-3xl font-bold mb-6 text-center">${title}</h2>
                        
                        <form id="authForm" class="space-y-4">
                            ${mode === 'signup' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:name_label')}</label>
                                    <input type="text" id="name" required minlength="2" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:phone_label')}</label>
                                    <div class="flex gap-2">
                                        <select id="countryCode" class="w-32 px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                            <option value="+971">üá¶üá™ +971</option>
                                            <option value="+33">üá´üá∑ +33</option>
                                            <option value="+1">üá∫üá∏ +1</option>
                                        </select>
                                        <input type="tel" id="phone" required class="flex-1 px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${mode !== 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${t('auth:email_label')}</label>
                                    <input type="email" id="email" required class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                            ` : ''}
                            
                            ${mode !== 'reset' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Nouveau mot de passe' : t('auth:password_label')}</label>
                                    <input type="password" id="${mode === 'change-password' ? 'newPassword' : 'password'}" required minlength="8" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                            ` : ''}
                            
                            ${mode === 'signup' || mode === 'change-password' ? `
                                <div>
                                    <label class="block mb-2 font-medium">${mode === 'change-password' ? 'Confirmer le nouveau mot de passe' : t('auth:confirm_password_label')}</label>
                                    <input type="password" id="${mode === 'change-password' ? 'confirmNewPassword' : 'confirmPassword'}" required minlength="8" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:outline-none">
                                </div>
                            ` : ''}
                            
                            ${mode === 'login' ? `
                                <div class="text-right">
                                    <button type="button" onclick="showReset()" class="text-yellow-400 hover:text-yellow-300 text-sm transition-colors">
                                        ${t('auth:forgot_password')}
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div id="authError" class="text-red-400 text-sm hidden bg-red-900/20 border border-red-500/50 rounded-lg p-3"></div>
                            
                            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">
                                ${buttonText}
                            </button>
                        </form>
                        
                        <p class="text-center mt-6 text-gray-400">
                            <button onclick="${linkAction}" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                                ${linkText}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }
        
        function renderDashboard() {
            if (!userProfile) {
                return '<div class="min-h-screen flex items-center justify-center"><div class="text-xl">‚è≥ Chargement du profil...</div></div>';
            }
            
            const isAdmin = userProfile.role === 'admin';
            const hasValidContract = userProfile.contract_status === 'signed' || userProfile.contract_status === 'approved';
            
            return `
                <div class="min-h-screen">
                    <header class="bg-gray-800 bg-opacity-50 backdrop-blur-md">
                        <div class="container mx-auto px-4 py-4">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold text-yellow-400">${isAdmin ? 'Admin Dashboard' : 'Referrer Dashboard'}</h1>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-300">${userProfile.name}</span>
                                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">
                                        D√©connexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <main class="container mx-auto px-4 py-8">
                        ${!hasValidContract && !isAdmin ? `
                            <div class="mb-6 bg-blue-900/50 border-2 border-yellow-500 p-6 rounded-xl">
                                <h3 class="text-2xl font-bold text-yellow-400 mb-4">üìù Contrat requis</h3>
                                <p class="text-gray-300 mb-4">Vous devez signer votre contrat avant d'ajouter des leads.</p>
                                <a href="/contract-signature.html" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg transition inline-block">
                                    üñäÔ∏è Signer mon contrat
                                </a>
                            </div>
                        ` : ''}
                        
                        <div id="stats" class="grid md:grid-cols-3 gap-6 mb-8"></div>
                        <div id="leadsTable"></div>
                    </main>
                </div>
            `;
        }
        
        // ============================================
        // üéØ FONCTIONS DE NAVIGATION
        // ============================================
        
        function showLogin() {
            currentPage = 'auth-login';
            window.currentPage = 'auth-login';
            render();
        }
        
        function showSignup() {
            currentPage = 'auth-signup';
            window.currentPage = 'auth-signup';
            render();
        }
        
        function showReset() {
            currentPage = 'auth-reset';
            window.currentPage = 'auth-reset';
            render();
        }
        
        function backToHome() {
            currentPage = 'landing';
            window.currentPage = 'landing';
            isPasswordRecoveryMode = false;
            render();
        }
        
        // ============================================
        // üîê AUTHENTIFICATION
        // ============================================
        
        function handleAuth(mode) {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            if (!form) return;
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email')?.value.trim();
                const password = document.getElementById('password')?.value;
                
                try {
                    if (mode === 'signup') {
                        const name = document.getElementById('name').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const countryCode = document.getElementById('countryCode').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        
                        if (password !== confirmPassword) {
                            throw new Error('Les mots de passe ne correspondent pas');
                        }
                        
                        const fullPhone = countryCode + phone;
                        
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { name, phone: fullPhone }
                            }
                        });
                        
                        if (error) throw error;
                        
                        await supabase.from('profiles').upsert({
                            id: data.user.id,
                            name,
                            phone: fullPhone,
                            email,
                            role: 'referrer',
                            contract_status: 'pending'
                        }, { onConflict: 'id' });
                        
                        alert('‚úÖ Inscription r√©ussie ! Vous pouvez maintenant vous connecter.');
                        showLogin();
                        
                    } else if (mode === 'login') {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        async function handleReset() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const email = document.getElementById('email').value;
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    
                    if (error) throw error;
                    
                    alert('Email de r√©initialisation envoy√© !');
                    showLogin();
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        async function handleChangePassword() {
            const form = document.getElementById('authForm');
            const errorDiv = document.getElementById('authError');
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.classList.add('hidden');
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    const { error } = await supabase.auth.updateUser({ password: newPassword });
                    if (error) throw error;
                    
                    isPasswordRecoveryMode = false;
                    alert('‚úÖ Mot de passe chang√© avec succ√®s !');
                    await supabase.auth.signOut();
                    showLogin();
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            };
        }
        
        async function logout() {
            console.log('üö™ Logout called');
            supabase.auth.signOut();
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = window.location.origin;
        }
        
        async function loadUserProfile(user) {
            if (!user) return false;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .maybeSingle();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading profile:', error);
                    return false;
                }
                
                let profile = data;
                
                if (!profile) {
                    const { data: newProfile, error: insertError } = await supabase
                        .from('profiles')
                        .upsert([{
                            id: user.id,
                            name: user.user_metadata?.name || user.email.split('@')[0],
                            phone: user.user_metadata?.phone || '',
                            email: user.email,
                            role: 'referrer',
                            contract_status: 'pending'
                        }], { onConflict: 'id' })
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('Error creating profile:', insertError);
                        return false;
                    }
                    
                    profile = newProfile;
                }
                
                userProfile = profile;
                window.userProfile = profile;
                return true;
                
            } catch (err) {
                console.error('Exception loading profile:', err);
                return false;
            }
        }
        
        async function render() {
            console.log('üé® RENDER called');
            
            const app = document.getElementById('app');
            
            if (contractJustSigned && currentUser && userProfile) {
                contractJustSigned = false;
                window.contractJustSigned = false;
                
                setTimeout(() => {
                    const confirmationDiv = document.createElement('div');
                    confirmationDiv.innerHTML = `
                        <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">‚úÖ</span>
                                <div>
                                    <div class="font-bold">Contrat sign√© avec succ√®s !</div>
                                    <div class="text-sm">Vous pouvez maintenant ajouter des leads</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmationDiv);
                    setTimeout(() => confirmationDiv.remove(), 5000);
                }, 500);
            }
            
            if (isPasswordRecoveryMode && currentPage === 'change-password') {
                app.innerHTML = renderAuthPage('change-password');
                setTimeout(() => handleChangePassword(), 500);
                return;
            }
            
            if (currentUser && userProfile) {
                currentPage = 'dashboard';
                window.currentPage = 'dashboard';
                app.innerHTML = renderDashboard();
            } else if (currentPage === 'auth-login') {
                app.innerHTML = renderAuthPage('login');
                setTimeout(() => handleAuth('login'), 500);
            } else if (currentPage === 'auth-signup') {
                app.innerHTML = renderAuthPage('signup');
                setTimeout(() => handleAuth('signup'), 500);
            } else if (currentPage === 'auth-reset') {
                app.innerHTML = renderAuthPage('reset');
                setTimeout(() => handleReset(), 500);
            } else {
                app.innerHTML = renderLandingPage();
            }
        }
        
        // ============================================
        // üîÑ GESTION DES √âV√âNEMENTS AUTH
        // ============================================
        
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.showReset = showReset;
        window.logout = logout;
        window.backToHome = backToHome;
        
        document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-6xl">‚è≥</div></div>';
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('üîî Auth state changed:', event);
            
            if (event === 'PASSWORD_RECOVERY') {
                isPasswordRecoveryMode = true;
                currentPage = 'change-password';
                window.currentPage = 'change-password';
                currentUser = session?.user || null;
                window.currentUser = currentUser;
                render();
                return;
            }
            
            currentUser = session?.user || null;
            window.currentUser = currentUser;
            
            if (currentUser) {
                await loadUserProfile(currentUser);
            }
            
            render();
        });
        
        const { data: { session } } = await supabase.auth.getSession();
        currentUser = session?.user || null;
        window.currentUser = currentUser;
        
        if (currentUser) {
            await loadUserProfile(currentUser);
        }
        
        render();
        
    })();
    </script>
</body>
</html>
