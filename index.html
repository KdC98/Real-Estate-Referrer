<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karyne de Clercq - Programme Apporteurs Dubai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- intl-tel-input pour tÃ©lÃ©phone international -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    
    <!-- Version: 3.20.1 - Fix OAuth callback + tÃ©lÃ©phone padding -->
    
<style>
/* ============================================
   intl-tel-input - ThÃ¨me sombre Dubai v3.20.1
   FIX: Forcer padding-left Ã  95px
   ============================================ */

.iti { 
    width: 100% !important; 
    display: block !important;
}

/* âœ… v3.20.1: Forcer padding-left Ã  95px pour TOUS les inputs tel */
.iti input[type="tel"],
.iti input#phone,
.iti input#completionPhone,
.iti input#clientPhone,
.iti--separate-dial-code input[type="tel"] {
    width: 100% !important;
    box-sizing: border-box !important;
    padding: 0.75rem 1rem 0.75rem 95px !important;
    background: rgba(51, 65, 85, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem !important;
    color: white !important;
}

/* Variante pour signup */
.iti input#phone,
.iti--separate-dial-code input#phone {
    padding: 0.5rem 1rem 0.5rem 95px !important;
}

.iti input[type="tel"]:focus,
.iti input#phone:focus,
.iti input#completionPhone:focus,
.iti input#clientPhone:focus {
    border-color: #eab308 !important;
    box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.3) !important;
    outline: none !important;
}

.iti input[type="tel"]::placeholder { 
    color: rgba(191, 219, 254, 0.5) !important; 
}

.iti__flag-container {
    padding: 0 !important;
}

.iti__selected-flag {
    background: rgba(51, 65, 85, 0.8) !important;
    border-radius: 0.5rem 0 0 0.5rem !important;
    padding: 0 8px !important;
    height: 100% !important;
}

.iti__selected-flag:hover {
    background: rgba(51, 65, 85, 1) !important;
}

.iti__arrow { 
    border-top-color: white !important; 
}

.iti__arrow--up { 
    border-bottom-color: white !important; 
}

.iti__country-list {
    background: #1e293b !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem !important;
    max-height: 200px !important;
    overflow-y: auto !important;
    z-index: 9999 !important;
}

.iti__country {
    padding: 8px 12px !important;
    color: white !important;
}

.iti__country:hover {
    background: rgba(234, 179, 8, 0.2) !important;
}

.iti__country.iti__highlight {
    background: rgba(234, 179, 8, 0.3) !important;
}

.iti__dial-code { 
    color: #94a3b8 !important; 
}

.iti__country-name { 
    color: white !important; 
}

.iti__divider {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    margin: 4px 0 !important;
}

.iti--separate-dial-code .iti__selected-flag {
    background: rgba(51, 65, 85, 0.8) !important;
}

.iti--separate-dial-code .iti__selected-dial-code {
    color: white !important;
    margin-left: 6px !important;
}
</style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div id="app"></div>
    <div id="oauthWarningModal" class="hidden"></div>
    
    <script type="module">
        // ============================================
        // v3.20.1 - Fix OAuth callback + tÃ©lÃ©phone
        // ============================================
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './js/config.js';
        import * as VALIDATION from './js/validation.js';
        window.VALIDATION = VALIDATION;
        import * as UTILS from './js/utils.js';
        import * as AUTH from './js/auth.js';
        import * as DASHBOARD from './js/dashboard.js';
        import * as LEADS from './js/leads.js';
        import * as TFA from './js/2fa.js';
        import * as RENDERING from './js/rendering.js';

        (async () => {
            console.log('ğŸš€ App starting v3.20.1...');
            
            // DÃ©tecter les paramÃ¨tres URL
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = window.location.hash;
            
            // âœ… v3.20.1: DÃ©tection OAuth amÃ©liorÃ©e
            const hasCodeParam = urlParams.get('code') !== null;
            const hasHashToken = hashParams.includes('access_token');
            const hasError = hashParams.includes('error') || urlParams.get('error') !== null;
            const isOAuthReturn = hasCodeParam || hasHashToken;
            
            // Contract signed return
            const isContractSignedReturn = urlParams.get('signed') !== null;
            
            if (isContractSignedReturn && !isOAuthReturn) {
                console.log('ğŸ”„ Contract return detected, cleaning URL...');
                window.history.replaceState(null, '', window.location.pathname);
            }
            
            if (isOAuthReturn) {
                console.log('ğŸ”„ OAuth return detected - code:', hasCodeParam, 'hash:', hasHashToken);
            }
            
            if (hasError) {
                console.error('âŒ OAuth error detected in URL');
            }
            
            // Afficher loader pour OAuth
            if (isOAuthReturn && !hasError) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4 animate-spin">ğŸ”„</div>
                            <div class="text-xl text-blue-200">Connexion en cours...</div>
                            <div class="text-sm text-blue-300 mt-2">Veuillez patienter</div>
                        </div>
                    </div>
                `;
            }

            // Initialiser i18next
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'fr',
                    debug: false,
                    load: 'languageOnly',
                    ns: ['translation', 'auth', 'dashboard', 'common'],
                    defaultNS: 'translation',
                    backend: { loadPath: '/locales/{{lng}}/{{ns}}.json' },
                    detection: { order: ['localStorage', 'navigator'], caches: ['localStorage'] }
                });
            console.log('ğŸŒ Loading translations...');
            await i18next.loadNamespaces(['translation', 'auth', 'dashboard', 'common']);
            console.log('âœ… All translations loaded!');

            const t = (key) => i18next.t(key);

            async function changeLanguage(langCode) {
                try {
                    await i18next.changeLanguage(langCode);
                    localStorage.setItem('i18nextLng', langCode);
                    window.location.reload();
                } catch (error) {
                    console.error('Erreur changement de langue:', error);
                }
            }
            window.changeLanguage = changeLanguage;

            // âœ… v3.20.1: Client Supabase avec detectSessionInUrl dÃ©sactivÃ© pour contrÃ´le manuel
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: false,  // âœ… DÃ‰SACTIVÃ‰ - on gÃ¨re manuellement
                    flowType: 'pkce'
                }
            });
            
            window.supabase = supabase;
            window.SUPABASE_URL = SUPABASE_URL;
            window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

            // Traductions OAuth
            const oauthTranslations = {
                fr: { security_info: "Information de sÃ©curitÃ©", redirect_message: "Vous allez Ãªtre redirigÃ© vers notre service d'authentification sÃ©curisÃ© <strong>(Supabase)</strong> pour vous connecter avec", normal_secure: "C'est normal et sÃ©curisÃ©.", will_return: "Vous reviendrez automatiquement sur notre site aprÃ¨s connexion.", continue_btn: "Continuer", cancel_btn: "Annuler" },
                en: { security_info: "Security Information", redirect_message: "You will be redirected to our secure authentication service <strong>(Supabase)</strong> to sign in with", normal_secure: "This is normal and secure.", will_return: "You will automatically return to our site after signing in.", continue_btn: "Continue", cancel_btn: "Cancel" },
                ar: { security_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†", redirect_message: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© <strong>(Supabase)</strong> Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…", normal_secure: "Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ¢Ù…Ù†.", will_return: "Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", continue_btn: "Ù…ØªØ§Ø¨Ø¹Ø©", cancel_btn: "Ø¥Ù„ØºØ§Ø¡" },
                ru: { security_info: "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸", redirect_message: "Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° Ğ½Ğ°ÑˆÑƒ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½ÑƒÑ ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ <strong>(Supabase)</strong> Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ·", normal_secure: "Ğ­Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.", will_return: "Ğ’Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²ĞµÑ€Ğ½ĞµÑ‚ĞµÑÑŒ Ğ½Ğ° Ğ½Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°.", continue_btn: "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ", cancel_btn: "ĞÑ‚Ğ¼ĞµĞ½Ğ°" },
                hi: { security_info: "à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€", redirect_message: "à¤†à¤ªà¤•à¥‹ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤ªà¥à¤°à¤®à¤¾à¤£à¥€à¤•à¤°à¤£ à¤¸à¥‡à¤µà¤¾ <strong>(Supabase)</strong> à¤ªà¤° à¤ªà¥à¤¨à¤°à¥à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾à¤à¤—à¤¾", normal_secure: "à¤¯à¤¹ à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤”à¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆà¥¤", will_return: "à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤†à¤ª à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¤¾à¤‡à¤Ÿ à¤ªà¤° à¤²à¥Œà¤Ÿ à¤†à¤à¤‚à¤—à¥‡à¥¤", continue_btn: "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚", cancel_btn: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚" },
                ur: { security_info: "Ø³ÛŒÚ©ÛŒÙˆØ±Ù¹ÛŒ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", redirect_message: "Ø¢Ù¾ Ú©Ùˆ ÛÙ…Ø§Ø±ÛŒ Ù…Ø­ÙÙˆØ¸ ØªØµØ¯ÛŒÙ‚ Ø®Ø¯Ù…Øª <strong>(Supabase)</strong> Ù¾Ø± Ø¨Ú¾ÛŒØ¬Ø§ Ø¬Ø§Ø¦Û’ Ú¯Ø§", normal_secure: "ÛŒÛ Ù†Ø§Ø±Ù…Ù„ Ø§ÙˆØ± Ù…Ø­ÙÙˆØ¸ ÛÛ’Û”", will_return: "Ø³Ø§Ø¦Ù† Ø§Ù† Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ø®ÙˆØ¯ Ø¨Ø®ÙˆØ¯ ÛÙ…Ø§Ø±ÛŒ Ø³Ø§Ø¦Ù¹ Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¢ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”", continue_btn: "Ø¬Ø§Ø±ÛŒ Ø±Ú©Ú¾ÛŒÚº", cancel_btn: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº" },
                zh: { security_info: "å®‰å…¨ä¿¡æ¯", redirect_message: "æ‚¨å°†è¢«é‡å®šå‘åˆ°æˆ‘ä»¬çš„å®‰å…¨è®¤è¯æœåŠ¡<strong>(Supabase)</strong>ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å½•", normal_secure: "è¿™æ˜¯æ­£å¸¸ä¸”å®‰å…¨çš„ã€‚", will_return: "ç™»å½•åæ‚¨å°†è‡ªåŠ¨è¿”å›æˆ‘ä»¬çš„ç½‘ç«™ã€‚", continue_btn: "ç»§ç»­", cancel_btn: "å–æ¶ˆ" },
                tl: { security_info: "Impormasyon sa Seguridad", redirect_message: "Ire-redirect ka sa aming secure authentication service <strong>(Supabase)</strong> para mag-sign in gamit ang", normal_secure: "Ito ay normal at secure.", will_return: "Awtomatikong babalik ka sa aming site pagkatapos mag-sign in.", continue_btn: "Magpatuloy", cancel_btn: "Kanselahin" }
            };

            // Variables d'Ã©tat
            let currentUser = null;
            let userProfile = null;
            let profileLoadAttempts = 0;
            const MAX_PROFILE_LOAD_ATTEMPTS = 10;
            let currentPage = 'landing';
            let isPasswordRecoveryMode = false;
            let is2FAMode = false;
            let isSignupInProgress = false;
            let tempPhone = null;
            let pendingSignupId = null;
            let globalIsUploading = false;
            let contractJustSigned = isContractSignedReturn;
            let isRendering = false;
            let lastAuthEvent = null;
            let initialLoadComplete = false;
            let oauthInProgress = isOAuthReturn;
            let phoneInputInstances = {};

            // Exposer les variables globales
            window.currentUser = null;
            window.userProfile = null;
            window.currentPage = 'landing';
            window.contractJustSigned = contractJustSigned;
            window.tempPhone = null;
            window.pendingSignupId = null;

            window.setCurrentPage = (p) => { currentPage = p; window.currentPage = p; };
            window.setIs2FAMode = (v) => { is2FAMode = v; window.is2FAMode = v; };
            window.setTempPhone = (p) => { tempPhone = p; window.tempPhone = p; };
            window.setPendingSignupId = (id) => { pendingSignupId = id; window.pendingSignupId = id; };

            // VÃ©rifier les paramÃ¨tres URL pour signup
            const searchParams = new URLSearchParams(window.location.search);
            if (searchParams.get('action') === 'signup') {
                currentPage = 'auth-signup';
                window.currentPage = 'auth-signup';
            }

            // Helpers timing
            function wait2Frames() {
                return new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));
            }
            
            function waitFonts() {
                return document.fonts?.ready || Promise.resolve();
            }
            
            // Phone input functions
            function initPhoneInput(inputId, initialNumber = '') {
                const input = document.getElementById(inputId);
                if (!input) return null;
                
                if (phoneInputInstances[inputId]) {
                    phoneInputInstances[inputId].destroy();
                    delete phoneInputInstances[inputId];
                }
                
                const iti = window.intlTelInput(input, {
                    initialCountry: "ae",
                    preferredCountries: ["ae", "in", "pk", "ph", "gb", "fr", "ru", "cn", "sa", "eg", "us", "ca", "de", "lb", "jo"],
                    separateDialCode: true,
                    nationalMode: false,
                    autoPlaceholder: "polite",
                    formatOnDisplay: true,
                    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
                });
                
                phoneInputInstances[inputId] = iti;
                if (initialNumber) iti.setNumber(initialNumber);
                return iti;
            }
            window.initPhoneInput = initPhoneInput;

            async function initPhoneInputForModal(inputId, initialNumber = '') {
                console.log('ğŸ“± initPhoneInputForModal for:', inputId);
                const input = document.getElementById(inputId);
                if (!input) return null;
                
                if (phoneInputInstances[inputId]) {
                    phoneInputInstances[inputId].destroy();
                    delete phoneInputInstances[inputId];
                }
                
                const iti = window.intlTelInput(input, {
                    initialCountry: "ae",
                    preferredCountries: ["ae", "in", "pk", "ph", "gb", "fr", "ru", "cn", "sa", "eg", "us", "ca", "de", "lb", "jo"],
                    separateDialCode: true,
                    nationalMode: false,
                    autoPlaceholder: "polite",
                    formatOnDisplay: true,
                    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
                });
                
                phoneInputInstances[inputId] = iti;
                if (initialNumber) iti.setNumber(initialNumber);
                
                if (iti.promise) await iti.promise;
                await wait2Frames();
                await waitFonts();
                
                const forceRecalc = () => {
                    const iso2 = iti.getSelectedCountryData().iso2;
                    iti.setCountry(iso2);
                    window.dispatchEvent(new Event("resize"));
                };
                forceRecalc();
                await new Promise(r => setTimeout(r, 50));
                forceRecalc();
                
                return iti;
            }
            window.initPhoneInputForModal = initPhoneInputForModal;

            function getFullPhoneNumber(inputId) {
                const iti = phoneInputInstances[inputId];
                return iti ? iti.getNumber() : (document.getElementById(inputId)?.value || '');
            }
            window.getFullPhoneNumber = getFullPhoneNumber;

            // Auth handlers
            function handleAuth(mode) {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                if (errorDiv) { errorDiv.textContent = ''; errorDiv.classList.add('hidden'); }
                if (!form) return;

                if (mode === 'signup') {
                    setTimeout(() => initPhoneInput('phone'), 100);
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password')?.value;

                    try {
                        if (mode === 'signup') {
                            const name = document.getElementById('name').value.trim();
                            const fullPhone = getFullPhoneNumber('phone');
                            const confirmPassword = document.getElementById('confirmPassword').value;

                            if (!VALIDATION.validateName(name)) throw new Error('Nom invalide');
                            if (!VALIDATION.validatePhone(fullPhone)) throw new Error('NumÃ©ro de tÃ©lÃ©phone invalide');
                            if (!VALIDATION.validateEmail(email)) throw new Error('Email invalide');
                            if (!VALIDATION.validatePassword(password)) throw new Error('Mot de passe invalide');
                            if (password !== confirmPassword) throw new Error(t('auth:password_mismatch'));

                            const phoneCheck = await TFA.checkPhoneExists(fullPhone);
                            if (phoneCheck.exists) {
                                errorDiv.textContent = 'Ce numÃ©ro de tÃ©lÃ©phone est dÃ©jÃ  utilisÃ©';
                                errorDiv.classList.remove('hidden');
                                return;
                            }

                            const submitButton = document.getElementById('submitButton');
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-gray-900 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Envoi du code SMS...';

                            isSignupInProgress = true;
                            const currentLang = i18next.language || 'fr';
                            const emailOptIn = document.getElementById('emailOptIn')?.checked || false;
                            const pendingSignupData = { email, password, name, phone: fullPhone, email_opt_in: emailOptIn };

                            const smsResult = await TFA.send2FACode(fullPhone, currentLang, pendingSignupData);
                            if (!smsResult.success) throw new Error('Erreur lors de l\'envoi du SMS');

                            tempPhone = fullPhone;
                            window.tempPhone = fullPhone;
                            is2FAMode = true;
                            window.is2FAMode = true;
                            isSignupInProgress = false;
                            render();
                        } else if (mode === 'login') {
                            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                        }
                    } catch (error) {
                        console.error('âŒ Auth error:', error);
                        let errorMessage = error.message;
                        if (error.message.includes('Invalid login credentials')) errorMessage = 'Email ou mot de passe incorrect';
                        else if (error.message.includes('Email not confirmed')) errorMessage = 'Veuillez confirmer votre email';
                        else if (error.message.includes('User already registered')) errorMessage = 'Cet email est dÃ©jÃ  utilisÃ©';
                        errorDiv.textContent = errorMessage;
                        errorDiv.classList.remove('hidden');
                        if (mode === 'signup') {
                            const submitButton = document.getElementById('submitButton');
                            submitButton.disabled = false;
                            submitButton.textContent = t('auth:signup_button');
                        }
                    }
                };
            }

            async function handleReset() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');
                    const email = document.getElementById('email').value;
                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
                        if (error) throw error;
                        alert(t('auth:reset_email_sent'));
                        UTILS.showLogin();
                    } catch (error) {
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                    }
                };
            }

            function showOAuthWarning(provider) {
                const modal = document.getElementById('oauthWarningModal');
                const providerName = provider === 'google' ? 'Google' : 'Apple';
                const currentLang = i18next.language?.split('-')[0] || 'fr';
                const trans = oauthTranslations[currentLang] || oauthTranslations.fr;
                
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md w-full border border-yellow-500/50">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-4">âš ï¸</div>
                                <h3 class="text-2xl font-bold mb-4 text-yellow-400">${trans.security_info}</h3>
                            </div>
                            <p class="text-blue-200 mb-6 leading-relaxed">${trans.redirect_message} ${providerName}.</p>
                            <p class="text-blue-200 mb-6"><span class="text-green-400 font-semibold">âœ“ ${trans.normal_secure}</span><br>${trans.will_return}</p>
                            <div class="flex gap-4">
                                <button onclick="proceedWithOAuth('${provider}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">${trans.continue_btn}</button>
                                <button onclick="closeOAuthWarning()" class="flex-1 bg-white/20 hover:bg-white/30 text-white font-bold py-3 rounded-lg transition border border-white/20">${trans.cancel_btn}</button>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
            }

            function closeOAuthWarning() {
                const modal = document.getElementById('oauthWarningModal');
                modal.classList.add('hidden');
                modal.innerHTML = '';
            }

            async function proceedWithOAuth(provider) {
                closeOAuthWarning();
                try {
                    console.log('ğŸ” Starting ' + provider + ' Sign In...');
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: provider,
                        options: { redirectTo: window.location.origin, skipBrowserRedirect: false }
                    });
                    if (error) throw error;
                } catch (error) {
                    console.error('âŒ OAuth error:', error);
                    alert('Erreur: ' + error.message);
                }
            }

            async function signInWithGoogle() { showOAuthWarning('google'); }
            async function signInWithApple() { showOAuthWarning('apple'); }

            async function handleChangePassword() {
                const form = document.getElementById('authForm');
                const errorDiv = document.getElementById('authError');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    errorDiv.classList.add('hidden');
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmNewPassword').value;
                    if (newPassword !== confirmPassword) { errorDiv.textContent = 'Les mots de passe ne correspondent pas'; errorDiv.classList.remove('hidden'); return; }
                    if (newPassword.length < 8) { errorDiv.textContent = 'Minimum 8 caractÃ¨res'; errorDiv.classList.remove('hidden'); return; }
                    try {
                        const { error } = await supabase.auth.updateUser({ password: newPassword });
                        if (error) throw error;
                        isPasswordRecoveryMode = false;
                        alert('âœ… Mot de passe changÃ© !');
                        await supabase.auth.signOut();
                        UTILS.showLogin();
                    } catch (error) {
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                    }
                };
            }

            // Load user profile
            async function loadUserProfile(user = null) {
                const targetUser = user || currentUser;
                console.log('ğŸ” loadUserProfile for:', targetUser?.id);
                if (!targetUser?.id) return false;

                try {
                    const { data, error } = await supabase.from('profiles').select('*').eq('id', targetUser.id).maybeSingle();
                    
                    if (error && error.code !== 'PGRST116') {
                        console.error('âŒ Profile error:', error);
                        userProfile = { id: targetUser.id, name: targetUser.user_metadata?.full_name || targetUser.email?.split('@')[0] || 'User', email: targetUser.email, role: 'referrer', contract_status: 'pending' };
                        window.userProfile = userProfile;
                        return true;
                    }

                    let profile = data;
                    if (!profile) {
                        console.log('ğŸ“ Creating profile...');
                        const userName = targetUser.user_metadata?.full_name || targetUser.user_metadata?.name || targetUser.email?.split('@')[0] || '';
                        const { data: newProfile, error: insertError } = await supabase.from('profiles').upsert([{
                            id: targetUser.id, name: userName, phone: targetUser.user_metadata?.phone || '',
                            email: targetUser.email, role: 'referrer', contract_status: 'pending', phone_verified: false
                        }], { onConflict: 'id' }).select().single();
                        
                        if (insertError) {
                            userProfile = { id: targetUser.id, name: userName, email: targetUser.email, role: 'referrer', contract_status: 'pending' };
                            window.userProfile = userProfile;
                            return true;
                        }
                        profile = newProfile;
                    }

                    if (profile?.contract_status) {
                        profile.contract_status = profile.contract_status.trim().replace(/\*+/g, '');
                    }
                    userProfile = profile;
                    window.userProfile = profile;
                    console.log('âœ… Profile loaded:', profile.name);
                    return true;
                } catch (err) {
                    console.error('âŒ Exception:', err);
                    userProfile = { id: targetUser.id, name: targetUser.user_metadata?.full_name || 'User', email: targetUser.email, role: 'referrer', contract_status: 'pending' };
                    window.userProfile = userProfile;
                    return true;
                }
            }
            window.loadUserProfile = loadUserProfile;

            // Logout
            async function logout() {
                console.log('ğŸšª Logout');
                try { await supabase.auth.signOut(); } catch(e) {}
                try { localStorage.clear(); sessionStorage.clear(); } catch(e) {}
                currentUser = null; userProfile = null; currentPage = 'landing';
                isPasswordRecoveryMode = false; is2FAMode = false; tempPhone = null; pendingSignupId = null;
                window.currentUser = null; window.userProfile = null; window.currentPage = 'landing';
                setTimeout(() => { window.location.href = window.location.origin; }, 100);
            }
            window.logout = logout;

            // Render function
            async function render() {
                if (isRendering) return;
                isRendering = true;
                console.log('ğŸ¨ RENDER - user:', !!currentUser, 'profile:', !!userProfile, 'page:', currentPage);

                if (contractJustSigned && currentUser && userProfile) {
                    contractJustSigned = false;
                    window.contractJustSigned = false;
                    await loadUserProfile(currentUser);
                    setTimeout(() => {
                        const div = document.createElement('div');
                        div.innerHTML = `<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-bounce"><div class="flex items-center gap-3"><span class="text-3xl">âœ…</span><div><div class="font-bold">Contrat signÃ© !</div></div></div></div>`;
                        document.body.appendChild(div);
                        setTimeout(() => div.remove(), 5000);
                    }, 500);
                }

                const app = document.getElementById('app');

                if (is2FAMode) {
                    app.innerHTML = RENDERING.renderAuthPage('2fa');
                    const form2FA = document.getElementById('form2FA');
                    if (form2FA) form2FA.onsubmit = TFA.handle2FASubmit;
                    document.getElementById('code2fa')?.focus();
                    isRendering = false;
                    return;
                }

                if (isPasswordRecoveryMode && currentPage === 'change-password') {
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);
                    isRendering = false;
                    return;
                }

                if (currentUser && userProfile) {
                    const isComplete = RENDERING.isProfileComplete(userProfile);
                    
                    if (!isComplete && userProfile.role !== 'admin') {
                        currentPage = 'profile-completion';
                        window.currentPage = 'profile-completion';
                        app.innerHTML = RENDERING.renderDashboard() + RENDERING.renderProfileCompletionModal();
                        
                        setTimeout(async () => {
                            const iti = await initPhoneInputForModal('completionPhone', userProfile.phone || '');
                            if (iti) console.log('ğŸ“± âœ… Phone ready');
                        }, 100);
                        
                        setTimeout(() => {
                            const form = document.getElementById('profileCompletionForm');
                            if (form) {
                                form.onsubmit = async (e) => {
                                    e.preventDefault();
                                    const submitBtn = document.getElementById('completionSubmitBtn');
                                    const errorDiv = document.getElementById('completionError');
                                    submitBtn.disabled = true;
                                    submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 inline-block mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Enregistrement...';
                                    errorDiv.classList.add('hidden');
                                    
                                    try {
                                        const name = document.getElementById('completionName')?.value?.trim() || '';
                                        const email = document.getElementById('completionEmail')?.value?.trim() || '';
                                        const fullPhone = getFullPhoneNumber('completionPhone');
                                        const address = document.getElementById('completionAddress')?.value?.trim() || '';
                                        const area = document.getElementById('completionArea')?.value?.trim() || '';
                                        const emirate = document.getElementById('completionEmirate')?.value || '';
                                        
                                        if (!name || name.length < 2) throw new Error('Nom requis (min 2 car.)');
                                        if (!email || !email.includes('@')) throw new Error('Email invalide');
                                        if (email.includes('@privaterelay.appleid.com')) throw new Error('Entrez votre vraie adresse email');
                                        if (!fullPhone || fullPhone.length < 8) throw new Error('TÃ©lÃ©phone invalide');
                                        if (!address || address.length < 3) throw new Error('Adresse requise');
                                        if (!emirate) throw new Error('Ã‰mirat requis');
                                        
                                        const fullAddress = area ? `${address}, ${area}, ${emirate}` : `${address}, ${emirate}`;
                                        
                                        const { error } = await supabase.from('profiles').update({ name, email, phone: fullPhone, address: fullAddress }).eq('id', currentUser.id);
                                        if (error) throw error;
                                        
                                        await loadUserProfile(currentUser);
                                        document.getElementById('profileCompletionModal')?.remove();
                                        currentPage = 'dashboard';
                                        window.currentPage = 'dashboard';
                                        
                                        const success = document.createElement('div');
                                        success.innerHTML = `<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50"><div class="flex items-center gap-3"><span class="text-3xl">âœ…</span><div class="font-bold">Profil complÃ©tÃ© !</div></div></div>`;
                                        document.body.appendChild(success);
                                        setTimeout(() => success.remove(), 4000);
                                        
                                        isRendering = false;
                                        render();
                                    } catch (err) {
                                        errorDiv.textContent = err.message;
                                        errorDiv.classList.remove('hidden');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = 'Enregistrer et continuer â†’';
                                    }
                                };
                            }
                        }, 150);
                        
                        isRendering = false;
                        return;
                    }
                    
                    currentPage = 'dashboard';
                    window.currentPage = 'dashboard';
                    app.innerHTML = RENDERING.renderDashboard();
                    await DASHBOARD.loadDashboardContent();
                    isRendering = false;
                    return;

                } else if (currentUser && !userProfile) {
                    profileLoadAttempts++;
                    if (profileLoadAttempts >= MAX_PROFILE_LOAD_ATTEMPTS) {
                        profileLoadAttempts = 0;
                        await supabase.auth.signOut();
                        currentUser = null;
                        window.currentUser = null;
                        currentPage = 'landing';
                        isRendering = false;
                        render();
                        return;
                    }
                    app.innerHTML = `<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-6xl mb-4">â³</div><div class="text-xl text-blue-200">Chargement... (${profileLoadAttempts}/${MAX_PROFILE_LOAD_ATTEMPTS})</div></div></div>`;
                    isRendering = false;
                    setTimeout(() => loadUserProfile().then(() => render()), profileLoadAttempts * 1000);
                    return;

                } else if (currentPage === 'auth-login') {
                    app.innerHTML = RENDERING.renderAuthPage('login');
                    setTimeout(() => handleAuth('login'), 500);
                } else if (currentPage === 'auth-signup') {
                    app.innerHTML = RENDERING.renderAuthPage('signup');
                    setTimeout(() => { handleAuth('signup'); VALIDATION.attachPasswordValidation?.(); }, 500);
                } else if (currentPage === 'auth-reset') {
                    app.innerHTML = RENDERING.renderAuthPage('reset');
                    setTimeout(() => handleReset(), 500);
                } else if (currentPage === 'change-password') {
                    app.innerHTML = RENDERING.renderAuthPage('change-password');
                    setTimeout(() => handleChangePassword(), 500);
                } else {
                    app.innerHTML = RENDERING.renderLandingPage();
                }

                isRendering = false;
            }

            // Expose functions
            window.showAddLeadForm = LEADS.showAddLeadForm;
            window.closeAddLeadModal = LEADS.closeAddLeadModal;
            window.addLead = LEADS.addLead;
            window.updateLeadStatus = LEADS.updateLeadStatus;
            window.markAsSold = LEADS.markAsSold;
            window.renderAddLeadModal = LEADS.renderAddLeadModal;
            window.togglePasswordVisibility = VALIDATION.togglePasswordVisibility;
            window.validateName = VALIDATION.validateName;
            window.validatePhone = VALIDATION.validatePhone;
            window.validateEmail = VALIDATION.validateEmail;
            window.validatePassword = VALIDATION.validatePassword;
            window.validateConfirmPassword = VALIDATION.validateConfirmPassword;
            window.checkFormValidity = VALIDATION.checkFormValidity;
            window.prefillTestData = UTILS.prefillTestData;
            window.render = render;
            window.loadDashboardContent = DASHBOARD.loadDashboardContent;
            window.handleChangePassword = handleChangePassword;
            window.downloadContractTemplate = UTILS.downloadContractTemplate;
            window.checkPhoneExists = TFA.checkPhoneExists;
            window.handle2FASubmit = TFA.handle2FASubmit;
            window.resend2FACode = TFA.resend2FACode;
            window.signInWithGoogle = signInWithGoogle;
            window.signInWithApple = signInWithApple;
            window.showOAuthWarning = showOAuthWarning;
            window.closeOAuthWarning = closeOAuthWarning;
            window.proceedWithOAuth = proceedWithOAuth;
            window.toggleMobileMenu = UTILS.toggleMobileMenu;
            window.showLogin = UTILS.showLogin;
            window.showSignup = UTILS.showSignup;
            window.showReset = UTILS.showReset;
            window.backToHome = UTILS.backToHome;
            window.backTo2FASignup = function() {
                is2FAMode = false; window.is2FAMode = false;
                tempPhone = null; window.tempPhone = null;
                pendingSignupId = null; window.pendingSignupId = null;
                currentPage = 'auth-signup'; window.currentPage = 'auth-signup';
                render();
            };
            window.renderLandingPage = RENDERING.renderLandingPage;
            window.renderAuthPage = RENDERING.renderAuthPage;
            window.renderDashboard = RENDERING.renderDashboard;
            window.logout = logout;

            // ============================================
            // âœ… v3.20.1: AUTH STATE CHANGE HANDLER
            // ============================================
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('ğŸ”” Auth state changed:', event, session ? 'for ' + session.user?.email : 'no session');

                if (isSignupInProgress && event !== 'SIGNED_IN') return;
                if (event === lastAuthEvent && event === 'TOKEN_REFRESHED') return;
                lastAuthEvent = event;

                if (event === 'PASSWORD_RECOVERY') {
                    isPasswordRecoveryMode = true;
                    currentPage = 'change-password';
                    window.currentPage = 'change-password';
                    currentUser = session?.user || null;
                    window.currentUser = currentUser;
                    render();
                    return;
                }

                if (isPasswordRecoveryMode && event !== 'PASSWORD_RECOVERY') return;

                currentUser = session?.user || null;
                window.currentUser = currentUser;

                if (currentUser) {
                    console.log('ğŸ‘¤ User authenticated:', currentUser.email);
                    await loadUserProfile(currentUser);
                    
                    // âœ… v3.20.1: Nettoyer l'URL aprÃ¨s OAuth
                    if (oauthInProgress) {
                        console.log('âœ… OAuth complete, cleaning URL');
                        window.history.replaceState(null, '', window.location.pathname);
                        oauthInProgress = false;
                    }
                }

                initialLoadComplete = true;
                render();
            });

            // ============================================
            // âœ… v3.20.1: INITIALISATION - GESTION OAUTH MANUELLE
            // ============================================
            async function initializeApp() {
                console.log('ğŸ”§ initializeApp - OAuth return:', isOAuthReturn);
                
                // GÃ©rer erreur OAuth
                if (hasError) {
                    document.getElementById('app').innerHTML = `
                        <div class="min-h-screen flex items-center justify-center px-4">
                            <div class="bg-red-500/20 border border-red-500 rounded-2xl p-8 max-w-md text-center">
                                <div class="text-6xl mb-4">âŒ</div>
                                <h2 class="text-2xl font-bold text-red-400 mb-4">Erreur de connexion</h2>
                                <p class="text-blue-200 mb-6">La connexion a Ã©chouÃ©.</p>
                                <button onclick="window.location.href='/'" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-lg">Retour</button>
                            </div>
                        </div>
                    `;
                    window.history.replaceState(null, '', window.location.pathname);
                    return;
                }
                
                // âœ… v3.20.1: Si retour OAuth avec code, Ã©changer manuellement
                if (hasCodeParam) {
                    console.log('ğŸ”„ OAuth code detected, exchanging...');
                    try {
                        const { data, error } = await supabase.auth.exchangeCodeForSession(urlParams.get('code'));
                        if (error) {
                            console.error('âŒ Code exchange error:', error);
                            // L'erreur "Invalid data" peut arriver si le code a dÃ©jÃ  Ã©tÃ© utilisÃ©
                            // On essaie de rÃ©cupÃ©rer la session existante
                            const { data: sessionData } = await supabase.auth.getSession();
                            if (sessionData?.session) {
                                console.log('âœ… Found existing session');
                                currentUser = sessionData.session.user;
                                window.currentUser = currentUser;
                                await loadUserProfile(currentUser);
                                window.history.replaceState(null, '', window.location.pathname);
                                oauthInProgress = false;
                                initialLoadComplete = true;
                                render();
                                return;
                            }
                        } else if (data?.session) {
                            console.log('âœ… Code exchanged successfully');
                            currentUser = data.session.user;
                            window.currentUser = currentUser;
                            await loadUserProfile(currentUser);
                            window.history.replaceState(null, '', window.location.pathname);
                            oauthInProgress = false;
                            initialLoadComplete = true;
                            render();
                            return;
                        }
                    } catch (err) {
                        console.error('âŒ Exchange exception:', err);
                    }
                    
                    // Fallback: essayer getSession
                    const { data: sessionData } = await supabase.auth.getSession();
                    if (sessionData?.session) {
                        currentUser = sessionData.session.user;
                        window.currentUser = currentUser;
                        await loadUserProfile(currentUser);
                        window.history.replaceState(null, '', window.location.pathname);
                        oauthInProgress = false;
                    }
                    initialLoadComplete = true;
                    render();
                    return;
                }
                
                // Pas de retour OAuth - charger session normale
                console.log('ğŸ” Getting existing session...');
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    currentUser = session?.user || null;
                    window.currentUser = currentUser;
                    if (currentUser) {
                        await loadUserProfile(currentUser);
                    }
                } catch (err) {
                    console.error('âŒ Session error:', err);
                }

                initialLoadComplete = true;
                render();
            }
            
            await initializeApp();

        })();
    </script>
    <script src="./js/crisp-chat.js"></script>
</body>
</html>
